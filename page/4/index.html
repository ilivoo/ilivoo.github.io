<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Ilivoo`s blog" type="application/atom+xml" />






<meta name="description" content="我，在這裡，享受等你的時光。">
<meta property="og:type" content="website">
<meta property="og:title" content="Ilivoo`s blog">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Ilivoo`s blog">
<meta property="og:description" content="我，在這裡，享受等你的時光。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ilivoo`s blog">
<meta name="twitter:description" content="我，在這裡，享受等你的時光。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>Ilivoo`s blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ilivoo`s blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/mysql-exist-in/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/mysql-exist-in/" itemprop="url">mysql exists与in的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T20:08:08+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,249
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h4><ul>
<li><p>exists对外表用loop逐条查询，每次查询都会查看exists的条件语句，当 exists里的条件语句能够返回记录行时(无论记录行是的多少，只要能返回)，条件就为真，返回当前loop到的这条记录，反之如果exists里的条 件语句不能返回记录行，则当前loop到的这条记录被丢弃，exists的条件就像一个bool条件，当能返回结果集则为true，不能返回结果集则为 false，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where exists (select 1);</span><br></pre></td></tr></table></figure>
<p>对user表的记录逐条取出，由于子条件中的select 1永远能返回记录行，那么user表的所有记录都将被加入结果集，所以与 select * from user;是一样的，又如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where exists (select * from user where userId = 0);</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ul>
<li><p>可以知道对user表进行loop时，检查条件语句(select * from user where userId = 0),由于userId永远不为0，所以条件语句永远返回空集，条件永远为false，那么user表的所有记录都将被丢弃</p>
</li>
<li><p>not exists与exists相反，也就是当exists条件有结果集返回时，loop到的记录将被丢弃，否则将loop到的记录加入结果集</p>
</li>
<li><p>总的来说，如果A表有n条记录，那么exists查询就是将这n条记录逐条取出，然后判断n遍exists条件 </p>
</li>
</ul>
</li>
</ul>
<h4 id="in"><a href="#in" class="headerlink" title="in"></a>in</h4><ul>
<li><p>in查询相当于多个or条件的叠加，这个比较好理解，比如下面的查询</p>
<p>select * from user where userId in (1, 2, 3);</p>
<p>等效于</p>
<p>select * from user where userId = 1 or userId = 2 or userId = 3;</p>
</li>
<li><p>not in与in相反，如下</p>
<p>select * from user where userId not in (1, 2, 3);</p>
<p>等效于</p>
<p>select * from user where userId != 1 and userId != 2 and userId != 3;</p>
</li>
<li><p>总的来说，in查询就是先将子查询条件的记录全都查出来，假设结果集为B，共有m条记录，然后在将子查询条件的结果集分解成m个，再进行m次查询</p>
</li>
</ul>
<ul>
<li><p>值得一提的是，in查询的子条件返回结果必须只有一个字段，例如</p>
<p>select * from user where userId in (select id from B);</p>
<p>而不能是</p>
<p>select * from user where userId in (select id, age from B);</p>
<p>而exists就没有这个限制</p>
</li>
</ul>
<h4 id="exists和in的性能"><a href="#exists和in的性能" class="headerlink" title="exists和in的性能"></a>exists和in的性能</h4><ul>
<li><p>考虑如下SQL语句</p>
<p>1: select <em> from A where exists (select </em> from B where B.id = A.id);</p>
<p>2: select * from A where A.id in (select id from B);</p>
<p>查询1.可以转化以下伪代码，便于理解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for ($i = 0; $i &lt; count(A); $i++) &#123;</span><br><span class="line">　　$a = get_record(A, $i); #从A表逐条获取记录</span><br><span class="line">　　if (B.id = $a[id]) #如果子条件成立</span><br><span class="line">　　　　$result[] = $a;</span><br><span class="line">&#125;</span><br><span class="line">return $result;</span><br></pre></td></tr></table></figure>
<p>大概就是这么个意思，其实可以看到,查询1主要是用到了B表的索引，A表如何对查询的效率影响应该不大</p>
<p>假设B表的所有id为1,2,3,查询2可以转换为</p>
<p>select * from A where A.id = 1 or A.id = 2 or A.id = 3;</p>
<p>这个好理解了，这里主要是用到了A的索引，B表如何对查询影响不大</p>
</li>
</ul>
<ul>
<li><p>再看not exists 和 not in</p>
<p>1: select <em> from A where not exists (select </em> from B where B.id = A.id);</p>
<p>2: select * from A where A.id not in (select id from B);</p>
<p>看查询1，还是和上面一样，用了B的索引, 而对于查询2，可以转化成如下语句</p>
<p>select * from A where A.id != 1 and A.id != 2 and A.id != 3;</p>
<p>可以知道not in是个范围查询，这种!=的范围查询无法使用任何索引,等于说A表的每条记录，都要在B表里遍历一次，查看B表里是否存在这条记录故not exists比not in效率高 </p>
</li>
<li><p>mysql中的in语句是把外表和内表作hash 连接，而exists语句是对外表作loop循环，每次loop循环再对内表进行查询。一直大家都认为exists比in语句的效率要高，这种说法其实是不准确的。这个是要区分环境的。</p>
</li>
</ul>
<ul>
<li><p>如果查询的两个表大小相当，那么用in和exists差别不大。 </p>
<p>如果两个表中一个较小，一个是大表，则子查询表大的用exists，子查询表小的用in： </p>
<p>例如：表A（小表），表B（大表）</p>
<p>1: select * from A where cc in (select cc from B) 效率低，用到了A表上cc列的索引；</p>
<p> select * from A where exists(select cc from B where cc=A.cc) 效率高，用到了B表上cc列的索引。 </p>
<p>相反的</p>
<p>2: select * from B where cc in (select cc from A) 效率高，用到了B表上cc列的索引；</p>
</li>
</ul>
<p>​    select * from B where exists(select cc from A where cc=B.cc) 效率低，用到了A表上cc列的索引。</p>
<h4 id="not-in-和not-exists"><a href="#not-in-和not-exists" class="headerlink" title="not in 和not exists"></a>not in 和not exists</h4><ul>
<li><p>如果查询语句使用了not in 那么内外表都进行全表扫描，没有用到索引；而not extsts 的子查询依然能用到表上的索引。所以无论那个表大，用not exists都比not in要快。 </p>
</li>
<li><p>in 与 =的区别 </p>
<p>select name from student where name in (‘zhang’,’wang’,’li’,’zhao’); </p>
<p>与 </p>
<p>select name from student where name=’zhang’ or name=’li’ or name=’wang’ or name=’zhao’ </p>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/mysql-select/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/mysql-select/" itemprop="url">mysql 查询顺序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T18:54:27+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,178
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="笛卡尔乘积"><a href="#笛卡尔乘积" class="headerlink" title="笛卡尔乘积"></a>笛卡尔乘积</h4><ul>
<li>使用join执行笛卡尔乘积， 并且使用on来对笛卡尔乘积之前进行过滤操作, 这也称作显示的连接操作</li>
<li>使用from连接多个表执行笛卡尔乘积， 并且使用where进行过滤， 但是由于先执行笛卡尔乘积再过滤， 所以有效率问题， 这也称作隐式的连接操作</li>
</ul>
<h4 id="定义变化的表"><a href="#定义变化的表" class="headerlink" title="定义变化的表"></a>定义变化的表</h4><ul>
<li>可以使用(select @rank := 0) as ranker 来定义一张只有一个字段@rank的表ranker， 并且@rank字段也会作为用户自定义字段而存在， 所以相当于对@rank进行初始化。</li>
</ul>
<h4 id="笛卡尔乘积给一个表添加一个字段，-并且该字段自增"><a href="#笛卡尔乘积给一个表添加一个字段，-并且该字段自增" class="headerlink" title="笛卡尔乘积给一个表添加一个字段， 并且该字段自增"></a>笛卡尔乘积给一个表添加一个字段， 并且该字段自增</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select p.id, p.name, @rank := @rank + 1 as rank from person as p join (select @rank := 0) as ranker;</span><br></pre></td></tr></table></figure>
<h4 id="查询步骤"><a href="#查询步骤" class="headerlink" title="查询步骤"></a>查询步骤</h4><ul>
<li><p>查询操作是关系数据库中使用最为频繁的操作，也是构成其他SQL语句（如DELETE、UPDATE）的基础。查询处理的顺序如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(7) SELECT (8) DISTINCT </span><br><span class="line">(1) FROM </span><br><span class="line">(3) JOIN </span><br><span class="line">(2) ON </span><br><span class="line">(4) WHERE </span><br><span class="line">(5) GROUP BY </span><br><span class="line">(6) HAVING </span><br><span class="line">(9) ORDER BY </span><br><span class="line">(10) LIMIT</span><br></pre></td></tr></table></figure>
<ul>
<li>1）FROM：对FROM子句中的所有的表一次左右执行笛卡儿积（Cartesian product），产生虚拟表VT1。 </li>
<li>2，3）JOIN和ON应该是一个整体作为一个连接操作： 如果存在ON就先对VT1和JOIN后面的表进行过滤， 并且执行连接操作,  如果还有JOIN和ON继续接着进行连接， 如果此时又出现表则表示FROM后还有表进行笛卡尔乘积， 定义所有的这一连串操作产生VT3mysql不支持全连接， 并且它的连接与外连接是等价的， 跨连接与内连接是等价的</li>
<li>4）WHERE：对虚拟表VT3应用WHERE过滤条件，只有符合的记录才被插入虚拟表VT4中。此时数据还没有分组，所以不能在where中出现对统计的过滤 where: &lt;，&lt;=，=，!=或者&lt;&gt;，&gt; ，&gt;=， like (% 通配任意字符, _通配一个字符),exist(判空), beteeen(在某范围内)，any/som(集合中任意元素), all(集合中所有的元素), in(在某集合内), not !  逻辑非, or ||  逻辑或, and &amp;&amp;  逻辑与</li>
<li>5）GROUP BY：根据GROUP BY子句中的列，对VT4中的记录进行分组操作，产生VT5。在GROUP BY阶段，数据库认为两个NULL值是相等的，因此会将NULL值分到同一个分组中。</li>
<li>6）CUBE|ROLLUP：对表VT5进行CUBE或ROLLUP操作，产生表VT6。 </li>
<li>7）HAVING：对虚拟表VT6应用HAVING过滤器，只有符合的记录才被插入虚拟表VT7中。count(expr) 会返回expr不为NULL的行数，count(1)、count(*)会返回包括NULL值在内的所有数量 </li>
<li>8）SELECT：执行SELECT操作，选择指定的列，插入到虚拟表VT8中。 </li>
<li>9）DISTINCT：去除重复数据，产生虚拟表VT9。 </li>
<li>10）ORDER BY：将虚拟表VT9中的记录按照进行排序操作，产生虚拟表VT10。如果不指定排序，数据并非总是按照主键顺序进行排序的。NULL被视为最小值 </li>
<li>11）LIMIT：取出指定行的记录，产生虚拟表VT11，并返回给查询用户。LIMIT n, m的效率是十分低的,一般可以通过在where条件中指定范围来优化 where id&gt; ? limit 10</li>
<li>12)  UNION [ALL] (联合两个查询的结果), INTERSECT(交集)， EXCEPT(差集)</li>
</ul>
</li>
<li><p>注意：</p>
<ul>
<li>从上面的执行流程可以看出， 上面有很多过滤操作， 如： on where having distinct limit, 而每一个过滤操作都依赖前面的执行结果， 所以我们在前面的结果中如果能够尽量过滤掉不需要的结果那么对于后面的结果操作会简单很多。</li>
<li>所有的这些地方使用表的地方都可以使用子查询来建立新表， 如果数据量比较大尽量不适用子查询， 使用连接来优化。</li>
<li>对于要查询的结果来说， 从上面可以看到， 到第八步才开始进行真正的投影的， 所以不用担心查询出来结果信息。</li>
<li>可以看到limit是在最后执行的， 所以如果前期查询出大量结果， 再进行limit n,m可能会造成性能问题， 因为在limit之前以及进行了投影动作， 也就是所有的结果都以及查询出来了，如果此时我们只需要使用索引先搜索出满足limit的结果的主键id， 再通过主键id去查询结果， 那么此时会优化速度， 因为完全不用先查询出结果， 只需要最终去拿结果就可了。</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/linux-awk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/linux-awk/" itemprop="url">awk使用教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T18:40:16+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  563
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="awk的基本语法"><a href="#awk的基本语法" class="headerlink" title="awk的基本语法"></a>awk的基本语法</h4><ul>
<li><p><code>awk -F&#39; &#39; &#39;BEGAIN {} {Pattern {Action} Pattern {Action} ...} END {}&#39;</code></p>
<p>Pattern为一个判断条件， 如 $2&gt;3 &amp;&amp; $3 ~ /^Hel.*/， 基本比较符号和 ~/!~ 正则匹配</p>
<p>Action为一个动作， 如： print $1, $3</p>
<p>BEGAIN {}  只会在程序执行前执行一次</p>
<p>END {} 只会在程序执行后执行一次</p>
<p> {Pattern {Action} Pattern {Action} …} 会在每一行都会去循环执行</p>
</li>
<li><p>注意： </p>
<ul>
<li>Pattern也可以加上if作为一个判断， 其实awk只是简化了而已， 并且不用写中间的对每一行进行循环</li>
<li>awk存在内置常量， 不需要$来引用， NF字段的数量（列）， NR当前行数（awk读到第几行）， FILENAME正在处理的文件名字</li>
</ul>
</li>
</ul>
<h4 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h4><ul>
<li>~/!~ 使用正则表达式匹配</li>
<li>substr( $2,1,length($2)-3)   substr($2,length($2)-2)</li>
<li>match(buffer,/[0-9]+.c/)</li>
<li>split( “hello:world”, array, /[Pp]/)</li>
</ul>
<h4 id="分组统计"><a href="#分组统计" class="headerlink" title="分组统计"></a>分组统计</h4><p>​    分组统计分组个数， 分组总数， 分组平均， 分组最小， 分组最大</p>
<ul>
<li><p>按照协议进行分组统计</p>
<p>如： 游戏协议处理时间或者sql语句查询时间， 格式： 时间 协议/查询 时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2012 1 1</span><br><span class="line">2012 2 2</span><br><span class="line">2013 4 4</span><br><span class="line">2014 3 0</span><br><span class="line">2014 3 5</span><br><span class="line">2015 2 2</span><br><span class="line">2016 3 3</span><br><span class="line">2017 2 1</span><br><span class="line">2018 1 4</span><br><span class="line">2018 4 1</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F' ' '&#123;num[$2]+=1; sum[$2]+=$3; if(min[$2]=="")&#123;min[$2]=$3;max[$2]=$3;&#125; if(min[$2]&gt;$3)&#123;min[$2]=$3;&#125; if($3&gt;max[$2])&#123;max[$2]=$3;&#125;&#125; END &#123;for(i in num) print i, sum[i], num[i], sum[i]/num[i], min[i], max[i]&#125;' log.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照时间进行分组统计，格式如上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F' ' '&#123;num[$1]+=1; sum[$1]+=$3; if(min[$1]=="")&#123;min[$1]=$3;max[$1]=$3;&#125; if(min[$1]&gt;$3)&#123;min[$1]=$3;&#125; if($3&gt;max[$1])&#123;max[$1]=$3;&#125;&#125; END &#123;for(i in num) print i, sum[i], num[i], sum[i]/num[i], min[i], max[i]&#125;' log.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意：</p>
<ul>
<li>从这里可以看到awk中对于未定义的对象使用 UNDEFINE == “”</li>
<li>awk允许使用字符串最为数组下标， 所以这里协议可以是字符串协议， 并且使用数组前不需要进行声明</li>
<li>可以看到数组遍历非常简单， for(i in num) print num[i]</li>
</ul>
</li>
<li><p>awk 添加参数， 如， 在每一行前面添加文件名字：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file_name=hello.log</span><br><span class="line">awk -F'|' '&#123;print file_name, $1&#125;' file_name=“$file_name”</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="添加换行"><a href="#添加换行" class="headerlink" title="添加换行"></a>添加换行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "a,b" | awk -F "," '&#123;for(i=1;i&lt;=NF;i++) &#123;print $i&#125;&#125;'</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/linux-shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/linux-shell/" itemprop="url">shell详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T18:22:43+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,516
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="shell属于弱类型语言-其默认的变量类型为字符串类型"><a href="#shell属于弱类型语言-其默认的变量类型为字符串类型" class="headerlink" title="shell属于弱类型语言, 其默认的变量类型为字符串类型"></a>shell属于弱类型语言, 其默认的变量类型为字符串类型</h4><h4 id="shell-中符号使用"><a href="#shell-中符号使用" class="headerlink" title="shell 中符号使用"></a>shell 中符号使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$(),``		命令替换用，变成一个完整的命令并执行</span><br><span class="line">$[],$(())   简单的数学计算，支持+ - * / %</span><br><span class="line">$&#123;&#125;,$ 		参数替换</span><br><span class="line">$n			位置参数</span><br><span class="line">$*,$@		所有的参数，只有在引号时候才有差别</span><br><span class="line">$#			参数个数</span><br><span class="line">$? 			上一个进程的退出状态</span><br><span class="line">$$ 			shell本身进程PID</span><br><span class="line">$!			shell最后运行的后台Process的PID</span><br><span class="line">$-			使用Set命令设定的Flag一览</span><br></pre></td></tr></table></figure>
<h4 id="set命令"><a href="#set命令" class="headerlink" title="set命令"></a>set命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set -o		显示所有的set命令Flag表，显示开启或者关闭</span><br><span class="line">set +o		显示所有的set命令Flag表，相当与set命令Flag的备份模式显示</span><br><span class="line">set -e or -o errexit	命令执行失败时，shell会立即退出</span><br><span class="line">set -n or -o noexec		不执行命令，相当与语法检查</span><br><span class="line">set -u or -o unset		引用为定义的变量的时候，会推出程序并打印错误</span><br><span class="line">set -x or -o xtrace		跟踪代码执行trace</span><br><span class="line">set -o pipefail			默认情况下，一个管道的返回值是最后一个命令的返回值，比如cmda | cmdb | cmdc这个管道，返回值是由cmdc命令的返回值决定的。如果指定了pipefail选项，那么管道的返回值就会由最后一个失败的命令决定，意思就是有命令失败就会返回非0值。如果所有命令都成功，则返回成功。</span><br><span class="line">set -a or -o allexport	所有的变量都会export到环境变量中</span><br></pre></td></tr></table></figure>
<p><strong>说明： </strong>set命令主要使用来开关shell的扩展的，在set命令中，选项前面跟着<strong>-</strong>号表示开启这个选项，<strong>+</strong>表示关闭这个选项。shopt命令也是扩展shell的功能。</p>
<h4 id="shell内建命令"><a href="#shell内建命令" class="headerlink" title="shell内建命令"></a>shell内建命令</h4><ul>
<li>可以使用 <code>man bash-builtins</code> 查看搜有的内建命令及其使用</li>
</ul>
<h4 id="shell命令类型"><a href="#shell命令类型" class="headerlink" title="shell命令类型"></a>shell命令类型</h4><ul>
<li><p>type命令判断一个命令是否是shell的内置命令</p>
<p>type -a  command 打印出command的执行优先级, 因为shell命令可能被 alise 重新命名, function添加名称, 或者是外部命令取相同的名称, 所以必须要一个执行顺序,  顺序如： alias –&gt; function –&gt; builtin –&gt; program   后</p>
</li>
<li><p>which查看命令所在的位置, 如果内置命令不显示位置, whereis也可以用来显示位置, 默认过滤内部命令直接外部去找, command 命令可以查看命令的具体位置，如： command -v java</p>
</li>
<li>shell中有一些命令可能与外部命令有相同的名称, 默认shell会调用内置的命令, 因为这可以避免fork/exec</li>
<li>shell执行某个命令后, 如果是内部命令(其实就像是内置的方法一样), shell程序直接调用自己的一段方法就可以了, 如果是外部命令, 那么shell首先fork出一个进程, 再使用exec家族中的方法来执行外部命令, exec家族命令中可以选择是否将父进程中的环境变量传递给子进程.</li>
</ul>
<h4 id="shell中不同的执行方式"><a href="#shell中不同的执行方式" class="headerlink" title="shell中不同的执行方式"></a>shell中不同的执行方式</h4><ul>
<li>sh/bash: 表示另起一个shell， 也就是首先fork一个子进程, 再在子进程中exec子进程代码后(父进程停止)， 再运行父进程的代码</li>
<li>exec: 不会fork出子进程， 而是使用新的命令代替当前进程中所有的代码开始执行， 也就是exec后面的代码都是不会执行的, 注意exec后面是完整的执行命令， 而不仅仅只是一个执行文件(exec bash file.sh)</li>
<li>source/.:  不会fork出子进程，直接停止当前进程，运行source后面的命令，当source后面的命令执行完成之后，再启动父进程，继续执行</li>
<li>注意：<ul>
<li>用export会把父进程中的变量向子进程中继承，但是反过来却不行，在子进程中，不管环境如果改变，均不会影响父进程，所以如果想要环境变量可以传递不能使用sh/bash</li>
<li>同一个进程中变量的传递是可以直接传递的，不需要使用export成环境变量， 也就是说使用 source/. 和 exec 可以直接从上下文中获取，也就是source/.和exec中执行的代码可以获取前面的变量， 而source/.和exec后面的代码也可以获取到source/.和exec中定义的变量</li>
</ul>
</li>
</ul>
<h4 id="命令返回值"><a href="#命令返回值" class="headerlink" title="命令返回值"></a>命令返回值</h4><ul>
<li>所有的命令输出或者echo命令的输出, 都可以赋值给一个具体的变量, 这样非常有用</li>
<li>a=<code>[ 3 -ge 2 ] &amp;&amp; echo &quot;large&quot; || echo &quot;small&quot;</code> 或者使用$(command)</li>
</ul>
<h4 id="测试命令"><a href="#测试命令" class="headerlink" title="测试命令"></a>测试命令</h4><ul>
<li><p>test/[ 命令的与或非 与 bash命令中的  &amp;&amp; || !的区别</p>
<p>test 1 &gt; 2 -a 2 &lt; 3                test 1 &gt; 2 -o 2 &lt; 3                test !1 &gt; 2</p>
<p>test 1 &gt; 2 &amp;&amp; test 2 &lt; 3        test 1 &gt; 2 || test 2 &lt; 3            ! test 1 &gt; 2</p>
<p>从上面命令可以看到test命令提供的与或非是在test命令中实现的, 也就是test遇到这样的命令它会默认将其解析成两个命令执行, 而 &amp;&amp; || !则是将其当两个命令来执行的, 先执行前面的命令, 再看是否需要执行后面的命令, 所以这样就可以拼凑出, 三元表达式如:[ 3 -ge 2 ] &amp;&amp; echo “large” || echo “small</p>
</li>
<li><p>shell中不存在布尔值的概论, 即使执行test或false命令, 也仅仅只是返回给程序执行结果一个标示, 标示命令是否执行成功, $?, 所以对于shell而言, 所谓的bool值就是命令执行的结果是否成功, $?=0表示程序执行成功, 而非零则表示执行失败</p>
</li>
<li>shell的条件判断 [ -n “$1” ] &amp;&amp; echo “exist” || echo “none”</li>
</ul>
<h4 id="shell-语言"><a href="#shell-语言" class="headerlink" title="shell 语言"></a>shell 语言</h4><ul>
<li><p>shell中使用#表示注释， 首行 <code>#!/bin/bash</code>  或者 <code>#!/usr/bin/env bash</code> </p>
</li>
<li><p>shell中使用\表示转义， 表示后面字符使用其真实含义， 如：用在行为表示另外启动一行， 也就是\n本身的含义保留， 所以换行才可以使用\</p>
</li>
<li><p>[ 实际上是一个命令， [ -d /etc ] 实际上-d /etc ]都是这个测试命令的参数， 并且它要求最后一个参数必须是 ], 如果测试结果为真，则该命令的Exit Status为0，如果测试结果为假，则命令的Exit Status为1（注意与C语言的逻辑表示正好相反）， 并且可以使用man [ 开查看帮助信息,  它与test命令没有任何区别</p>
</li>
<li><p>通过$?获取退出码</p>
</li>
<li><p>算数计算 $(()), $(())中只能用+-*/和()运算符，并且只能做整数运算。</p>
</li>
<li><p>for循环可以直接在命令行输入： </p>
<p>for i in $(jps | grep -v ‘Jps’| awk ‘{print $1}’); do echo $i; done</p>
<p>for i in $(ls); do echo $i; done</p>
<p>for i in `ls`; do echo $i; done</p>
<p>for i in hello world welcome; do echo $i; done</p>
<p>for i in *; do echo $i; done  表示将当前文件夹下所有的文件都打印出来</p>
<p><strong>注意：</strong></p>
<ul>
<li>in后面的参数是以空格和分行符来确定的， 并且如果参数为一个路径， 或者路径的正则表达式形式， 那么模式是使用    ls 参数    的形式来进行操作的。</li>
<li>in后面的参数都是以字符串的形式表示的， 所以对于bash而言没有数据类型的说法， 一切皆为字符串</li>
<li>每次遍历完成之后， 其实变量 i 并没有销毁，此时变量i保存着最后循环值， 这也表明shell script并非使用传统的局部变量的编译形式。可以手动进行取消 unset i</li>
</ul>
</li>
<li><p>while/until 循环</p>
<p>while [[ -f file.txt ]]; do </p>
<p>…</p>
<p>done</p>
<p>until [[ ! -f file.txt ]]; do</p>
<p>…</p>
<p>done</p>
<p>while表示条件满足就执行， until表示条件满足就退出</p>
</li>
<li><p>case语句</p>
</li>
<li><p>在shell script中可以使用tip</p>
<p>return 返回当前脚本或者代码块</p>
<p>exit 退出</p>
<p>printf 格式化打印</p>
</li>
<li><p>shell中的变量</p>
<p>方法局部变量： 使用local 定义</p>
<p>局部变量： 只能在当前脚本中使用</p>
<p>环境变量： 所有的脚本中都可以使用</p>
<p>shell变量： shell中特定的变量</p>
</li>
<li><p>字符串， 字符串的定义比较宽松， 单引号、双引号、不用引号</p>
<p>单引号： 单引号中的数据会原封输出， 单引号中变量无效，且不能再存在单引号，不存在转义</p>
<p>双引号： 双引号中可以存在变量， 且可以转义</p>
</li>
</ul>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><ul>
<li><p>命令判断：</p>
<p>command    command -v java</p>
</li>
<li><p>选取： </p>
<p>cut        cut /etc/passwd -d “:” -f 3,5</p>
<p>grep    ps -ef | grep -Ei “mysql|syslog” | grep -v ‘grep’ | grep -B 1 “root”</p>
<p>awk        less /etc/passwd | awk -F’:’ ‘BEGIN {print “begin”}{print $3} END {print “after”}’</p>
</li>
<li><p>排序统计：</p>
<p>sort        less /etc/passwd | cut -d “:” -f 3,7| sort -t : -k 1 -n -r</p>
<p>wc        less /etc/passwd | wc -l -w -c</p>
<p>uniq    less /etc/passwd | cut -d : -f 7 | sort | uniq -c -u/d</p>
</li>
<li><p>多重定向：</p>
<p>tee        less /etc/passwd | tee hello world     将输出重定向到 中端、hello和world的文件当中</p>
</li>
<li><p>字符转换命令：</p>
<p>tr        删除、替换、压缩</p>
<p>sed</p>
<p>paste    paste -d : /etc/passwd /etc/group     案行合并文件</p>
<p>join        按文件相关性合并文件， 类似excel中的lookup函数</p>
</li>
<li><p>字符显示：</p>
<p>printf</p>
</li>
<li><p>文件查看：</p>
<p>cat(tac, rev)、 more、 less、 head、 tail、 nl、grep、hexdump、 od、 xxd</p>
</li>
<li><p>文件路径：</p>
<p>dirname、basename、rename</p>
</li>
<li><p>文件定位：</p>
<p>locate    基于数据库， 需要手动维护数据库， 快速</p>
<p>find 时实查找， 相对慢, 可以查找并删除</p>
</li>
<li><p>文件内容搜索</p>
<p>grep     强大的正则表达式</p>
<p>ag     比grep更加快速</p>
</li>
<li><p>文件创建</p>
<p>mkdir</p>
<p>mktemp         -p 指定创建父目录，-d 创建文件夹，-u不创建文件只是生成随机字符串</p>
</li>
<li><p>数学操作</p>
<p>seq     生成序列</p>
<p>RANDOM    环境变量, 产生从 0 到 32767 的随机数</p>
</li>
</ul>
<h4 id="多个命令同时执行"><a href="#多个命令同时执行" class="headerlink" title="多个命令同时执行"></a>多个命令同时执行</h4><ul>
<li>所有的命令必须执行成功, 第一个命令执行完成后才会执行下一个命令， 如果中间命令执行出错则会打断后续命令执行， &amp;&amp;</li>
</ul>
<p>​    如： less … &gt; a.txt &amp;&amp; less … &gt; b.txt &amp;&amp; less a.txt b.txt | sort | uniq -u</p>
<ul>
<li><p>所有的命令至少有一个执行成功, 前面的命令执行错误不会打断命令继续执行， ||</p>
<p>如： hello || cat a.txt, 此时第一条命令打印错误信息， 第二条命令执行完成</p>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/linux-info/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/linux-info/" itemprop="url">linux基本信息查看</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T18:15:37+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  484
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h4><p>​    uname -a   / cat /proc/version                # 查看内核/操作系统/CPU信息</p>
<p>​    head -n 1 /etc/issue       # 查看操作系统版本</p>
<p>​    cat /etc/redhat-release  # 查看操作系统版本</p>
<p>​    cat /proc/cpuinfo          # 查看CPU信息</p>
<p>​    cat /proc/cpuinfo | grep ‘physical id’        #查看cpu个数</p>
<p>​    cat /proc/cpuinfo | grep ‘core id’             #查看cpu核心个数</p>
<p>​    cat /proc/cpuinfo | grep ‘processor’            #查看cpu线程个数</p>
<p>​    hostname                   # 查看计算机名</p>
<p>​    lspci -tv                      # 列出所有PCI设备</p>
<p>​    lsusb -tv                      # 列出所有USB设备</p>
<p>​    lsmod                          # 列出加载的内核模块</p>
<p>​    env                            # 查看环境变量</p>
<h4 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h4><p>​    free -m                        # 查看内存使用量和交换区使用量</p>
<p>​    df -h                          # 查看各分区使用情况</p>
<p>​    du -sh &lt;目录名&gt;            # 查看指定目录的大小</p>
<p>​    grep MemTotal /proc/meminfo       # 查看内存总量</p>
<p>​    grep MemFree /proc/meminfo        # 查看空闲内存量</p>
<p>​    uptime                         # 查看系统运行时间、用户数、负载</p>
<p>​    cat /proc/loadavg          # 查看系统负载</p>
<h4 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h4><p>​    mount | column -t              # 查看挂接的分区状态</p>
<p>​    fdisk -l                           # 查看所有分区</p>
<p>​    swapon -s                      # 查看所有交换分区</p>
<p>​    hdparm -i /dev/hda         # 查看磁盘参数(仅适用于IDE设备)</p>
<p>​    dmesg | grep IDE               # 查看启动时IDE设备检测状况</p>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><p>​    ifconfig                       # 查看所有网络接口的属性</p>
<p>​    iptables -L                    # 查看防火墙设置</p>
<p>​    route -n                       # 查看路由表</p>
<p>​    netstat -lntp              # 查看所有监听端口</p>
<p>​    netstat -antp             # 查看所有已经建立的连接</p>
<p>​    netstat -s                     # 查看网络统计信息</p>
<p>​    rfkill list                        # 查看无线网卡和蓝牙情况</p>
<p>​    nethogs                        # 查看网络使用情况</p>
<h4 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h4><p>​    ps -ef                         # 查看所有进程</p>
<p>​    top                            # 实时显示进程状态</p>
<p>​    jobs、 fg、 bg、 ctrl+z/c、 启动 &amp;</p>
<h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4><p>​    w                      # 查看活动用户</p>
<p>​    id &lt;用户名&gt;            # 查看指定用户信息</p>
<p>​    last                   # 查看用户登录日志</p>
<p>​    cut -d: -f1 /etc/passwd   # 查看系统所有用户</p>
<p>​    cut -d: -f1 /etc/group    # 查看系统所有组</p>
<p>​    crontab -l             # 查看当前用户的计划任务</p>
<h4 id="清空访问痕迹"><a href="#清空访问痕迹" class="headerlink" title="清空访问痕迹"></a>清空访问痕迹</h4><p>​    history -c</p>
<p>​    echo &gt; /var/spool/mail/root<br>​    echo &gt; /var/log/wtmp<br>​    echo &gt; /var/log/secure<br>​    echo &gt; /root/.bash_history</p>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/linux-user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/linux-user/" itemprop="url">linux 用户</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T17:46:49+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,548
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="shell作用"><a href="#shell作用" class="headerlink" title="shell作用"></a>shell作用</h4><p>​    用户登录后，要启动一个进程，负责将用户的操作传给内核，这个进程是用户登录到系统后运行的命令解释器或某个特定的程序，即Shell。</p>
<h4 id="linux中用户概念"><a href="#linux中用户概念" class="headerlink" title="linux中用户概念"></a>linux中用户概念</h4><ol>
<li><p>linxu中存在用户的概念， 系统中存在三种用户：</p>
<p>root用户：    id=0                登陆shell为/bin/bash(表示可以登录)</p>
<p>系统用户：    id=(1-1000)            没有登陆shell（/usr/sbin/nologin, 不需要登陆）</p>
<p>普通用户：    id=(1000-65534)        登陆shell为/bin/bash(可以登录)</p>
</li>
<li><p>系统中的所有的文件都存在一个所属用户和所属组的概念， 并且存在所属用户、所属组、附属组的权限， 并且每个用户都存在一个用户名（用户id）， 一个所属组（组id）， 0-31个附属组（附属组id）， 并且每个进程都需要以一个用户的身份来运行， 表示当前用户是否存在访问系统资源的权限</p>
</li>
</ol>
<h4 id="查看用户信息"><a href="#查看用户信息" class="headerlink" title="查看用户信息"></a>查看用户信息</h4><ol>
<li>id显示当前用户信息</li>
</ol>
<p>​    uid=1000(feng)        用户id（用户名）</p>
<p>​        gid=1000(feng)        用户组id（用户组名）</p>
<p>​        groups=1000(feng)        用户附属组id（附属组名）    可以存在多个附属组</p>
<ol start="2">
<li><p>passwd修改用户密码</p>
</li>
<li><p>w/who/whoami</p>
</li>
<li><p>who -r 查看运行级别</p>
</li>
</ol>
<h4 id="基本文件"><a href="#基本文件" class="headerlink" title="基本文件"></a>基本文件</h4><ul>
<li>/etc/passwd        用户相关信息</li>
</ul>
<p>​    用户名:密码:uid:gid:描述信息:家目录:登陆shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">.....</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">uuidd:x:108:112::/run/uuidd:/bin/false</span><br><span class="line">feng:x:1000:1000:feng,,,:/home/feng:/bin/bash</span><br><span class="line">sshd:x:110:65534::/var/run/sshd:/usr/sbin/nologin</span><br></pre></td></tr></table></figure>
<ul>
<li><p>/etc/shadow        用户密码</p>
</li>
<li><p>/etc/group        用户组信息</p>
</li>
</ul>
<h4 id="创建用户-useradd"><a href="#创建用户-useradd" class="headerlink" title="创建用户 useradd"></a>创建用户 useradd</h4><ul>
<li><p>在/etc/passwd中添加用户信息</p>
</li>
<li><p>为用户创建一个家目录/home/uname</p>
</li>
<li>将/etc/skel中的文件复制到用户的家目录当中(所以如果希望每次创建新用户的相同动作)</li>
<li>建立一个与用户名相同的组， 新建用户默认属于这个组</li>
<li>如果使用passwd命令创建密码， 则将密码保存在/etc/shadow当中</li>
</ul>
<p>​        可以使用以下参数：</p>
<p>​            -d    家目录</p>
<p>​            -s        登陆shell</p>
<p>​            -u    userid</p>
<p>​            -g        主组</p>
<p>​            -G    附属组（多个， 用“，”分割）</p>
<ul>
<li><p>用户其它操作</p>
<p>usermod        修改用户</p>
<p>userdel             删除用户 -r 家目录也一起删除</p>
</li>
</ul>
<h4 id="用户组相关操作（组和用户是独立的概念）"><a href="#用户组相关操作（组和用户是独立的概念）" class="headerlink" title="用户组相关操作（组和用户是独立的概念）"></a>用户组相关操作（组和用户是独立的概念）</h4><p>​    groupadd        添加组</p>
<p>​    groupmod        修改组</p>
<p>​    groupdel        删除组</p>
<h4 id="组的规划案例："><a href="#组的规划案例：" class="headerlink" title="组的规划案例："></a>组的规划案例：</h4><table>
<thead>
<tr>
<th>组</th>
<th>用户</th>
</tr>
</thead>
<tbody>
<tr>
<td>training</td>
<td>feng、xiang</td>
</tr>
<tr>
<td>market</td>
<td>alice、bob</td>
</tr>
<tr>
<td>manage</td>
<td>steve、john</td>
</tr>
</tbody>
</table>
<h5 id="创建组："><a href="#创建组：" class="headerlink" title="创建组："></a>创建组：</h5><p>​    <code>groupadd training</code></p>
<p>​    <code>groupadd market</code></p>
<p>​    <code>groupadd manage</code></p>
<h5 id="创建用户："><a href="#创建用户：" class="headerlink" title="创建用户："></a>创建用户：</h5><p>​    <code>useradd -G training feng -p 123456</code></p>
<p>​        <code>useradd -G training xiang -p 123456</code></p>
<p>​        <code>useradd -G market alice -p 123456</code></p>
<p>​        <code>useradd -G market bob -p 123456</code></p>
<p>​        <code>useradd -G manage steve -p 123456</code></p>
<p>​        <code>useradd -G manage john -p 123456</code></p>
<h4 id="权限-文件夹必须用户可执行权限，-不然无法查看文件夹中的内容"><a href="#权限-文件夹必须用户可执行权限，-不然无法查看文件夹中的内容" class="headerlink" title="权限(文件夹必须用户可执行权限， 不然无法查看文件夹中的内容)"></a>权限(文件夹必须用户可执行权限， 不然无法查看文件夹中的内容)</h4><p>​    文件类型|文件所属组|其它 链接数 所属用户 所属组 大小 最后修改时间 文件名</p>
<p>​    drwxr-xr-x  6 feng feng  4096 Aug  4 15:22 ./</p>
<p>​    drwxr-xr-x  3 root root  4096 Jan  2  2017 ../</p>
<p>​    -rw——-  1 feng feng 15478 Aug  4 14:34 .bash_history</p>
<p>​    所有的权限命令都是-R来递归修改目录下的权限</p>
<ul>
<li><p>更改文件所属用户</p>
<p>​    chown    feng        Hello.java</p>
</li>
<li><p>更改文件所属组</p>
<p>​    chgrp        feng        Hello.java</p>
</li>
<li><p>更改文件权限</p>
<p>​    chmod 模式 文件</p>
<p>​    模式：</p>
<p>​    u、g、o、a 表示用户、组、其它、所有</p>
<p>​        +、-表示添加或者减少</p>
<p>​        r、w、x代表三种权限</p>
<p>​        777用三个数字来表示三组权限</p>
<p>​            数字权限： r = 2^2 = 4, w = 2^1 = 2 , x = 2^0 = 1</p>
<p>​            如：rw = 4+2 = 6</p>
<p>​    实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod u+rw	Hello.java</span><br><span class="line">chmod g-x	hello</span><br><span class="line">chmod go+r	Hello.java</span><br><span class="line">chmod a-x	Hello.class</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="登陆中断的umask值，-表示当前登录用户创建文件的权限"><a href="#登陆中断的umask值，-表示当前登录用户创建文件的权限" class="headerlink" title="登陆中断的umask值， 表示当前登录用户创建文件的权限"></a>登陆中断的umask值， 表示当前登录用户创建文件的权限</h4><p>​    注意：对于普通用户的默认umask值为0002， 管理员用户的默认umask值为0002</p>
<p>​            前面1位：特殊权限， 有三个（suid、sgid、sticky）</p>
<p>​            后面3位： ugo模型的基本权限</p>
<p>​    特殊权限：</p>
<table>
<thead>
<tr>
<th>权限</th>
<th>对文件的影响</th>
<th>对目录的影响</th>
</tr>
</thead>
<tbody>
<tr>
<td>suid</td>
<td>以文件的所属用户身份执行，而非执行文件的用户</td>
<td>无</td>
</tr>
<tr>
<td>sgid</td>
<td>以文件所属组身份执行</td>
<td>在该目录中创建的文件的所属组与该目录的所属组相同</td>
</tr>
<tr>
<td>sticky</td>
<td>无</td>
<td>对目录拥有些权限的用户仅能删除拥有文件，无法删除其它</td>
</tr>
</tbody>
</table>
<ul>
<li><p>suid（通常都是设置给可执行文件的）：  </p>
<ul>
<li><p>当操作系统需要暴露出一个命令可以给普通用户使用， 但是这个命令需要root用户的权限， 此时将此命令的O权限设置r_x给普通用户， 并添加器suid权限， 此时就满足需求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">feng@ubuntu:~$ ll /usr/bin/passwd    </span><br><span class="line">-rwsr-xr-x 1 root root 54256 May 17 07:37 /usr/bin/passwd*</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看出此时命令的U权限位的x权限设置成了s， 并且O权限位为r_x， 表示：其它用户可以执行当前命令， 但是此时我们知道密码保存在/etc/shadow文件当中， 但是此时西面可以看出shadow文件必须只有root用户才可以访问的， 所以此时passwd命令必须让其以root用户的身份运行。</p>
<p>feng@ubuntu:~$ ll /etc/shadow</p>
<p>-rw-r—– 1 root shadow 998 Aug  4 17:33 /etc/shadow</p>
</li>
<li><p>mysql程序虽然是root用户启动， 但是此时实际运行的用户为mysql用户</p>
</li>
</ul>
</li>
<li><p>sticky：</p>
<p>drwxrwxrwt   8 root root  4096 Aug  4 18:20 tmp/</p>
</li>
</ul>
<p>​        可以看到对于O权限位的x权限变成了t， 对于文件夹而言必须要x权限才能读取， 此时变成了</p>
<p>​        t权限位， 表示目录下的文件只有当前用户才能删除用户的文件， 其它的文件无法删除</p>
<ul>
<li><p>sgid：</p>
<p>一般使用在多人团队的项目当中（系统中使用很少）， 为文件夹设置一个sgid权限， 并设置</p>
</li>
</ul>
<p>​        所属组都存在访问操作权限， 这样更加方便管理</p>
<h4 id="文件夹有一个点（-），表示操作系统启用selinux，但是selinux关闭后原先的文件存在点好并不会取消"><a href="#文件夹有一个点（-），表示操作系统启用selinux，但是selinux关闭后原先的文件存在点好并不会取消" class="headerlink" title="文件夹有一个点（.），表示操作系统启用selinux，但是selinux关闭后原先的文件存在点好并不会取消"></a>文件夹有一个点（.），表示操作系统启用selinux，但是selinux关闭后原先的文件存在点好并不会取消</h4><p>​            </p>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/linux-gopass/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/linux-gopass/" itemprop="url">gopass安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T14:50:00+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  871
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="gopass各组件说明"><a href="#gopass各组件说明" class="headerlink" title="gopass各组件说明"></a>gopass各组件说明</h4><ul>
<li>gopass 用于密码管理的工具， 是pass的go语言版本， 提供了多人的密码管理命令行接口</li>
<li>gnupg 用于真正的加密， gnupg用于生成非对称秘钥， 使用公钥进行机密， 私钥进行解密</li>
<li>git 用于将gopass需要管理的密码（被gnupg生产的公钥加密过的密码）上传到git中便于管理</li>
<li><a href="http://www.voidcn.com/article/p-gngvxvlm-nx.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-gngvxvlm-nx.html</a></li>
</ul>
<h4 id="安装gopass"><a href="#安装gopass" class="headerlink" title="安装gopass"></a>安装gopass</h4><ul>
<li><p>安装基本工具</p>
<p><code>apt-get install gnupg git rng-tools</code></p>
<p><strong>说明：</strong> </p>
<ul>
<li>gnupg通过非对称加密算法对密码进行加密</li>
<li>git用于将加密后的密码上传到git远程仓库中</li>
</ul>
</li>
<li><p>初始化GPG key pair</p>
<p><code>gpg --gen-key</code></p>
</li>
<li><p>安装gopass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O- https://api.bintray.com/orgs/gopasspw/keys/gpg/public.key | sudo apt-key add -</span><br><span class="line">echo "deb https://dl.bintray.com/gopasspw/gopass trusty main" | sudo tee /etc/apt/sources.list.d/gopass.list</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install gopass</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加自动完成脚本到.zshrc中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(gopass completion zsh | head -n -1 | tail -n +2)</span><br><span class="line">compdef _gopass gopass</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化gopass</p>
<p><code>gopass init</code></p>
</li>
</ul>
<h4 id="安装passmenu"><a href="#安装passmenu" class="headerlink" title="安装passmenu"></a>安装passmenu</h4><ul>
<li><p>安装dmemu</p>
<p><code>sudo apt install dmenu</code></p>
</li>
<li><p>安装passmenu脚本到path中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">shopt -s nullglob globstar</span><br><span class="line"></span><br><span class="line">typeit=0</span><br><span class="line">if [[ $1 == "--type" ]]; then</span><br><span class="line">	typeit=1</span><br><span class="line">	shift</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">prefix=$&#123;PASSWORD_STORE_DIR-~/.password-store&#125;</span><br><span class="line">password_files=( "$prefix"/**/*.gpg )</span><br><span class="line">password_files=( "$&#123;password_files[@]#"$prefix"/&#125;" )</span><br><span class="line">password_files=( "$&#123;password_files[@]%.gpg&#125;" )</span><br><span class="line"></span><br><span class="line">password=$(printf '%s\n' "$&#123;password_files[@]&#125;" | dmenu "$@")</span><br><span class="line"></span><br><span class="line">[[ -n $password ]] || exit</span><br><span class="line"></span><br><span class="line">if [[ $typeit -eq 0 ]]; then</span><br><span class="line">	pass show -c "$password" 2&gt;/dev/null</span><br><span class="line">else</span><br><span class="line">	pass show "$password" | &#123; IFS= read -r pass; printf %s "$pass"; &#125; |</span><br><span class="line">		xdotool type --clearmodifiers --file -</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加系统快捷键</p>
<p>路径： <code>System Settings --&gt; keyboard --&gt; Shortcuts --&gt; Custom Shortcuts</code></p>
<p>添加： 上面脚本的路径</p>
</li>
</ul>
<h4 id="配置git远程仓库"><a href="#配置git远程仓库" class="headerlink" title="配置git远程仓库"></a>配置git远程仓库</h4><ul>
<li><p>在github中创建个人私有仓库</p>
</li>
<li><p>讲gopass的git仓库添加到远程仓库当中</p>
<p><code>git remote add origin https://github.com/xxxx/gopass.git</code></p>
<p><code>gopass sync</code></p>
</li>
</ul>
<h4 id="配置gpg"><a href="#配置gpg" class="headerlink" title="配置gpg"></a>配置gpg</h4><ul>
<li><p>创建回收key， 用于在私钥发送泄露或者忘记私钥密码时回收公钥</p>
<p><code>gpg --armor --output revoke-key.txt --gen-revoke keyname</code></p>
</li>
<li><p>导出公钥和私钥</p>
<p><code>gpg --armor --output public-key.txt --export keyname</code></p>
<p><code>gpg --armor --output private-key.txt --export-secret-keys keyname</code></p>
</li>
<li><p>备份自己的gpg秘钥对到google云盘当中</p>
<p><strong>说明：</strong> gpg的秘钥和gopass保护的密码都以及保存起来了， 用于以后的密码找回</p>
</li>
</ul>
<h4 id="直接查看gopass中密码"><a href="#直接查看gopass中密码" class="headerlink" title="直接查看gopass中密码"></a>直接查看gopass中密码</h4><ul>
<li><p>由于gopass中的密码以及被上面生成的密钥对的公钥加密过， 所以只需要通过上面导出的私钥就可以解密出正真的密码明文</p>
<p><code>gpg -o hello.txt -d ~/.password-store/storm.gpg</code></p>
<p><strong>注意：</strong>此时需要输入我们生成密钥时候的密钥密码， 所以从这里可以看到即使别人拿到我们的密钥如果没有私钥密码那么他们照样是无法进行解密的</p>
</li>
</ul>
<h4 id="恢复gopass的环境"><a href="#恢复gopass的环境" class="headerlink" title="恢复gopass的环境"></a>恢复gopass的环境</h4><ul>
<li><p>git clone 密码库到本地</p>
<p><code>git clone https://github.com/xxxx/gopass.git ~/.password-store</code></p>
</li>
<li><p>gpg 导入公钥和私钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --import ~/public-key.txt </span><br><span class="line">gpg --allow-secret-key-import --import ~/private-key.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>gopass配置使用公钥用户进行加密</p>
<p><code>gopass init</code></p>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>从上面的说明可以看出github中的密码和google的密码也是非常重要的， 但是通常情况下绑定了手机可以直接找回， 所以不用担心， 直接使用gopass自动生成的密码即可</li>
<li>私钥是一定不能忘记的， 所以如果这三个密码如果没有全部丢失那么通常情况下自己的gopass密码管理就是没有问题的。</li>
<li>但是存在一个问题， 那就是机器丢失的问题</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/linux-server-monitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/linux-server-monitor/" itemprop="url">linux 服务器监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T21:34:51+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  624
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p><code>top</code>         top -H -p</p>
</li>
<li><p><code>free</code>        free -m</p>
</li>
<li><p><code>vmstat</code>     vmstat 1 10</p>
</li>
<li><p><code>pmstat</code>     pmstat -P -ALL 2 3</p>
</li>
<li><p><code>pidstat</code>    pidstat -p pid 1 5 -l/d/r/w/t</p>
</li>
<li><p><code>iostat</code>    iostat -x 1 3</p>
</li>
<li><p><code>ifstat</code>   </p>
</li>
<li><p><code>dstat</code></p>
</li>
<li><p><code>crontab</code>    定时任务， 注意： 添加PATH，或者直接执行source /etc/profile， 添加文件权限，写定时任务时输出错误日志，脚本中所有的命令和文件必须在path中找到，不然就需要全路径，如果有问题查看日志/var/log/cron</p>
</li>
<li><p><code>netstat</code> 显示服务器监听状态， 和正在被其它机器连接以及连接到其它的机器的连接</p>
<p>-a -t -u： 表示查看正在被其他机器连接或者连接到其它机器， -t tcp, -u udp, -a tcp/udp</p>
<p>-l: 表示服务器监听状态</p>
<p>-n 拒绝显示别名，能显示数字的全部转化成数字。</p>
<p>-p 显示建立相关链接的程序名和端口号</p>
<p>-e 显示扩展信息</p>
<p>常用案例：</p>
<ol>
<li><p>查看某个端口的连接数：</p>
<p><code>netstat -an | grep 9991 | wc -l</code> </p>
</li>
<li><p>查看某个程序监听的端口</p>
<p><code>netstat -lp | grep mysql</code></p>
</li>
<li><p>查看某个程序对外连接数在ip上的分布：</p>
<p><code>netstat -an | grep &quot;192.168.1.15:22&quot; |awk &#39;{print $5}&#39;|awk -F: &#39;{print $1}&#39;|sort|uniq -c|sort -nr|head -20</code></p>
<p>192.168.1.15:22 服务端监听的程序</p>
</li>
<li><p>netstat -c实时监控连接的建立</p>
<p><code>ps -ef | grep name</code> 可以先通过netstat查看到程序进程id， 再通过ps来查看相关信息</p>
</li>
</ol>
</li>
<li><p><code>lsof</code> 列出打开的文件(list open file), 这是个非常重要的命令， 非常方便我们查看文件相关，我们知道在linux当中所有的硬件设备都是以文件的形式存在， 所以我们可以通过查看文件的信息查看我们的硬件信息， 如： 网络设备， 磁盘等等</p>
<p>常用参数：</p>
<p>lsof -p pid： 列出指定进程号所打开的文件</p>
<p>​    <code>lsof -p 2</code>     列出程序打开的文件</p>
<p>lsof -i 条件： 列出符合条件的进程。 （4， 6， 协议， :端口， @ip）</p>
<p>​    <code>sudo lsof -i 4</code>        列出ipv4的进行</p>
<p>​    <code>sudo lsof -i 6:2181</code>    列出ipv4并且端口为2181的进程</p>
<p>lsof +d/D 目录： 列出目录下被打开的文件/递归</p>
<p>​    <code>lsof -d .</code>     当前目录</p>
<p>​    <code>lsof -D .</code>    递归显示</p>
<p>​    可以指定多个条件，但默认是OR关系的，如果需要AND关系，必须传入-a参数，比如查看22端口并且使用Ipv6连接的进程：</p>
<p>​    <code>sudo lsof -c sshd -i 6 -a -i :22</code></p>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/hadoop-spark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/hadoop-spark/" itemprop="url">spark注意点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T21:26:35+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,147
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>spark transform 和 action 动作中的闭包序列化，由于在闭包中，spark只是负责把闭包进行序列化成对象，也就是说从Driver到Executor中，spark拿到的都是一个个序列化对象，并通过rdd的组合对这些序列化对象进行调用，那么对于闭包来说，spark没有任何的特例，它就是完全使用scala语言闭包的语义，也就是说在创建闭包的时候，对于闭包的可见性对象， 它会将其打包成类的属性， 并对闭包进行序列化，那么通常来说它仅仅只是会打包闭包可见性并且需要的对象，对于闭包中的可见性对象如果它的方法依赖与另外一个对象（并且这个对象，不是这个可见对象的属性，那么spark是不会序列化这个对象的，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//业务调用</span><br><span class="line">import CacheHelper.cache</span><br><span class="line">dataset.filter&#123;log =&gt;  cache(log .....)&#125;</span><br><span class="line">// rdd闭包中使用这个单例中的方法， </span><br><span class="line">object CacheHelper&#123;</span><br><span class="line">cache(log ....) &#123;</span><br><span class="line">Sington.name</span><br><span class="line">&#125;&#125;</span><br><span class="line">// 程序启动的时候， 初始化这个单例对象name=&quot;init name&quot;</span><br><span class="line">class Sington(name: String)</span><br><span class="line">object Sington &#123;</span><br><span class="line">private var instance = new Sington(&quot;default name&quot;)</span><br><span class="line">val getInstance = instance</span><br><span class="line">def init(name: String) instance.name = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>注意： 从上面的分析可以看到， 闭包中的调用的方法依赖一个Sington的全局对象, 对于普通的本地运行master = local[n]此时的Sington的name为”init name”, 对于集群中运行的时候master = yarn此时Sington的那么为”default name”</p>
</li>
<li><p>分析： 现在通过上面的规则可以非常明显的看出此时Executor中的Sington对象没有被序列化， 为默认值， 所以对于spark而言要非常注意这种序列化问题， 其实规则非常简单， 但是通常会由于对象图谱而造成混乱， 所以通常必须要非常清晰的全局对象。</p>
</li>
<li><p>处理： 更改这个错误也非常简单， 只需要在dataset.filter中直接传入这个Sington对象， 或者只传入它需要的参数就可以， 也就是说将这个单例对象暴露到闭包的可见范围之内， 这样闭包就会被序列化。</p>
</li>
<li><p>缺点： 当然这里非常明显的代码结构发生了变化， 但这也是无赖之举， 也就是说我们一定要缩小闭包的可见范围。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import CacheHelper.cache</span><br><span class="line">dataset.filter&#123;log =&gt;  cache(log ...., Singtong.getInstance.name)&#125;</span><br><span class="line">//将这个Sington暴露到闭包可见范围之内， rdd闭包中使用这个单例中的方法， </span><br><span class="line">object CacheHelper&#123;</span><br><span class="line">cache(log ...., name) &#123;</span><br><span class="line">Sington.name</span><br><span class="line">&#125;&#125;</span><br><span class="line">// 程序启动的时候， 初始化这个单例对象name=&quot;init name&quot;</span><br><span class="line">class Sington(name: String)</span><br><span class="line">object Sington &#123;</span><br><span class="line">private var instance = new Sington(&quot;default name&quot;)</span><br><span class="line">val getInstance = instance</span><br><span class="line">def init(name: String) instance.name = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>pyspark的原理</p>
<ul>
<li><p>使用pyspark启动时，首先会进入python</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PYTHONSTARTUP=&quot;$&#123;SPARK_HOME&#125;/python/pyspark/shell.py&quot;</span><br><span class="line">exec &quot;$&#123;SPARK_HOME&#125;&quot;/bin/spark-submit pyspark-shell-main --name &quot;PySparkShell&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<p><em>说明：</em> <code>PYTHONSTARTUP</code> 是 python 的一个环境变量，当启动python时候，如果这个环境变量存在，那么python启动的时候会调用这个python脚本。而这里的 <code>shell.py</code> 中再次调用 <code>spark-submit</code> 进行启动spark的 <code>PythonGatewayServer</code> ，这样python使用py4j就可以和这个和spark的jvm进行通讯了。接着 <code>shell.py</code> 中创建SparkSession等对象。</p>
</li>
<li><p>pyspark启动后，通常会使用SparkSession对象创建RDD，并最终对RDD进行转换和操作，那么对于RDD的各种python代码的操作是如何进行转换到spark当中的呢？</p>
<ul>
<li>首先对于pyspark中创建的对象与jvm中的对象是一一对应的</li>
<li>其次当使用python闭包时候，python会使用pickle对闭包进行序列化，再当做参数传递给spark</li>
<li>spark在Executor中运行RDD中的compute方法时候，当然是不能运行python代码的，而是在Executor启动一个python虚拟机将RDD的数据传到python虚拟机中，再将结果传回到spark中，spark再将最终计算的结果驱动python虚拟机当中</li>
</ul>
</li>
</ul>
</li>
<li><p>spark 日志查看</p>
<ul>
<li><p>程序还在运行的时候，到想要查看容器对应的服务器中，运行下面命令查看日志存放的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep spark.yarn.app.container.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>程序已经停止运行，此时日志已经被yarn进行聚合到HDFS当中，通常已经压缩，所以一般无法直接查看，只能借助 <code>yarn longs</code> 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn logs -applicationId application_1585056926959_0002 -containerId container_e14_1585056926959_0002_01_000006 -log_files stdout -size -102400 &gt; hello.log</span><br></pre></td></tr></table></figure>
<p><em>说明：</em> size后面使用负数表示查看最后的102400个字节</p>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/hadoop-hortonwork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/hadoop-hortonwork/" itemprop="url">hortonwork的使用以及常见问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T21:18:21+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/hortonwork/" itemprop="url" rel="index">
                    <span itemprop="name">hortonwork</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,149
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>浏览器配置kerberos访问</p>
<ul>
<li><p>firefox中输入 <code>about:config</code>，搜索并设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network.negotiate-auth.trusted-uris = .domain.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>chrome 直接添加命令行参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">google-chrome --auth-server-whitelist=&quot;*.domain.com&quot; --auth-negotiate-delegate-whitelist=&quot;*.domain.com</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>yarn 队列有自己的提交权限策略， 需要配置才能提交任务</p>
<p><code>yarn.scheduler.capacity.root.acl_administer_queue=yarn,spark,hive,admin,zeppelin</code></p>
</li>
<li><p>spark的历史日志查看也需要进行权限设置， 通常关闭</p>
<p><code>spark.history.ui.acls.enable</code></p>
<p>因为日志通常记录在hdfs中， 所以还必须拥有hdfs的文件访问权限</p>
</li>
<li><p>ranger 页面无法登录， 如果显示无法访问DB这是因为使用Mysql的时候必须明确指定是否使用SSL， 所以必须在配置连接的时候使用</p>
<p><code>jdbc:mysql://hdp1.ilivoo.com:3306?useSSL=false</code></p>
<p>curl -H “X-Requested-By:ambari” -u “admin:tepia@2018” -X GET <a href="http://hdp1:8080/api/v1/clusters/c1/credentials/kdc.admin.credential注意：" target="_blank" rel="noopener">http://hdp1:8080/api/v1/clusters/c1/credentials/kdc.admin.credential注意：</a> 任何的报错都应该去查看日志才能精确定位错误，不用假想和凭经验断定。</p>
</li>
<li><p>ambari-server 开启security，删除或添加服务的时候需要</p>
<ul>
<li><p>更改<a href="mailto:admin/admin@TEPIA.COM" target="_blank" rel="noopener">admin/admin@TEPIA.COM</a> 的密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local</span><br><span class="line">change_password admin/admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启ambari-server的security</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ambari-server setup-security</span><br><span class="line">选择[2] Encrypt passwords stored in ambari.properties file.</span><br><span class="line">选择[Y]</span><br><span class="line">keytool -list -keystore /var/lib/ambari-server/keys/credentials.jceks -storetype JCEKS</span><br><span class="line">ambari-server restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加credential</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">添加</span><br><span class="line">curl -H &quot;X-Requested-By:ambari&quot; -u admin:ambari_passwd -X  POST -d &apos;&#123; &quot;Credential&quot; : &#123; &quot;principal&quot; : &quot;admin/admin@TEPIA.COM&quot;, &quot;key&quot; : &quot;admin_princ_passwd&quot;, &quot;type&quot; : &quot;persisted&quot; &#125; &#125;&apos; http://hdp1:8080/api/v1/clusters/tepia/credentials/kdc.admin.credential</span><br><span class="line">查看</span><br><span class="line">curl -H &quot;X-Requested-By:ambari&quot; -u admin:ambari_passwd -X GET http://hdp1:8080/api/v1/clusters/tepia/credentials/kdc.admin.credential</span><br><span class="line">删除</span><br><span class="line">curl -H &quot;X-Requested-By:ambari&quot; -u admin:ambari_passwd -X DELETE http://hdp1:8080/api/v1/clusters/tepia/credentials/kdc.admin.credential</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>ambari 可以运行在非root用户下， 通常来说这样会更安全些，但是需要一些配置，参考 <code>https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.4/securing-credentials/content/secure_credentials_management_overview.html</code>，但是建议还是运行在root用户下，这样更加简单，所有的安全问题也可以参考上面。</p>
<ul>
<li>更改权限 <code>chown -R ambari /var/run/ambari-server</code></li>
<li></li>
</ul>
</li>
<li><p>NameNode UI不能访问, 这是因为服务器存在多个网卡,  默认NameNode默认只是绑定到集群指定的网卡, 并没有绑定到所有的网卡, 所以如果使用了openvpn后, 实际上50070并没有绑定到openvpn指定的网卡, 所以就会导致无法openvpn的网卡无法访问了, 通过指定 <code>hdfs-site.xml</code> 绑定所有网卡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dfs.namenode.http-bind-host=0.0.0.0</span><br><span class="line">dfs.namenode.https-bind-host=0.0.0.0</span><br><span class="line">dfs.namenode.rpc-bind-host=0.0.0.0 </span><br><span class="line">dfs.namenode.servicerpc-bind-host=0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka日志目录必须为空, 对于单独挂载的目录来说通常下来存在 <code>lost+found</code> , 所以必须再加一层目录. </p>
<p>kafka的 <code>zookeeper.connect</code>  应该添加根目录, 这样更加便于管理, 如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connect=cmsw2.tepia.com:2181,cmsw1.tepia.com:2181/kafka</span><br></pre></td></tr></table></figure>
<p>kafka多网卡绑定, 如果仅仅只是绑定某个ip而没有绑定openvpn网卡, 那么同样无法访问, 所以需要配置为 <code>listeners=PLAINTEXT://:6667</code></p>
<p>kerberos kafka需要更改配置为 <code>listeners = SASL_PLAINTEXT://:6667</code></p>
</li>
<li><p>hbase 双网卡绑定问题, 在hbase-site.xml中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hbase.master.ipc.address 0.0.0.0</span><br><span class="line">hbase.regionserver.ipc.address 0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改hadoop运行用户, 通常情况下线上用户和线下用户不是同一个用户,如果 线下调试线上spark程序,需要指定本地为线上用户, 则通过指定环境变量来指定运行用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_USER_NAME=tepia</span><br></pre></td></tr></table></figure>
</li>
<li><p>yarn timeline 两种配置后端存储模式，第一种嵌入式的hbase运行，第二种集群的hbase（推荐），配置如下</p>
<ul>
<li><p>配置基本信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use_external_hbase = true</span><br><span class="line">      hbase.zookeeper.quorum = hdp1.tepia.com,hdp2.tepia.com,hdp3.tepia.com</span><br><span class="line">    hbase.zookeeper.property.clientPort = 2181</span><br><span class="line">      zookeeper.znode.parent = /hbase-secure</span><br><span class="line">      yarn.timeline-service.hbase.configuration.file=</span><br><span class="line">      file:///etc/hbase/conf/hbase-site.xml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<pre><code>  **说明：**最后的一个配置 ` yarn.timeline-service.hbase.configuration.file ` ，hdp的官网并没有说明，如果没有指定配置hbase配置文件，TimelineReader无法连接到hbase。但是yarn官网有提及，从这里也充分的可以感觉到很多答案还得到项目的官网中寻求答案。

- 使用hbase用户创建yarn需要的schema

  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_CLASSPATH_PREFIX=/usr/hdp/3.1.0.0-78/hadoop-yarn/timelineservice/*</span><br><span class="line">  /usr/hdp/3.1.0.0-78/hbase/bin/hbase org.apache.hadoop.yarn.server.timelineservice.storage.TimelineSchemaCreator -Dhbase.client.retries.number=35 -create -s</span><br></pre></td></tr></table></figure>


- 为新添加的表(prod.*)增加权限, 使用基本方式或者ranger     

  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grant &apos;yarn&apos;, &apos;RWXCA&apos;</span><br><span class="line">grant &apos;yarn-ats&apos;, &apos;RWXCA&apos;</span><br></pre></td></tr></table></figure>
</code></pre><ol start="12">
<li><p>尝试使用 yarn 的service服务，可以参考 ats-hbase 这个服务。</p>
</li>
<li><p>ams collector 后端写入模式，如果改为分布式的，只是将hbase的存储放到hdfs当中，而本地还是开启了hbase应用，所以通常情况下不建议更改。如需修改，参考 <code>https://docs.cloudera.com/HDPDocuments/Ambari-2.7.4.0/using-ambari-core-services/content/amb_customize_the_ams_collector_mode.html</code></p>
</li>
<li><p>phoenix 包冲突问题， 由于项目中现在基本上使用logback，但是phoenix中使用log4j并且使用slf4j进行进行桥接，所以解决phoenix包冲突前先应该去掉slf4j和log4j，再更具具体情形进行对比。</p>
</li>
<li><p><code>hdp3.1</code> 中 <code>spark stream</code>  内存占用太高bug修复，通常情况下修复spark bug需要非常仔细。 </p>
<ol>
<li>找准spark 对应的源代码（通过maven源代码）</li>
<li>找准scala版本（查看spark中的pom文件获取）</li>
<li>创建项目拷贝对应源代码， 修改源代码。</li>
<li>获取spark集群中的jar包， 并且备份jar包</li>
<li><p>解压jar包（jar -xf ），并拷贝编译的新的class文件，并重新打包(jar cvfM)</p>
</li>
<li><p>上传新的jar包， 并重启history server</p>
</li>
</ol>
</li>
<li><p>yarn 本地缓存导致jar包冲突</p>
<ol>
<li>查看yarn本地缓存位置 <code>yarn.nodemanager.local-dirs</code></li>
<li><p>删除 <code>rm -rf filecache/ usercache/</code></p>
</li>
<li><p>重启yarn</p>
</li>
</ol>
</li>
<li><p>更改spark history日志自动删除，在 <code>Custom spark-defaults</code> 中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spark.history.fs.cleaner.enabled=true</span><br><span class="line">spark.history.fs.cleaner.interval=1d</span><br><span class="line">spark.history.fs.cleaner.maxAge=7d</span><br></pre></td></tr></table></figure>
<p>手动最近30天的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span> delete 30 day's before spark history logs </span><br><span class="line"><span class="meta">#</span>#######################start ########################</span><br><span class="line">days=30</span><br><span class="line">day_01=`date -d "-$&#123;days&#125; day" +%Y-%m-%d`</span><br><span class="line">echo $day_01</span><br><span class="line"><span class="meta">#</span>running_array=(`yarn application -list | grep application_1 | awk '&#123;print  $1&#125;' &gt; running.log `)</span><br><span class="line"><span class="meta">#</span>running_array=(`more running.log`)</span><br><span class="line">running_array=(`yarn application -list | grep application_1 | awk '&#123;print  $1&#125;' `)</span><br><span class="line">len=$&#123;#running_array[*]&#125;</span><br><span class="line">len=$(($len-1))</span><br><span class="line"></span><br><span class="line">running_string=""</span><br><span class="line">for ((i=0; i&lt; $&#123;#running_array[*]&#125;; i++))</span><br><span class="line">do</span><br><span class="line">if [ $i -lt $len ];then</span><br><span class="line">        running_string+=$&#123;running_array[$i]&#125;"\|"</span><br><span class="line">else</span><br><span class="line">        running_string+=$&#123;running_array[$i]&#125;</span><br><span class="line">fi</span><br><span class="line">done</span><br><span class="line">echo $running_string </span><br><span class="line"><span class="meta">#</span>history_logs_to_delete=(`hdfs dfs -ls /spark2-history/ | grep application_ | grep -v $running_string | awk '&#123;if( $6 &lt; $day_01) print $8&#125;'`)</span><br><span class="line">history_logs_to_delete=(`hdfs dfs -ls /spark2-history/ | grep application_ | grep -v $running_string | awk '&#123;if( $6 lt $day_01) print $8 &#125; ' `)</span><br><span class="line">for ((j=0; j&lt; $&#123;#history_logs_to_delete[*]&#125;; j++))</span><br><span class="line">do</span><br><span class="line">history_logs_str=$&#123;history_logs_to_delete[$j]&#125;</span><br><span class="line">echo "`date +%F\ %T` to delete $j ==$history_logs_str"</span><br><span class="line"><span class="meta">#</span>hdfs dfs -rm -r -f -skipTrash $history_logs_str</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>小集群配置hdfs客户端，防止写入报错，在 <code>hdfs-site</code> 中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dfs.client.block.write.replace-datanode-on-failure.enable=true</span><br><span class="line">dfs.client.block.write.replace-datanode-on-failure.policy=NEVER</span><br></pre></td></tr></table></figure>
</li>
<li><p>yarn 配置shuffle service， 在 <code>yarn-site</code> 和 <code>spark2-defaults</code> 中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark.shuffle.service.port=7337</span><br></pre></td></tr></table></figure>
</li>
<li><p>spark持久化表，写入到spark的catalog当中，由于spark中snappy版本不对导致冲突，可以在启动程序的使用自定义的snappy jar包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-shell --jars snappy-java-1.1.4.jar --conf spark.driver.extraClassPath=snappy-java-1.1.4.jar --conf spark.executor.extraClassPath=snappy-java-1.1.4.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>后续的配置， HDFS、YARN高可用、开启ambari-server的keystore，这样在开启kerberos的时候可以选择记住key，检查hadoop native lib <code>hadoop checknative</code></p>
<ol>
<li><p>错误 <code>Loading ISA-L failed: Failed to load libisal.so.2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc make autoconf automake libtool yasm git</span><br><span class="line">git clone https://github.com/01org/isa-l/</span><br><span class="line">cd isa-l/</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr --libdir=/usr/lib64</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>在配置ambari的时候， 如果使用ambari用户作为ambari的服务启动者， 那么在使用ambari配置的过程中可能经常会出现ambari用户权限不足的情况，所以可能需要如下操作，可以参考hdp官网：</p>
<ol>
<li><p>更改权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R ambari /var/run/ambari-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加sudo操作权限，使用 <code>visudo</code> 添加一行，建议使用完成之后收回权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari  ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>phoenix jar包冲突是一个比较棘手的问题， 使用spark的时候不能直接拷贝phoenix jar包到spark的jars目录中， 而是通过指定 <code>-jars</code>  参数来解决， hive的connector是同样的道理。</p>
</li>
<li><p>kerberos在登录的时候可以直接指定 <code>krb5.conf</code> 文件的位置</p>
<ol>
<li><p>java 程序直接指定环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.security.krb5.conf=/etc/krb5.conf.prod</span><br></pre></td></tr></table></figure>
</li>
<li><p>linux 下 kinit直接添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env KRB5_CONFIG=/etc/krb5.conf.prod kinit -kt /etc/security/keytabs/feng.admin.keytab feng@TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 <code>UserGroupInformation.getCurrentUser</code> 的时候，首先在<code>core-site.xml</code> 中查找是否开启kerberos，如果开启默认情况下会去查找系统是否已经kerberos登录， 主要是通过 krb5.conf 中配置文件的credentials存放位置并进行判断，如： <code>/tmp/krb5cc_1000</code></p>
</li>
<li><p>hadoop可以使用 <code>UserGroupInformation</code> 实现代理机制，真正的用户进行kerberos登录，而代理用户进行真是的操作，如oozie进行提交任务，但是使用普通用户进行HDFS等各种权限，通过设置代理用户<code>HADOOP_PROXY_USER</code></p>
</li>
</ol>
</li>
<li><p>MapReduce在访问kerberos HDFS和HBASE的时候，需要从NameNode和Hbase集群中获分别取代理的Token，并将其写入到Credentials当中，当MapReduce访问这两个组件的时候，就会带着这两个认证信息，从而达到访问的目的，参见 <code>TableMapReduceUtil.initCredentials</code> 方法。</p>
</li>
<li><p>修改 <code>core-site.xml</code> 设置 <code>hadoop.proxyuser.yarn.hosts=*</code> 保证kerberos集群中，spark长时间运行的应用。</p>
</li>
<li><p>hdp重新安装</p>
<ul>
<li><p>使用ambari移除每一个应用</p>
</li>
<li><p>运行脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">hostDomain=tepia.com</span><br><span class="line">master=hdp1.tepia.com</span><br><span class="line">hostList=$(cat /etc/hosts| grep $hostDomain| awk -F' ' '&#123;print $2&#125;')</span><br><span class="line">services="pgsql postgres HDP ambari hadoop hdfs yarn mapred zookeeper tez hive hcatalog webhcat atlas druid zeppelin smartsense storm hbase phoenix spark kafka sqoop oozie infra solr accumulo flume hst knox livy pig ranger activity_analyzer infra-solr yarn-ats"</span><br><span class="line"></span><br><span class="line">for host in $hostList</span><br><span class="line">do</span><br><span class="line">    #检测主机的连通性</span><br><span class="line">    ping -W 1 -c 1 $host|grep "1 received" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -ne 0   ];then</span><br><span class="line">        echo -e "$======&gt;$host is Unreachable,please check '/etc/hosts' file"</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    #停止agent</span><br><span class="line">    ssh $host "ambari-agent stop"</span><br><span class="line">    if [ $host = $master ]; then</span><br><span class="line">        ssh $host "ambari-server stop"</span><br><span class="line">        ssh $host "ambari-server reset"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo "$host start deleting... \n"</span><br><span class="line">    #repo</span><br><span class="line">    #ssh $host "rm -rf /etc/yum.repos.d/hdp.repo"</span><br><span class="line">    #ssh $host "rm -rf /etc/yum.repos.d/HDP*"</span><br><span class="line">    #ssh $host "rm -rf /etc/yum.repos.d/ambari.repo"</span><br><span class="line">    </span><br><span class="line">    # 删除相关用户</span><br><span class="line">    ssh $host "python /usr/lib/ambari-agent/lib/ambari_agent/HostCleanup.py --silent"</span><br><span class="line">    postgres mysql admin</span><br><span class="line"></span><br><span class="line">    # 删除服务相关信息</span><br><span class="line">    for ser in $services</span><br><span class="line">    do</span><br><span class="line">        #删除安装软件</span><br><span class="line">        packageList=$(ssh $host "yum list installed | grep $ser | cut -d ' ' -f 1")</span><br><span class="line">        for package in $packageList</span><br><span class="line">        do</span><br><span class="line">            echo "uninstalling $package"</span><br><span class="line">            ssh $host "yum remove -y $package"</span><br><span class="line">        done</span><br><span class="line">        #删除文件</span><br><span class="line">        ssh $host "rm -rf /etc/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /etc/alternatives/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /usr/bin/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /usr/sbin/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/log/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/run/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/lib/$&#123;ser&#125;*"</span><br><span class="line">        #删除用户</span><br><span class="line">        ssh $host "userdel -r $&#123;ser&#125;"</span><br><span class="line">        ssh $host "groupdel $&#123;ser&#125;"</span><br><span class="line">        #根据需要删除的文件, 加上查找的目录，通常已经不用。也可以使用locate命令更快(先安装mlocate,再更新locate数据库updatedb)</span><br><span class="line">        #ssh $host "find / -name $&#123;ser&#125; &gt;&gt; /root/del_files.log"</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    # 删除hadoop文件夹，包括HDFS数据</span><br><span class="line">    ssh $host "rm -rf /hadoop"</span><br><span class="line">    ssh $host "rm -rf /home/data" </span><br><span class="line">    ssh $host "rm -rf /usr/hdp"</span><br><span class="line"></span><br><span class="line">    # 删除kerberos</span><br><span class="line">    ssh $host "rm -rf /etc/security/keytabs/*"</span><br><span class="line">    </span><br><span class="line">    # 删除临时文件</span><br><span class="line">    ssh $host "rm -rf /tmp/*"</span><br><span class="line"></span><br><span class="line">    ssh $host "yum clean all"</span><br><span class="line"></span><br><span class="line">    echo "$host delete is done! \n"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除mysql中的数据库，并重新创建。注意其中有些用户是需要设置为特定主机的。</p>
</li>
<li><p>kerberos的数据库也要删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kdb5_util destroy TEPIA.COM</span><br><span class="line">kdb5_util create -s -r TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>nifi 开启SSL，nifi 自带 NiFi Certificate Authority 授权程序，不推荐使用，直接选择独立安装即可</p>
<ul>
<li><p>首先按照正常方式添加nifi服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nifi.allow.explicit.keytab = false</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入ranger plugin页面关闭nifi，并重启nifi（先关闭ranger认证，后期按需添加）</p>
</li>
<li><p>进入nifi-toolkit中，生成nifi认证文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/tls-toolkit.sh standalone -n &quot;hdp1.tepia.com,hdp2.tepia.com,hdp3.tepia.com&quot; --nifiDnPrefix &quot;CN=&quot; --nifiDnSuffix &quot;, OU=TEPIA.COM&quot; -d 10950 -C &quot;CN=feng, OU=TEPIA.COM&quot; -f ../nifi/conf/nifi.properties -o nifi -K admin123 -P admin123 -S admin123 -B admin123</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制生成的 <code>keystore.jks</code> 和 <code>truststore.jks</code> 到nifi中的conf目录中</p>
</li>
<li><p>修改nifi配置文件 <code>nifi-ambari-ssl-config</code> 中如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Initial Admin Identity = feng@TEPIA.COM</span><br><span class="line">Enable SSL? = true</span><br><span class="line">Key password = pass</span><br><span class="line">Keystore password = pass</span><br><span class="line">Truststore password = pass</span><br><span class="line">Keystore type = jks</span><br><span class="line">Truststore type = jks</span><br><span class="line">NiFi CA DN suffix = , OU=TEPIA.COM</span><br><span class="line">Node Identities = </span><br><span class="line">	&lt;property name=&quot;Node Identity 1&quot;&gt;CN=hdp1.tepia.com, OU=TEPIA.COM&lt;/property&gt;</span><br><span class="line">	&lt;property name=&quot;Node Identity 2&quot;&gt;CN=hdp2.tepia.com, OU=TEPIA.COM&lt;/property&gt;</span><br><span class="line">	&lt;property name=&quot;Node Identity 3&quot;&gt;CN=hdp3.tepia.com, OU=TEPIA.COM&lt;/property&gt; </span><br><span class="line">nifi.security.identity.mapping.pattern.dn = ^CN=(.*?), OU=(.*?)$</span><br><span class="line">nifi.security.identity.mapping.pattern.kerb = ^(.*?)@(.*?)$</span><br><span class="line">nifi.security.identity.mapping.value.dn = $1@$2</span><br><span class="line">nifi.security.identity.mapping.value.kerb = $1@$2</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>配置 Node Identities 时候，注意 <code>, OU</code> 中间的空格</p>
</li>
<li><p>重启nifi，注意authorizations.xml必须没有策略，可以直接删掉 <code>/var/lib/nifi/conf</code> 下的authorizations.xml和users.xml文件。</p>
</li>
<li><p>将p12证书导入到浏览器当中，此时就可以进入nifi中，如果此时报如下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot replicate request to Node hdp2.tepia.com:9090 because the node is not connected</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>这不是认证的错误，而是集群从不安全切换到安全集群的时候，集群状态的文件，此时需要删除 <code>/var/lib/nifi/conf</code> 下的authorizations.xml和users.xml文件，并重新启动nifi，如果实在不行就直接删除 <code>/var/lib/nifi/*</code> 再次重启，每次重启必须保证 <code>/var/lib/nifi/conf</code> 下没有authorizations.xml和users.xml 这两个文件</p>
</li>
</ul>
</li>
<li><p>nifi开启SSL并使用ranger进行权限管理</p>
<ul>
<li><p>首先按照正常方式添加nifi服务，不需要添加NiFi Certificate Authority 授权程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nifi.allow.explicit.keytab = false</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入nifi-toolkit中，生成nifi认证文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/tls-toolkit.sh standalone -n &quot;hdp1.tepia.com,hdp2.tepia.com,hdp3.tepia.com&quot; --nifiDnPrefix &quot;CN=&quot; --nifiDnSuffix &quot;, OU=TEPIA.COM&quot; -d 10950 -C &quot;CN=feng, OU=TEPIA.COM&quot; -f ../nifi/conf/nifi.properties -o nifi -K admin123 -P admin123 -S admin123 -B admin123</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制生成的 <code>keystore.jks</code> 和 <code>truststore.jks</code> 到nifi中的conf目录中</p>
</li>
<li><p>修改nifi配置文件 <code>nifi-ambari-ssl-config</code> 中如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Enable SSL? = true</span><br><span class="line">Key password = pass</span><br><span class="line">Keystore password = pass</span><br><span class="line">Truststore password = pass</span><br><span class="line">Keystore type = jks</span><br><span class="line">Truststore type = jks</span><br><span class="line">NiFi CA DN suffix = , OU=TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>Advanced nifi-authorizers-env</code> 中如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;Ranger Admin Identity&quot;&gt;CN=feng, OU=TEPIA.COM&lt;/property&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>Advanced nifi-properties</code> 中的配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nifi.remote.input.socket.port = 1026</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>Advanced ranger-nifi-plugin-properties</code> 中的配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Authentication = SSL</span><br><span class="line">Keystore for Ranger Service Accessing NiFi = /usr/hdf/current/nifi-toolkit/nifi/keystore.jks</span><br><span class="line">Keystore Type = jks</span><br><span class="line">Truststore for Ranger Service Accessing NiFi = /usr/hdf/current/nifi-toolkit/nifi/truststore.jks</span><br><span class="line">Truststore Type = jks</span><br><span class="line">Owner for Certificate = CN=feng, OU=TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改ranger web配置页面中的 <code>tepia_nifi</code> ，让其能够连接到nifi中，并对nifi进行权限控制，配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NiFi URL = https://hdp2.tepia.com:9091/nifi-api/resources</span><br><span class="line">Authentication Type = SSL</span><br><span class="line">Keystore = /home/ranger/keystore.jks</span><br><span class="line">Keystore Type = jks</span><br><span class="line">Keystore Password = keypass</span><br><span class="line">Truststore = /home/ranger/truststore.jks</span><br><span class="line">Truststore Password = trustpass</span><br><span class="line">commonNameForCertificate = CN=feng, OU=TEPIA.COM</span><br><span class="line">tag.download.auth.users = nifi</span><br><span class="line">policy.download.auth.users = nifi</span><br><span class="line">ambari.service.check.user = nifi</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ul>
<li><p>需要测试直至连接成功，连接的过程中可能需要先添加权限，并且此时可以看ranger的access访问</p>
</li>
<li><p>此处的keystore 和 truststore是通过 <code>tls-toolkit.sh</code> 生成的客户端秘钥和证书，但生成的是 <code>CN=feng_OU=TEPIA.COM.p12</code> 文件，需要转换成jks文件，并加入服务端证书到客户端truststore中。</p>
<ul>
<li><p>转换p12证书为jks的keystone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -srckeystore CN\=feng_OU\=TEPIA.COM.p12 -srcstoretype pkcs12 -destkeystore keystore.jks -deststoretype jks</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<pre><code>    - 导出 `hdp1.tepia.com, hdp2.tepia.com, hdp3.tepia.com` 的证书

      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keytool -export -alias  nifi-key -keystore hdp1.tepia.com/keystore.jks -rfc -file hdp1.cer</span><br><span class="line">keytool -export -alias  nifi-key -keystore hdp2.tepia.com/keystore.jks -rfc -file hdp2.cer</span><br><span class="line">keytool -export -alias  nifi-key -keystore hdp3.tepia.com/keystore.jks -rfc -file hdp3.cer</span><br></pre></td></tr></table></figure>


    - 将三个证书导入到truststore中

      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -alias feng  -file hdp1.cer  -keystore truststore.jks</span><br><span class="line">keytool -import -alias feng  -file hdp2.cer  -keystore truststore.jks</span><br><span class="line">keytool -import -alias feng  -file hdp3.cer  -keystore truststore.jks</span><br></pre></td></tr></table></figure>


    - 注意我们这里ranger连接nifi直接使用了，自动生产的客户端的证书，所以我们并不需要将客户端证书导入到nifi中，这是因为 `tls-toolkit.sh` 已经自动导入过了，所以如果我们需要使用不同的用户名，需要自行证书导入即可。

- 修改ranger web配置页面，添加权限，不存在的用户需要在ranger中添加用户

  - 添加all权限到 `CN=feng, OU=TEPIA.COM` 账号

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flow /system /controller /counters /provenance /policies /tenants /proxy /resources /site-to-site /restricted-components / /*</span><br></pre></td></tr></table></figure>


  - 添加proxy权限到 `hdp1.tepia.com,hep2.tepia.com,hdp3.tepia.com` 当中

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy /data/* /*</span><br></pre></td></tr></table></figure>
</code></pre>
          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my-icon.jpeg"
                alt="ilivoo" />
            
              <p class="site-author-name" itemprop="name">ilivoo</p>
              <p class="site-description motion-element" itemprop="description">我，在這裡，享受等你的時光。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ilivoo</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/lib/clipboard/clipboard.js"></script>
<script type="text/javascript" src="/js/src/custom.js"></script>

</body>
</html>
