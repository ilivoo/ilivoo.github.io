<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Ilivoo`s blog" type="application/atom+xml" />






<meta name="description" content="我，在這裡，享受等你的時光。">
<meta property="og:type" content="website">
<meta property="og:title" content="Ilivoo`s blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Ilivoo`s blog">
<meta property="og:description" content="我，在這裡，享受等你的時光。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ilivoo`s blog">
<meta name="twitter:description" content="我，在這裡，享受等你的時光。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Ilivoo`s blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ilivoo`s blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/linux-shadowsocket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/linux-shadowsocket/" itemprop="url">Shadowsocks代理和全局代理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-28T16:20:39+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,678
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="proxychain"><a href="#proxychain" class="headerlink" title="proxychain"></a>proxychain</h4><ol>
<li>安装proxychain， 也可以直接使用apt安装 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rofl0r/proxychains-ng.git</span><br><span class="line">cd proxychains-ng</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cp ./src/proxychains.conf /etc/proxychains.conf</span><br><span class="line">cd .. &amp;&amp; rm -rf proxychains-ng</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li>配置proxychain <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/proxychains.conf</span><br><span class="line"># 将socks4 127.0.0.1 9095改为</span><br><span class="line">socks5 127.0.0.1 1080 //1080改为你自己的端口</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>使用proxychain</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains chrome #在需要进行代理的程序前加proxychains</span><br></pre></td></tr></table></figure>
<p> 确保本地的代理已经打开</p>
</li>
<li><p>如果proxychains不能启动某个程序，可以使用下面方式使得程序使用sockets代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chromium-browser --proxy-server=&quot;socks5://127.0.0.1:1080&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="shadowsocks-客户端"><a href="#shadowsocks-客户端" class="headerlink" title="shadowsocks 客户端"></a>shadowsocks 客户端</h4><ol>
<li><p>安装混淆工具 <a href="https://github.com/shadowsocks/simple-obfs" target="_blank" rel="noopener">https://github.com/shadowsocks/simple-obfs</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Debian / Ubuntu</span><br><span class="line">sudo apt-get install --no-install-recommends build-essential autoconf libtool libssl-dev libpcre3-dev libev-dev asciidoc xmlto automake</span><br><span class="line"></span><br><span class="line">git clone https://github.com/shadowsocks/simple-obfs.git</span><br><span class="line">cd simple-obfs</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure &amp;&amp; make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动obfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obfs-local -s 服务端ip -p 服务端端口号 -l 9996 --obfs http --obfs-host www.ilivoo.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>可选kcptun, 安装方式服务端安装时候会给出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo ./client_linux_amd64 -c config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;localaddr&quot;: &quot;:11443&quot;, #此处端口可以更改</span><br><span class="line">  &quot;remoteaddr&quot;: &quot;kcptun服务器地址:kcp服务器端口&quot;,</span><br><span class="line">  &quot;key&quot;: &quot;kcptun密码&quot;,</span><br><span class="line">  &quot;crypt&quot;: &quot;none&quot;,</span><br><span class="line">  &quot;mode&quot;: &quot;fast2&quot;,</span><br><span class="line">  &quot;mtu&quot;: 1350,</span><br><span class="line">  &quot;sndwnd&quot;: 1024,</span><br><span class="line">  &quot;rcvwnd&quot;: 1024,</span><br><span class="line">  &quot;datashard&quot;: 10,</span><br><span class="line">  &quot;parityshard&quot;: 3,</span><br><span class="line">  &quot;dscp&quot;: 0,</span><br><span class="line">  &quot;nocomp&quot;: false,</span><br><span class="line">  &quot;quiet&quot;: false,</span><br><span class="line">  &quot;tcp&quot;: false,</span><br><span class="line">  &quot;acknodelay&quot;: false,</span><br><span class="line">  &quot;sockbuf&quot;: 4194304,</span><br><span class="line">  &quot;smuxbuf&quot;: 4194304,</span><br><span class="line">  &quot;keepalive&quot;: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装最新shadowsocks, apt直接安装可能版本太低无法支持更多的加密算法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-pip</span><br><span class="line">sudo pip install https://github.com/shadowsocks/shadowsocks/archive/master.zip -U</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置shadowsocks</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/shadowsocks.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;server_port&quot;:9996,</span><br><span class="line">    &quot;local_address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;password&quot;:&quot;密码&quot;,</span><br><span class="line">    &quot;timeout&quot;:300,</span><br><span class="line">    &quot;method&quot;:&quot;chacha20-ietf-poly1305&quot;,</span><br><span class="line">    &quot;fast_open&quot;: false,  #需要服务端开启</span><br><span class="line">    &quot;workers&quot;: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动shadowsocks， 可以直接配置成开机启动启动</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sslocal -c /etc/shadowsocks.json</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="SwitchyOmega"><a href="#SwitchyOmega" class="headerlink" title="SwitchyOmega"></a>SwitchyOmega</h4><ol>
<li>安装SwitchyOmega， chrome如果没有代理可能无法访问商店， 可以开启shadowsocks并使用proxychain代理chrome再安装，或者直接百度搜索SwitchyOmega离线安装。</li>
<li>配置SwitchyOmega <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/FelisCatus/SwitchyOmega/wiki/GFWList</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="shadowsocks服务端搭建"><a href="#shadowsocks服务端搭建" class="headerlink" title="shadowsocks服务端搭建"></a>shadowsocks服务端搭建</h4><ol>
<li><p>建议使用搬瓦工， 并选择手机运营商对应的直连机房</p>
</li>
<li><p>安装步骤：</p>
<ol>
<li>安装Centos 7 x86_64 bbr 使用谷歌网络优化技术</li>
<li>安装shadowsocks<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install wget</span><br><span class="line">wget --no-check-certificate -O shadowsocks-all.sh https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks-all.sh</span><br><span class="line">chmod +x shadowsocks-all.sh</span><br><span class="line">./shadowsocks-all.sh 2&gt;&amp;1 | tee shadowsocks-all.log</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<pre><code>**安装选择：**

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 安装语言版本 Shadowsocks-libev</span><br><span class="line">2. 密码</span><br><span class="line">3. 端口 443</span><br><span class="line">4. 选择加密算法 chacha20-ietf-poly1305</span><br><span class="line">4. 开启obfs混淆 yes</span><br><span class="line">5. 选择混淆协议 http</span><br></pre></td></tr></table></figure>
</code></pre><ol start="3">
<li><p>开启kcptun加速(可选)</p>
<p> 脚本地址 <code>https://github.com/kuoruan/shell-scripts</code></p>
<p> kcptun地址 <code>https://github.com/xtaci/kcptun</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -O kcptun.sh https://github.com/kuoruan/shell-scripts/raw/master/kcptun/kcptun.sh</span><br><span class="line">sh kcptun.sh</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>安装选择:

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 选择kcptun服务端绑定的端口, 需要对外暴露</span><br><span class="line">2. 选择kcptun转发的IP地址, 此处默认127.0.0.1就可以, 因为kcptun还可以转发到其它服务器</span><br><span class="line">3. 选择kcptun转发的端口号, 此处设置上面obfs的端口号</span><br><span class="line">4. 剩下的就是密码等设置, 自行设置就好, 建议mode设置为fast2, 加密为none</span><br><span class="line">5. 设置好之后会打印出客户端下载地址和客户端配置, 下载客户端并配置设置客户端配置文件, 客户端的localaddr可以自行修改, 后面客户端的obfs会指向这个端口</span><br></pre></td></tr></table></figure>
</code></pre><ol start="4">
<li><p>优化,参照<a href="https://github.com/shadowsocks/shadowsocks/wiki/TCP-Fast-Open：" target="_blank" rel="noopener">https://github.com/shadowsocks/shadowsocks/wiki/TCP-Fast-Open：</a></p>
<ol>
<li><p>服务端优化tcp_fastopen</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;server_port&quot;:443,</span><br><span class="line">    &quot;password&quot;:&quot;密码&quot;,</span><br><span class="line">    &quot;timeout&quot;:300,</span><br><span class="line">    &quot;user&quot;:&quot;nobody&quot;,</span><br><span class="line">    &quot;method&quot;:&quot;chacha20-ietf-poly1305&quot;,</span><br><span class="line">    &quot;fast_open&quot;:false,</span><br><span class="line">    &quot;nameserver&quot;:&quot;8.8.8.8&quot;,</span><br><span class="line">    &quot;mode&quot;:&quot;tcp_and_udp&quot;,</span><br><span class="line">    &quot;plugin&quot;:&quot;obfs-server&quot;,</span><br><span class="line">    &quot;plugin_opts&quot;:&quot;obfs=http&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端系统开启bbr 和 tcp_fastopen, 搬瓦工选择bbr镜像默认已经开启</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#创建文件</span><br><span class="line">vi /etc/sysctl.d/local.conf</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 配置如下</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br><span class="line"></span><br><span class="line">net.ipv4.neigh.default.base_reachable_time_ms = 600000</span><br><span class="line">net.ipv4.neigh.default.mcast_solicit = 20</span><br><span class="line">net.ipv4.neigh.default.retrans_time_ms = 250</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line">net.ipv4.conf.eth0.rp_filter=0</span><br><span class="line">net.ipv4.conf.eth1.rp_filter=0</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#启动</span><br><span class="line">    sysctl --system</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端系统开启tcp_fastopen</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 当前生效</span><br><span class="line">echo 3 &gt; /proc/sys/net/ipv4/tcp_fastopen</span><br><span class="line"># 永久生效,在/etc/sysctl.conf中添加</span><br><span class="line">net.ipv4.tcp_fastopen = 3</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="全局代理设置"><a href="#全局代理设置" class="headerlink" title="全局代理设置"></a>全局代理设置</h4><ol>
<li>先需要安装genpac工具（基于gfwlist的代理自动配置(Proxy Auto-config)文件生成工具，支持自定义规则， chrome的代理也是使用这种。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install genpac</span><br><span class="line">mkdir -p ~/opt/autoproxy &amp;&amp; cd sudo pip install genpac</span><br><span class="line">genpac --pac-proxy &quot;SOCKS5 127.0.0.1:1080&quot; --gfwlist-proxy=&quot;SOCKS5 127.0.0.1:1080&quot; --gfwlist-url=https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt --output=&quot;autoproxy.pac&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>配置系统代理，成功之后会在该目录下生成一个autoproxy.pac文件。然后打开System Settings-&gt;Hardware-&gt;Network-&gt;Network proxy，<br>将Method设置为Automatic，然后Configuration URL中填写autoproxy.pac文件路径</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///home/feng/opt/autoproxy/autoproxy.pac</span><br></pre></td></tr></table></figure>
<p> 注意： 安装完之后此时使用浏览器就可以进行使用全局代理了</p>
</li>
</ol>
<h4 id="启动http、https、ftp代理"><a href="#启动http、https、ftp代理" class="headerlink" title="启动http、https、ftp代理"></a>启动http、https、ftp代理</h4><ol>
<li><p>设置命令行下所有的其它程序使用socks代理，安装一个privoxy代理工具，实现终端内socks5转换为http/https，进而将http/https请求转发<br>给ss，实现终端内的代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install privoxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置/etc/privoxy/config文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#保证存在下面两行存在, forward-socks5t 如果不行就改成 forward-socks5 </span><br><span class="line">listen-address localhost:8118</span><br><span class="line">forward-socks5t / 127.0.0.1:1080 .</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置/etc/profile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在末尾添加以下三行：</span><br><span class="line">export http_proxy=http://127.0.0.1:8118</span><br><span class="line">export https_proxy=http://127.0.0.1:8118</span><br><span class="line">export ftp_proxy=http://127.0.0.1:8118 #ftp的代理可以根据需要添加</span><br></pre></td></tr></table></figure>
<p>注意： source /etc/profile</p>
</li>
<li><p>启动privoxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo privoxy --user privoxy /etc/privoxy/config</span><br></pre></td></tr></table></figure>
<p>注意：之后每次修改了配置文件后，都要执行sudo service privoxy restart来重启服务</p>
</li>
</ol>
<h4 id="ubuntu18-04-关闭systemd-resolved-service服务"><a href="#ubuntu18-04-关闭systemd-resolved-service服务" class="headerlink" title="ubuntu18.04 关闭systemd-resolved.service服务"></a>ubuntu18.04 关闭systemd-resolved.service服务</h4><ol>
<li><p>关闭服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl disable systemd-resolved</span><br><span class="line">sudo systemctl stop systemd-resolved</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改添加配置文件 <code>/etc/NetworkManager/NetworkManager.conf</code> 中 main 选择</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns=default</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除 <code>rm /etc/resolv.conf</code> 使其重新生成</p>
</li>
<li><p>重启网络服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart NetworkManager</span><br></pre></td></tr></table></figure>
</li>
<li><p>ubuntu 上dns是一个比较复杂的问题， 还是推荐使用系统默认的 <code>systemd-resolved</code> 来进行dns解析，因为它有缓存功能。如果发现网络的DNS不能解析， 直接在网络哪里更改DNS即可， 并重启网络。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-resolve --status 查看当前DNS情况</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/25/python-re/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/25/python-re/" itemprop="url">python 正则表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-25T17:58:28+08:00">
                2018-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/正则表达式/" itemprop="url" rel="index">
                    <span itemprop="name">正则表达式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,125
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h5><ol>
<li><p>正则表达式是一种用来匹配字符串的强有力的武器。它的设计思想是用一种描述性的语言来给字符串定义一个规则，凡是符合规则的字符串，我们就认为它“匹配”了，否则，该字符串就是不合法的。</p>
</li>
<li><p>正则表达式的强大之处在于引入特殊字符来定义字符集、字符集位置、匹配子组、重复模式和扩展表示法。</p>
</li>
</ol>
<h5 id="字符集定义"><a href="#字符集定义" class="headerlink" title="字符集定义:"></a>字符集定义:</h5><table>
<thead>
<tr>
<th>符号</th>
<th>描述</th>
<th>正则表达式</th>
<th>匹配案例</th>
</tr>
</thead>
<tbody>
<tr>
<td>literal</td>
<td>匹配字符串的字面值</td>
<td>foo</td>
<td>foo  </td>
</tr>
<tr>
<td>re1&#124;re2</td>
<td>匹配正则表达式re1或者re2</td>
<td>foo&#124;bar</td>
<td>foo或者bar</td>
</tr>
<tr>
<td>.</td>
<td>匹配任何字符(除了\n之外)</td>
<td>b.b</td>
<td>bab</td>
</tr>
<tr>
<td>[…]</td>
<td>匹配来自字符集的任意单个字符</td>
<td>[aeiou]</td>
<td>a</td>
</tr>
<tr>
<td>[^…]</td>
<td>匹配非来自字符集的任何单个字符</td>
<td>[^aeiou]</td>
<td>0</td>
</tr>
<tr>
<td>[x-ym-n]</td>
<td>匹配任意来自x~y和m~n范围内的单个字符</td>
<td>[A-Za-z]</td>
<td>b</td>
</tr>
<tr>
<td>\d</td>
<td>匹配任何十进制数字，与[0-9]相同(与\D相反)</td>
<td>data\d.txt</td>
<td>data1.txt</td>
</tr>
<tr>
<td>\w</td>
<td>匹配字母数字数字字符,与[A-Za-z0-9]相同(与\w相反)</td>
<td>data\w.txt</td>
<td>dataa.txt</td>
</tr>
<tr>
<td>\s</td>
<td>匹配任何空格字符, 与[\n\t\r\v\f]相同(与\S相反)</td>
<td>of\sthe</td>
<td>of the</td>
</tr>
<tr>
<td>\x</td>
<td>对特殊字符进行转移</td>
<td>\.</td>
<td>.</td>
</tr>
</tbody>
</table>
<h5 id="字符集位置："><a href="#字符集位置：" class="headerlink" title="字符集位置："></a>字符集位置：</h5><table>
<thead>
<tr>
<th>符号</th>
<th>描述</th>
<th>正则表达式</th>
<th>匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td>^</td>
<td>匹配字符串起始位置</td>
<td>^Dear</td>
<td>Dear  </td>
</tr>
<tr>
<td>$</td>
<td>匹配字符串终止位置</td>
<td>/bin/*sh$</td>
<td>/bin/bash  </td>
</tr>
<tr>
<td>\A(\Z)</td>
<td>匹配字符串起始(结束)位置</td>
<td>\ADear</td>
<td>Dear</td>
</tr>
<tr>
<td>\b</td>
<td>匹配任何单词边界(与\S相反)</td>
<td>\bthe\b</td>
<td>the</td>
</tr>
</tbody>
</table>
<h5 id="重复模式："><a href="#重复模式：" class="headerlink" title="重复模式："></a>重复模式：</h5><table>
<thead>
<tr>
<th>符号</th>
<th>描述</th>
<th>正则表达式</th>
<th>匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>匹配０次或者多次</td>
<td>[A-Za-z0-9]*</td>
<td>abcde</td>
</tr>
<tr>
<td>+</td>
<td>匹配１次或者多次</td>
<td>[a-z]+.com</td>
<td>baidu.com</td>
</tr>
<tr>
<td>?</td>
<td>匹配０次或者多次</td>
<td>goo?</td>
<td>go</td>
</tr>
<tr>
<td>{N}</td>
<td>精确匹配Ｎ次</td>
<td>[0-9]3</td>
<td>333</td>
</tr>
<tr>
<td>{M,N}</td>
<td>匹配M~N次</td>
<td>[0-9]{5,9}</td>
<td>123456  </td>
</tr>
<tr>
<td>(*&#124;+&#124;?&#124;{})</td>
<td>匹配上面重复出现的非贪婪版本</td>
<td>.*?[a-z]</td>
<td>abcc</td>
</tr>
</tbody>
</table>
<h5 id="匹配子组："><a href="#匹配子组：" class="headerlink" title="匹配子组："></a>匹配子组：</h5><table>
<thead>
<tr>
<th>符号</th>
<th>描述</th>
<th>正则表达式</th>
<th>匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td>(…)</td>
<td>匹配封闭的正则表达式，　然后另存为子组</td>
<td>([0-9]{3}-)?[0-9]{7-8}</td>
<td>020-888888</td>
</tr>
<tr>
<td>\N</td>
<td>配皮上面已经保存的分组</td>
<td>([0-9]{3})-(\d{7-8}) post is \1</td>
<td>020-12345678 post is 020</td>
</tr>
</tbody>
</table>
<h5 id="扩展表示法："><a href="#扩展表示法：" class="headerlink" title="扩展表示法："></a>扩展表示法：</h5><table>
<thead>
<tr>
<th>符号</th>
<th>描述</th>
<th>正则表达式</th>
<th>匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="贪婪模式"><a href="#贪婪模式" class="headerlink" title="贪婪模式"></a>贪婪模式</h5><p>正则表达式的默认为贪婪模式，表示竟可能多的匹配，　非贪婪是如果后面正则表达式能够匹配则尽可能少的匹配，　给后面表达式匹配的机会，　如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; re.match(r&apos;^(\d+)(0*)$&apos;, &apos;102300&apos;).groups() #贪婪</span><br><span class="line">(&apos;102300&apos;, &apos;&apos;)</span><br><span class="line">&gt;&gt;&gt; re.match(r&apos;^(\d+?)(0*)$&apos;, &apos;102300&apos;).groups() #非贪婪</span><br><span class="line">(&apos;1023&apos;, &apos;00&apos;)</span><br></pre></td></tr></table></figure></p>
<h5 id="re-模块"><a href="#re-模块" class="headerlink" title="re 模块"></a>re 模块</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">基础方法</span><br><span class="line">compile(pattern, flags = 0) 用任何可选的标记来编译正则表达式，然后返回正则表达式对象</span><br><span class="line">match(pattern, string, flags = 0) 尝试使用带可选标记的正则表达式的模式来匹配字符串，如果匹配成功返回匹配对象，否则返回None</span><br><span class="line">search(patter, string, flags = 0) 使用可选的标记搜索字符串中第一次出现正则表达式模式，如果匹配成功返回匹配对象，否则返回None，search是逐个逐个字符的往下匹配</span><br><span class="line">findall/finditer(pattern, string[,flags]) 查找字符串中所有(非重复)出现的正则表达式模式，并返回匹配列表</span><br><span class="line">split(pattern, string, max = 0) 使用正则表达式分割模式分割字符串，并返回最大max次操作的列表</span><br><span class="line">sub(pattern, repl, string, count = 0) 使用repl替换正则表达式的模式在字符串中出现的位置，除非定义count，否则替换所有的位置</span><br><span class="line">purge()　清楚隐式编译的正则表达式模式</span><br><span class="line"></span><br><span class="line">标记</span><br><span class="line">re.I | re.IGNORECASE    不区分大小写匹配</span><br><span class="line">re.L | re.Locale        根据所使用的本地语言环境通过\w、\W、\b、\B、\s、\S实现匹配</span><br><span class="line">re.M | re.MULTILINE     ^和$分别匹配目标字符串中行的起始和结束，而不是严格匹配整个字符串本身的起始和结尾</span><br><span class="line">re.S | re.DOTALL        .号可以匹配所有的字符，包括\n</span><br><span class="line">re.X | re.VERBOSE       所有的空格加上#都会被忽略</span><br><span class="line">re.T | re.TEMPLATE      ...</span><br><span class="line"></span><br><span class="line">匹配对象的方法</span><br><span class="line">group(num = 0)          返回整个匹配对象或者编号为num的特定子组</span><br><span class="line">groups(default = None)    返回包含所有匹配子组的元组</span><br><span class="line">groupdict(defalt = None)    返回包含所有匹配子组的字典，子组名称作为键</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/25/python-help/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/25/python-help/" itemprop="url">python 帮助命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-25T17:46:18+08:00">
                2018-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/帮助/" itemprop="url" rel="index">
                    <span itemprop="name">帮助</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  311
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="获取内建信息"><a href="#获取内建信息" class="headerlink" title="获取内建信息"></a>获取内建信息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dir()                   打印当前scope</span><br><span class="line">dir(__builtins__)       打印内建scope</span><br><span class="line">dir(object)             打印对象scope</span><br></pre></td></tr></table></figure>
<h4 id="获取帮助"><a href="#获取帮助" class="headerlink" title="获取帮助"></a>获取帮助</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help(object)</span><br></pre></td></tr></table></figure>
<h4 id="获取类继承层次"><a href="#获取类继承层次" class="headerlink" title="获取类继承层次"></a>获取类继承层次</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.mro()             此方法是type中的方法， 每个Class都是type的实例</span><br></pre></td></tr></table></figure>
<h4 id="获取所有的模块"><a href="#获取所有的模块" class="headerlink" title="获取所有的模块"></a>获取所有的模块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help(<span class="string">'modules'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="判断对象类型"><a href="#判断对象类型" class="headerlink" title="判断对象类型"></a>判断对象类型</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> types</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(<span class="string">'abc'</span>)==types.StringType</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(<span class="string">u'abc'</span>)==types.UnicodeType</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type([])==types.ListType</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(str)==types.TypeType</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<h4 id="获取对象中的常量"><a href="#获取对象中的常量" class="headerlink" title="获取对象中的常量"></a>获取对象中的常量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line">base_type = (types.BooleanType, types.FloatType, types.IntType, types.LongType, types.NoneType,</span><br><span class="line">types.StringType, types.TupleType, types.ListType, types.DictType, types.ComplexType)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_ck</span><span class="params">(obj)</span>:</span></span><br><span class="line">    _constant = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> obj.__dict__.iteritems():</span><br><span class="line">        <span class="keyword">if</span> type(value) <span class="keyword">in</span> base_type:</span><br><span class="line">            _constant[key] = value</span><br><span class="line">    <span class="keyword">print</span> sorted(_constant.keys())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_ok</span><span class="params">(obj)</span>:</span></span><br><span class="line">    _object = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> obj.__dict__.iteritems():</span><br><span class="line">        <span class="keyword">if</span> type(value) <span class="keyword">not</span> <span class="keyword">in</span> base_type:</span><br><span class="line">            _object[key] = value</span><br><span class="line">    <span class="keyword">print</span> sorted(_object.keys())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_c</span><span class="params">(obj)</span>:</span></span><br><span class="line">    _constant = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> obj.__dict__.iteritems():</span><br><span class="line">        <span class="keyword">if</span> type(value) <span class="keyword">in</span> base_type:</span><br><span class="line">            _constant[key] = value</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sorted(_constant.keys()):</span><br><span class="line">        <span class="keyword">print</span> key + <span class="string">"\t = \t"</span> + _constant.get(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_o</span><span class="params">(obj)</span>:</span></span><br><span class="line">    _object = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> obj.__dict__.iteritems():</span><br><span class="line">        <span class="keyword">if</span> type(value) <span class="keyword">not</span> <span class="keyword">in</span> base_type:</span><br><span class="line">            _object[key] = value</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sorted(_object.keys()):</span><br><span class="line">        <span class="keyword">print</span> key + <span class="string">"\t = \t"</span> + str(_object.get(key))</span><br></pre></td></tr></table></figure>
<h4 id="查找对象中的方法"><a href="#查找对象中的方法" class="headerlink" title="查找对象中的方法"></a>查找对象中的方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_f</span><span class="params">(obj, key)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> filter(<span class="keyword">lambda</span> x: x.lower().find(key) != <span class="number">-1</span>, dir(obj))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/16/hadoop-hbase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/16/hadoop-hbase/" itemprop="url">hbase、phoenix 创建表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-16T14:53:35+08:00">
                2018-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/hbase/" itemprop="url" rel="index">
                    <span itemprop="name">hbase</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,288
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="创建日志表"><a href="#创建日志表" class="headerlink" title="创建日志表"></a>创建日志表</h4><ol>
<li><p>创建test表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create &apos;test&apos;, \</span><br><span class="line">&#123;NAME =&gt; &apos;f&apos;, COMPRESSION =&gt; &apos;SNAPPY&apos;&#125;, \</span><br><span class="line">&#123;SPLITS =&gt; [&apos;40&apos;,&apos;80&apos;,&apos;c0&apos;], SPLIT_POLICY =&gt; &apos;org.apache.hadoop.hbase.regionserver.KeyPrefixRegionSplitPolicy&apos;, CONFIGURATION =&gt; &#123;&apos;KeyPrefixRegionSplitPolicy.prefix_length&apos; =&gt; &apos;2&apos;&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建testIndex</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create &apos;testIndex&apos;, &#123;NAME =&gt; &apos;f&apos;, COMPRESSION =&gt; &apos;SNAPPY&apos;&#125;, &#123;SPLITS =&gt; [&apos;40&apos;,&apos;80&apos;,&apos;c0&apos;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建最新一条数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create &apos;testNewest&apos;, &#123;NAME =&gt; &apos;f&apos;, VERSIONS =&gt; 1, BLOCKCACHE =&gt; true, IN_MEMORY =&gt; true&#125;</span><br></pre></td></tr></table></figure>
<p> <strong>注意: </strong> 此处可以设置 <code>DURABILITY =&gt; &#39;SKIP_WAL&#39;</code>, 不过最好是在程序中控制WAL是否写入.</p>
</li>
<li><p>创建phoenix表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table TEST(prefix char(2) not null, time bigint not null, id char(10) not null,  message varchar, constraint pk primary key(prefix, time desc row_timestamp, id)) IMMUTABLE_ROWS=true SPLIT ON (&apos;40&apos;, &apos;80&apos;, &apos;c0&apos;) COMPRESSION=&apos;GZ&apos;;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ul>
<li><code>IMMUTABLE_ROWS</code> 不可变表(每一次表的操作都会影响整行，如update会直接替换原来一行，delete会删除整行)，对于创建索引的时候，如果是不可变的那么所以就不需要进行实时维护，对于全局索引如果是不可变的，那么写到索引表是在客户端完成的，而可变的索引是在服务端完成的。不可变索引写性能要高些。</li>
<li><code>row_timestamp</code> 指定主键中的某个字段为行的timestamp, 那么在插入的时候就指定这个时间为数据的真实timestamp（列上的timestamp都为这个时间， 这个时间可以指定也可以是服务端自动生成，由于是rowkey中的一部分，所以这个时间一定不可能发生变化，以后所有的upsert语句都不会更改这个时间）, 此处必须注意，如果数据删除之后, 再不能插入主键为相同的数据（因为主键相同，那么意味着列的timestamp并没有发生任何变化， 此时hbase已经将此timestamp的版本设置为了删除标识，所以即使插入数据版本也没有发生变化，还是删除的）， 所以对于这样的表，数据一定不能删除。不建议在表中使用这个字段，除非自己知道自己在干什么。此方式并不会减少数据存储，timestamp也会存在与主键之中，仅仅更改了列的版本的处理方式。</li>
<li>phoenix为每一行添加了一个空的列， 别去列mapping可以设置mapping字节数，下面有讲解。</li>
</ul>
<p>更改表的分区策略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter &apos;TEST&apos;, &#123;SPLIT_POLICY =&gt; &apos;org.apache.hadoop.hbase.regionserver.KeyPrefixRegionSplitPolicy&apos;, CONFIGURATION =&gt; &#123;&apos;KeyPrefixRegionSplitPolicy.prefix_length&apos; =&gt; &apos;2&apos;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upsert into test values(&apos;00&apos;, 1555385043000, &apos;1234567890&apos;, &apos;hello phoenix&apos;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table TEST(PREFIX char(2) not null, TM char(14) not null, STCD char(10) not null, DRP varchar, INTV varchar, PDR varchar, DYP varchar, WTH varchar, constraint pk primary key(PREFIX, TM desc, STCD)) SPLIT ON (&apos;40&apos;, &apos;80&apos;, &apos;c0&apos;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table st_statistics_pptn_day_new(stcd char(10) not null, tm char(8) not null, drp BIGINT, constraint pk primary key(stcd, tm desc)) SALT_BUCKETS = 4;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table st_statistics_pptn_hour_new(stcd char(10) not null, tm char(10) not null, drp BIGINT, constraint pk primary key(stcd, tm desc)) SALT_BUCKETS = 4;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>   <strong>说明 : </strong> </p>
<ul>
<li><code>SALT_BUCKETS</code> 大小通常是cpu core <em> (0.5 ~ 2) </em> region server, 例如: 6 <em> 0.5 </em> 3 = 9</li>
<li>row key 顺序扫描可以优化，通过在 <code>hbase-sites.xml</code> 中指定 <code>phoenix.query.rowKeyOrderSaltedTable=true</code> 禁止用户指定分割点</li>
<li>加盐后会在row key前面添加一个字节（0-255），并且会自动进行分割，如果需要手动split，需要添加上前面的一个盐字节</li>
</ul>
<ol start="6">
<li><p>查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scan &#123; STARTROW =&gt; &apos;FixedWidthUsername&apos; LIMIT =&gt; 30&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hbase 列预测限定，因为列进行mapping的时候，如果知道有多少列，那么就可以使用固定大小的mapping值来进行对应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COLUMN_ENCODED_BYTES = 1;</span><br></pre></td></tr></table></figure>
<p>此处1表示一个字节，那么做多可以代表256个数值，也就可以进行转换256个列</p>
</li>
<li><p>不可变表（IMMUTABLE_ROWS）列encoding，通过encoding可以降低存储，提供更好的性能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMMUTABLE_STORAGE_SCHEME = SINGLE_CELL_ARRAY_WITH_OFFSETS</span><br></pre></td></tr></table></figure>
<p>此处表示，单个cell存储一行的一个列族，建议不可变表使用这种设置， 并且设置此参数的时候列的mapping必须设定，也就是说需要添加 <code>COLUMN_ENCODED_BYTES</code> 参数</p>
<p>注意：这种优化策略不用应用与稀疏表，行中有50%的数据存在则不是稀疏表，与之对应的设定就是 <code>IMMUTABLE_STORAGE_SCHEME = ONE_CELL_PER_COLUMN</code></p>
</li>
<li><p>动态列，由于hbase的列的灵活性，所以phoenix也提供了这种动态添加列的方式， 也就是在create schema初期并不会提供列名，而是在插入和查询的时候指定需要查询的列和列对应的类型。从这里可以看到后期绑定也是非常实用的功能。</p>
</li>
<li><p>修改表类型 <code>ALTER TABLE my_table SET IMMUTABLE_ROWS=true,DISABLE_WAL=true;</code></p>
</li>
<li><p>HBase minor compact只进行文件的合并，Major compact除了文件的合并还包括让HFile和RegionServer本地化(这通常是因为Region迁徙造成的)</p>
</li>
<li><p>hbase读优化</p>
<ol>
<li>Get本质上也是Scan来进行操作</li>
<li>在进行数据获取的时候，尽量只获取需要的数据</li>
<li>控制Scan之后RegionServer是否缓存Block，默认缓存，但对于MapReduce应用来说通常不需要缓存块</li>
<li>可以设置Cache用来客户端缓存数据</li>
<li>可以设置Batch用来控制每次从服务端获取的数量，减少rpc</li>
<li>开启集群自动负载均衡，设置Compact策略</li>
<li>控制BlockCache的比率 <code>hfile.block.cache.size</code> 默认0.4</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/15/linux-openvpn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/15/linux-openvpn/" itemprop="url">openvpn客户端和服务端安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-15T17:41:45+08:00">
                2018-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,515
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="openvpn服务端安装"><a href="#openvpn服务端安装" class="headerlink" title="openvpn服务端安装"></a>openvpn服务端安装</h4><ol>
<li><p>安装openvpn</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release </span><br><span class="line">yum update -y</span><br><span class="line">yum install -y openssl lzo pam openssl-devel lzo-devel pam-devel expect</span><br><span class="line">yum install -y easy-rsa</span><br><span class="line">yum install -y openvpn</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置easy-rsa</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cp -rf /usr/share/easy-rsa/3.0.3 /etc/openvpn/server/easy-rsa</span><br><span class="line">cd /etc/openvpn/server/easy-rsa</span><br><span class="line">./easyrsa init-pki</span><br><span class="line">./easyrsa build-ca nopass</span><br><span class="line">./easyrsa build-server-full server nopass</span><br><span class="line">./easyrsa build-client-full client nopass</span><br><span class="line">./easyrsa gen-dh</span><br><span class="line">openvpn --genkey --secret ta.key</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置openvpn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 日志存放目录</span></span><br><span class="line">mkdir -p /var/log/openvpn/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置权限</span></span><br><span class="line">chown openvpn:openvpn /var/log/openvpn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户管理目录</span></span><br><span class="line">mkdir -p /etc/openvpn/server/user</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户IP固定目录</span></span><br><span class="line">mkdir -p /etc/openvpn/server/ccd</span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/openvpn/server/server.conf</code>文件，并写入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment"># This file is for the server side              #</span></span><br><span class="line"><span class="comment"># of a many-clients &lt;-&gt; one-server              #</span></span><br><span class="line"><span class="comment"># OpenVPN configuration.                        #</span></span><br><span class="line"><span class="comment">#                                               #</span></span><br><span class="line"><span class="comment"># Comments are preceded with '#' or ';'         #</span></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line">port 1194</span><br><span class="line">proto tcp-server</span><br><span class="line"><span class="comment">## Enable the management interface</span></span><br><span class="line"><span class="comment"># management-client-auth</span></span><br><span class="line"><span class="comment"># management localhost 7505 /etc/openvpn/user/management-file</span></span><br><span class="line">dev tap     <span class="comment"># TUN/TAP virtual network device</span></span><br><span class="line">user openvpn</span><br><span class="line">group openvpn</span><br><span class="line">ca /etc/openvpn/server/easy-rsa/pki/ca.crt</span><br><span class="line">cert /etc/openvpn/server/easy-rsa/pki/issued/server.crt</span><br><span class="line">key /etc/openvpn/server/easy-rsa/pki/private/server.key</span><br><span class="line">dh /etc/openvpn/server/easy-rsa/pki/dh.pem</span><br><span class="line">tls-auth /etc/openvpn/server/easy-rsa/ta.key 0</span><br><span class="line"><span class="comment">## Using System user auth.</span></span><br><span class="line"><span class="comment"># plugin /usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so login</span></span><br><span class="line"><span class="comment">## Using Script Plugins</span></span><br><span class="line">auth-user-pass-verify /etc/openvpn/server/user/checkpsw.sh via-env</span><br><span class="line">script-security 3</span><br><span class="line"><span class="comment"># client-cert-not-required  # Deprecated option</span></span><br><span class="line">verify-client-cert</span><br><span class="line">username-as-common-name</span><br><span class="line"><span class="comment">## Connecting clients to be able to reach each other over the VPN.</span></span><br><span class="line">client-to-client</span><br><span class="line"><span class="comment">## Allow multiple clients with the same common name to concurrently connect.</span></span><br><span class="line"><span class="comment"># duplicate-cn</span></span><br><span class="line">client-config-dir ccd</span><br><span class="line"><span class="comment"># ifconfig-pool-persist ipp.txt</span></span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">push <span class="string">"dhcp-option DNS 114.114.114.114"</span></span><br><span class="line">push <span class="string">"dhcp-option DNS 8.8.8.8"</span></span><br><span class="line"><span class="comment"># push "route 10.93.0.0 255.255.255.0"</span></span><br><span class="line"><span class="comment"># comp-lzo - DEPRECATED This option will be removed in a future OpenVPN release. Use the newer --compress instead.</span></span><br><span class="line">compress lzo</span><br><span class="line"><span class="comment"># cipher AES-256-CBC</span></span><br><span class="line">ncp-ciphers <span class="string">"AES-256-GCM:AES-128-GCM"</span></span><br><span class="line"><span class="comment">## In UDP client mode or point-to-point mode, send server/peer an exit notification if tunnel is restarted or OpenVPN process is exited.</span></span><br><span class="line"><span class="comment"># explicit-exit-notify 1</span></span><br><span class="line">keepalive 10 120</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">verb 3</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn/server.log</span><br><span class="line"><span class="built_in">log</span>-append /var/<span class="built_in">log</span>/openvpn/server.log</span><br><span class="line">status /var/<span class="built_in">log</span>/openvpn/status.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/openvpn/server/</span><br><span class="line">ln -sf server.conf .service.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建用户密码文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/openvpn/server/user/psw-file &lt;&lt; EOF</span><br><span class="line">mytest mytestpass</span><br><span class="line">EOF</span><br><span class="line">chmod 600 /etc/openvpn/server/user/psw-file</span><br><span class="line">chown openvpn:openvpn /etc/openvpn/server/user/psw-file</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong> 用户名和密码可以多行, 表示多个用户. 这里的用户名和密码, 和上面的 <code>client</code> 不是一回事, <code>client</code> 表示密钥, 所有的用户都可以使用同一个密钥, 也可以使用不同的, 所有通常为了简单只创建一个密钥, 并通过用户名来区分.</p>
</li>
<li><p>创建密码检查脚本 <code>/etc/openvpn/server/user/checkpsw.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##########################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> checkpsw.sh (C) 2004 Mathias Sundman &lt;mathias@openvpn.se&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This script will authenticate OpenVPN users against</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a plain text file. The passfile should simply contain</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> one row per user with the username first followed by</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> one or more space(s) or tab(s) and <span class="keyword">then</span> the password.</span></span><br><span class="line">PASSFILE="/etc/openvpn/server/user/psw-file"</span><br><span class="line">LOG_FILE="/var/log/openvpn/password.log"</span><br><span class="line">TIME_STAMP=`date "+%Y-%m-%d %T"`</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##########################################################</span></span></span><br><span class="line">if [ ! -r "$&#123;PASSFILE&#125;" ]; then</span><br><span class="line">  echo "$&#123;TIME_STAMP&#125;: Could not open password file \"$&#123;PASSFILE&#125;\" for reading." &gt;&gt;  $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line">CORRECT_PASSWORD=`awk '!/^;/&amp;&amp;!/^#/&amp;&amp;$1=="'$&#123;username&#125;'"&#123;print $2;exit&#125;' $&#123;PASSFILE&#125;`</span><br><span class="line">if [ "$&#123;CORRECT_PASSWORD&#125;" = "" ]; then</span><br><span class="line">  echo "$&#123;TIME_STAMP&#125;: User does not exist: username=\"$&#123;username&#125;\", password=</span><br><span class="line">\"$&#123;password&#125;\"." &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line">if [ "$&#123;password&#125;" = "$&#123;CORRECT_PASSWORD&#125;" ]; then</span><br><span class="line">  echo "$&#123;TIME_STAMP&#125;: Successful authentication: username=\"$&#123;username&#125;\"." &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line">echo "$&#123;TIME_STAMP&#125;: Incorrect password: username=\"$&#123;username&#125;\", password=</span><br><span class="line">\"$&#123;password&#125;\"." &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure>
<p>赋予写权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/openvpn/server/user/checkpsw.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看service名</span><br><span class="line">rpm -ql openvpn |grep service</span><br><span class="line">/usr/lib/systemd/system/openvpn-client@.service</span><br><span class="line">/usr/lib/systemd/system/openvpn-server@.service</span><br><span class="line">/usr/lib/systemd/system/openvpn@.service</span><br><span class="line"># 启动</span><br><span class="line">systemctl start openvpn-server@.service.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>问题总结:</p>
<ul>
<li><p>添加用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo user password &gt;&gt; /etc/openvpn/server/user/psw-file</span><br></pre></td></tr></table></figure>
</li>
<li><p>为用户固定IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/openvpn/server/ccd/$&#123;user&#125; &lt;&lt; EOF</span><br><span class="line">ifconfig-push 10.8.0.30 255.255.255.0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong> 替换此处的用户名, 和IP地址</p>
</li>
</ul>
</li>
</ol>
<h4 id="obfsproxy服务端安装"><a href="#obfsproxy服务端安装" class="headerlink" title="obfsproxy服务端安装"></a>obfsproxy服务端安装</h4><ol>
<li><p>安装python, 版本最好是大于2.7.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-devel bzip2 bzip2-devel zlib</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>安装pip和对应工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/get-pip.py</span><br><span class="line">python get-pip.py</span><br><span class="line">pip install --upgrade setuptools</span><br><span class="line">pip install --upgrade incremental</span><br><span class="line">pip install psutil</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Twisted</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://twistedmatrix.com/Releases/Twisted/18.9/Twisted-18.9.0.tar.bz2</span><br><span class="line">tar -jxvf Twisted-18.9.0.tar.bz2</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装obfsproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/dounine/obfsproxy.git</span><br><span class="line">tar -xzf obfsproxy-0.2.13.tar.gz</span><br><span class="line">python setup.py install</span><br><span class="line">ln -s /usr/bin/obfsproxy /usr/local/bin/obfsproxy</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong> 中间可能还会出现其它python问题, google解决即可</p>
</li>
<li><p>启动obfsproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obfsproxy obfs3 --dest=127.0.0.1:1194 server 0.0.0.0:10102</span><br></pre></td></tr></table></figure>
<p><strong>说明 : </strong> dest表示obfsproxy接收到的数据传输到哪里, 此处接收到数据传输到openvpn, server表示它是服务端,  0.0.0.0:10102表示监听的端口号.</p>
</li>
<li><p>添加obfsproxy的防火墙配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent  --add-port=10102/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="obfsproxy客户端安装"><a href="#obfsproxy客户端安装" class="headerlink" title="obfsproxy客户端安装"></a>obfsproxy客户端安装</h4><ol>
<li><p>安装obfsproxy客户端和服务端完全一样</p>
</li>
<li><p>启动obfsproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obfsproxy obfs3 --dest=服务端IP地址:10102 client 127.0.0.1:9997</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="openvpn客户端安装"><a href="#openvpn客户端安装" class="headerlink" title="openvpn客户端安装"></a>openvpn客户端安装</h4><ol>
<li><p>安装openvpn客户端和服务端完全一样</p>
</li>
<li><p>配置openvpn, 从server上将生成的<code>ca.crt</code>、<code>client.crt</code>、<code>client.key</code>、<code>ta.key</code>文件下载到客户端，并添加配置文件<code>client.ovpn</code>, 内容如下: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">client</span><br><span class="line">proto tcp-client</span><br><span class="line">dev tap</span><br><span class="line">auth-user-pass</span><br><span class="line">remote 127.0.0.1 9997</span><br><span class="line">ca ca.crt</span><br><span class="line">cert client.crt</span><br><span class="line">key client.key</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">remote-cert-tls server</span><br><span class="line">auth-nocache</span><br><span class="line">persist-tun</span><br><span class="line">persist-key</span><br><span class="line">comp-lzo</span><br><span class="line">verb 4</span><br><span class="line">mute 10</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong> 此处的remote并没有设置为openvpn的服务端地址, 而是设置为obfsproxy客户端监听的地址, 这样openvpn就先把数据发送给obfsproxy客户端, obfsproxy客户端再发送给obfsproxy服务端, obfsproxy服务端再发送给openvpn服务端.</p>
</li>
</ol>
<h4 id="openvpn经常会出现闪断"><a href="#openvpn经常会出现闪断" class="headerlink" title="openvpn经常会出现闪断"></a>openvpn经常会出现闪断</h4><ol>
<li><p>为openvpn客户端和服务端都创建启动脚本，并加入到crontab中，这样就不怕断开连接</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ilivoo/tools-openvpn</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/23/hadoop-yarn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/23/hadoop-yarn/" itemprop="url">yarn 动态资源分配</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-23T15:06:04+08:00">
                2018-01-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  527
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="spark动态资源分配"><a href="#spark动态资源分配" class="headerlink" title="spark动态资源分配"></a>spark动态资源分配</h4><ul>
<li><p>开启External shuffle service</p>
<ul>
<li><p>Spark系统在运行含shuffle过程的应用时，Executor进程除了运行task，还要负责写shuffle数据，给其他Executor提供shuffle数据。当Executor进程任务过重，导致GC而不能为其他Executor提供shuffle数据时，会影响任务运行。External shuffle Service是长期存在于NodeManager进程中的一个辅助服务。通过该服务来抓取shuffle数据，减少了Executor的压力，在Executor GC的时候也不会影响其他Executor的任务运行。</p>
</li>
<li><p>NodeManager中启动External shuffle Service</p>
<p>在<code>yarn-site.xml</code>中添加如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;                                                                        	  &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;                                         &lt;value&gt;spark_shuffle&lt;/value&gt;                                                   &lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;yarn.nodemanager.aux-services.spark_shuffle.class&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.spark.network.yarn.YarnShuffleService&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">	&lt;!-- 可选配置--&gt;</span><br><span class="line">    &lt;name&gt;spark.shuffle.service.port&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;7337&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝<code>${SPARK_HOME}/lib/spark-${SPARK_VERSION}-yarn-shuffle.jar</code></p>
<p>到<code>${HADOOP_HOME}/share/hadoop/yarn/lib/</code>目录下, 并重启NodeManager进程，也就启动了External shuffle Service。</p>
</li>
<li><p>Spark应用中使用External shuffle Service， 在spark-defaults.conf中添加配置或者直接使用–conf配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spark.shuffle.service.enabled  true</span><br><span class="line">spark.shuffle.service.port     7337</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意：</p>
<p>如果 <code>yarn.nodemanager.aux-services</code>配置项已存在，则在 value 中添加spark_shuffle，且用逗号和其他值分开。    </p>
<p><code>spark.shuffle.service.port</code>的值需要和上面yarn-site.xml中的值一样， 可以都直接使用默认值。</p>
</li>
<li><p>实际上现在hdp3.0 以上版本都已经自动开启了spark的External shuffle Service, 只需要设置在spark-defaults 和 yarn-site中设置 <code>spark.shuffle.service.port=7337</code></p>
</li>
</ul>
</li>
<li><p>spark程序开启动态资源分配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spark.dynamicAllocation.enabled				true</span><br><span class="line">spark.dynamicAllocation.minExecutors		1</span><br><span class="line">spark.dynamicAllocation.initialExecutors	1</span><br><span class="line">spark.dynamicAllocation.maxExecutors		9</span><br><span class="line">spark.dynamicAllocation.executorIdleTimeout	60</span><br><span class="line">spark.dynamicAllocation.cachedExecutorIdleTimeout	60</span><br><span class="line">spark.executor.cores	2</span><br></pre></td></tr></table></figure>
<ul>
<li><p>注意：</p>
<p>cores尽量设置为 &lt;= 3, 也就是说通常都是增大maxExecutors, 减小cores</p>
</li>
</ul>
</li>
</ul>
<h4 id="yarn-资源分配建议"><a href="#yarn-资源分配建议" class="headerlink" title="yarn 资源分配建议"></a>yarn 资源分配建议</h4><ul>
<li>设置Executor最大可用cores 和 memery， 这样能防止单个机器压力过大， 对于总的物理cores和memery来说需要减去操作系统以及hbase等其它的存储需要消耗的资源才为yarn最大可用资源， 通常需要预留生效资源的10%左右</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/13/hadoop-kerberos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/13/hadoop-kerberos/" itemprop="url">kerberos的使用以及各种权限说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-13T19:06:14+08:00">
                2018-01-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/kerberos/" itemprop="url" rel="index">
                    <span itemprop="name">kerberos</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,709
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="kerberos客户端配置"><a href="#kerberos客户端配置" class="headerlink" title="kerberos客户端配置"></a>kerberos客户端配置</h4><ul>
<li><p>krb5.conf配置选项参考： <code>https://linux.die.net/man/5/krb5.conf</code></p>
</li>
<li><p>配置kerberos多用户ticket缓存名字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#vi /etc/profile</span><br><span class="line">default_ccache_name = DIR:/tmp/kerberos</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>也可以设置环境变量达到相同的效果<code>export KRB5CCNAME=DIR:/tmp/kerberos</code></li>
<li>kerberos客户端在任意时刻只能有一个票证可用， 所以不管如何配置都不可能达到一次配置一次认证就可以了，而是认证之后可以进行多次切换不同的认证</li>
</ul>
</li>
<li><p>多个kerberos的krb5.conf合并</p>
<ul>
<li><p>通常情况每个kerberos服务器有一个krb5.conf文件， 如果有多个kerberos服务器需要认证那么通常会比较麻烦，需要拷贝配置文件，所以通常情况下我们可以讲这些文件合并一个文件。通常情况下只需要合并<code>realms</code> 就可以了，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[realms]</span><br><span class="line">  ILIVOO.COM = &#123;</span><br><span class="line">    admin_server = sandbox-hdp.hortonworks.com</span><br><span class="line">    kdc = sandbox-hdp.hortonworks.com</span><br><span class="line">  &#125;</span><br><span class="line">  EXAMPLE.COM = &#123;</span><br><span class="line">    admin_server = dev1</span><br><span class="line">    kdc = dev1</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>多个keytab文件合并</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ktutil</span><br><span class="line">ktutil:  rkt /etc/security/keytabs/hdfs.keytab</span><br><span class="line">ktutil:  rkt /etc/security/keytabs/hbase.keytab </span><br><span class="line">ktutil:  wkt /etc/krb5.keytab</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="kerberos客户端工具使用"><a href="#kerberos客户端工具使用" class="headerlink" title="kerberos客户端工具使用"></a>kerberos客户端工具使用</h4><ul>
<li><p>查看keytab文件中用户</p>
<p><code>klist -kt /etc/krb5.keytab</code></p>
</li>
<li><p>认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kinit -k admin/admin@ILIVOO.COM</span><br><span class="line">kinit -k admin/admin@EXAMPLE.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示认证</p>
<ul>
<li><p>显示当前认证</p>
<p><code>klist</code></p>
</li>
<li><p>显示所以认证</p>
<p><code>klist -A</code></p>
</li>
</ul>
</li>
<li><p>切换认证</p>
<p><code>kswitch -p admin/admin@ILIVOO.COM</code></p>
</li>
<li><p>销毁认证</p>
<ul>
<li><p>销毁当前认证</p>
<p><code>kdestroy</code></p>
<p>注意销毁当前认证， 并不会自动选择一个当前认证</p>
</li>
<li><p>销毁所有认证</p>
<p><code>kdestroy -A</code></p>
</li>
</ul>
</li>
<li><p>更新认证</p>
<p><code>kinit -R</code></p>
</li>
</ul>
<h4 id="kerberos服务端工具使用"><a href="#kerberos服务端工具使用" class="headerlink" title="kerberos服务端工具使用"></a>kerberos服务端工具使用</h4><p>说明： </p>
<ol>
<li>headless keytab与没有headless的keytab的区别， 主要是headless keytab可以在任何机器上使用，而没有headless的keytab只能在特定的服务器使用， 也就是说它们是服务器绑定的， 如： headless keytab 名称是 <a href="mailto:`hdfs-ilivoo@ILIVOO.COM" target="_blank" rel="noopener">`hdfs-ilivoo@ILIVOO.COM</a><code>， 而没有headless keytab是</code><a href="mailto:nn/hdp1.ilivoo.com@ILIVOO.COM" target="_blank" rel="noopener">nn/hdp1.ilivoo.com@ILIVOO.COM</a>`</li>
<li>kerberos管理员账户： <a href="mailto:`*/admin@ILIVOO.COM" target="_blank" rel="noopener">`*/admin@ILIVOO.COM</a><code>(可以通过</code><em>/var/kerberos/krb5kdc/kadm5.acl</em> `指定)</li>
</ol>
<ul>
<li><p>添加Principal</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local</span><br><span class="line">addprinc -randkey admin-ilivoo@ILIVOO.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出keytab文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/security/keytab</span><br><span class="line">kadmin.local</span><br><span class="line">ktadd/xst -k admin.headless.keytab admin-ilivoo</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong>如果keytab是随机密码的, 那么直接使用上面就可以了, 但是如果上面的keytab不是使用randkey, 那么此时必须使用 <code>-norandkey</code> 参数导出来才不会有错. 例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ktadd/xst -norandkey -k admin.admin.keytab admin/admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>合并keytab文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/security/keytab</span><br><span class="line">ktutil</span><br><span class="line">rkt admin.headless.keytab</span><br><span class="line">rkt hdfs.headless.keytab</span><br><span class="line">wkt all.headless.keytab</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="ambari、kerberos、service、host-权限"><a href="#ambari、kerberos、service、host-权限" class="headerlink" title="ambari、kerberos、service、host 权限"></a>ambari、kerberos、service、host 权限</h4><ul>
<li>通常情况下来说为了方便， 我们会在kerberos中创建一个admin用户， 以后使用admin账户就可以访问所有的hadoop服务， 而在hadoop中也建立一个admin用户，并加入到hadoop组当中， 让其和kerberos中的admin用户对应， 但是实际上它们没有任何的关系。</li>
<li><p>kerberos权限仅仅用来判定AB问题， 也就是说如何证明自己是自己所申称的人， 所以它需要引入一个受信的第三方来作为验证。 但是对于hadoop中的各组件来说， 通常都是每个组件一个用户， 并且把所有的组件用户加入到一个hadoop用户组当中。所以对于kerberos的admin用户仅仅只是能够声明我是一个管理员用户，它可以访问所store the credentials有的启动kerberos的hadoop服务， 但是hadoop通常来说每个用户都有自己的用户访问权限， 也就是说kerberos只是作为第一个访问这个服务的权限， 而服务自身的权限就和kerberos没有任何关系了。如hdfs当中， 所有的用户权限是根据本地linux模型来管理的， 所以必须要有linux本地用户的权限才可以进行访问。</p>
</li>
<li><p>对于ambari来说它是一个集群的管理着， 它有自己权限管理， 通常分为集群管理者、集群使用者、服务管理者、服务操作者、服务开发者等等。 并且它的权限用户通常也是可以和host的权限进行对应上的。如：在主机上创建了 admin 用户， 并且在ambari中创建了admin用户， 并且把admin用户配置成为集群管理者。</p>
</li>
<li><p>kerberos主要是用来验证某个人就是自己所声称的那个人， 所以通常情况下也是和主机的用户对于的， 也就是说根据需要是否在kerberos中创建主机用户的principal。通常情况下， service使用principal验证能够访问自己的用户， 那么对应用户访问的时候就必须为自己获取票证。</p>
</li>
<li><p>通常来说service是为了验证的话才需要为自己开启权限验证， 并且指定只有某种用户才能访问自己， 如果其它的服务或者客户端需要访问自己， 那么就必须获得票证。并且通常来说service有自己权限验证，可以将其授权给某个用户， 也就是说想要访问service必须先证明你就是自己声称的那个人， 这样就表示通过了service的kerberos验证， 再就是service有自己的权限验证(acl)， service必须为这个用户授权之后这个用户才能访问这个服务。通常情况下服务与服务之间的kerberos验证是非常严格的， 如： DataNode想要连接到NameNode那么必须有 <a href="mailto:`nn/host@ILIVOO.COM" target="_blank" rel="noopener">`nn/host@ILIVOO.COM</a><code>, 而服务的使用者却比较宽泛点， 如hdfs用户想要访问集群， 那么通常只需要</code><a href="mailto:hdfs-ilivoo@ILIVOO.COM" target="_blank" rel="noopener">hdfs-ilivoo@ILIVOO.COM</a>`， 甚至其它的用户也可以创建文件等等， 只是hdfs用户通常被指定为管理用户，其它用户需要hdfs用户为其授权。</p>
</li>
<li><p>host权限主要是用来控制对主机的访问权限， 但是通常情况下来说host权限也与其它的权限对应上， 方便服务的开发与管理。</p>
</li>
<li><p>通过上面的分析， 通常情况下我们使用这些复杂的权限的时候会非常小心， 并且规划好权限对于我们的开发至关重要。如下案例：</p>
<ol>
<li><p>运维人员， 通常都是需要对集群进行管理， 并监控集群的状态， 通常情况可以简单分为两种运维人员， 集群管理员， 集群监测员，创建权限如下：</p>
<p>集群管理员： host中创建 cluster admin 用户(cadmin), ambari中创建用户(cadmin)用户，并为其设置为集群管理员角色。</p>
<p>集群监测源： host中创建 cluster view 用户(cview), ambari中创建(cview)用户， 并为其设置为集群操作员角色。</p>
</li>
<li><p>开发人员， 通常对服务进行启动停止， 配置修改， 对某些服务进行访问， 通常不同的开发人员有不用的权限。如下案例：</p>
<p>spark开发人员： host中创建开发用户(feng), ambari中创建(feng)，并为其设置集群服务操作员角色， 在kerberos中添加票证， 并导出keytab文件给用户。 为用户配置hdfs权限， yarn权限， spark权限，hbase权限， kafka权限， hive权限等等。</p>
<p>注意： hdfs、yarn、spark、hbase、kafka、hive等为feng添加权限的时候， 通常需要先使用kinit登录到自己的权限， 再讲权限设置给feng用户。 如： hbase 为feng用户添加权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kinit -kt /var/kerberos/keytab/hbase.headless.keytab hbase-ilivoo@ILIVOO.COM</span><br><span class="line">hbase shell</span><br><span class="line">grant  &apos;feng&apos;, &apos;RWCA&apos;   #授权feng用户有rwca权限</span><br></pre></td></tr></table></figure>
<p>当然： 现在情况有所变化， hdfs、yarn、hbase、kafka、hive等都可以使用ranger为其配置权限， 所以如果这些组件使用了ranger插件， 那么就必须使用ranger为其配置。</p>
</li>
<li><p>建议能够使用hdfs自己的权限位， 就不要使用ranger来管理。</p>
</li>
</ol>
</li>
</ul>
<h4 id="kafka安装kerberos"><a href="#kafka安装kerberos" class="headerlink" title="kafka安装kerberos"></a>kafka安装kerberos</h4><ul>
<li><p>参考 <code>https://www.cnblogs.com/dongxiao-yang/p/7131626.html</code></p>
</li>
<li><p>服务端修改基本配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">listeners=SASL_PLAINTEXT://:6667      --修改listeners</span><br><span class="line">sasl.kerberos.service.name=kafka      --添加kerberos.name</span><br></pre></td></tr></table></figure>
</li>
<li><p>启用kerberos后，部分kafka管理脚本需要增加额外的参数才能使用, 建立 <code>client.properties</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security.protocol=SASL_PLAINTEXT</span><br></pre></td></tr></table></figure>
<p>新命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">所以新命令的使用方式为</span><br><span class="line">/usr/hdp/3.1.0.0-78/kafka/bin/kafka-topics.sh --create --zookeeper hdp1.ilivoo.com:2181 --replication-factor 3 --partitions 12 --topic test</span><br><span class="line"></span><br><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server hdp1.ilivoo.com:6667 --list --command-config client.properties</span><br><span class="line"></span><br><span class="line">bin/kafka-console-producer.sh --broker-list hdp1.ilivoo.com:6667 --topic dxTT --producer.config client.properties</span><br><span class="line">过期，需要重新申请或者renew Ticket</span><br><span class="line">bin/kafka-console-consumer.sh --bootstrap-server hdp1.ilivoo.com:6667 --topic dxTT --consumer.config client.properties --from-beginning</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="kerberos遇到的问题"><a href="#kerberos遇到的问题" class="headerlink" title="kerberos遇到的问题"></a>kerberos遇到的问题</h4><ul>
<li><p><code>kinit -R</code> 无法续约，这是因为kerberos的每个principal都可以指定超过此时间则ticket就会过期，需要重新申请或者renew有效时间和刷新时间， 默认添加principal的时候并没有指定它的刷新时间和有效时间，所以就使用了服务器默认配置的时间</p>
<p><code>kerberos Server上的/var/kerberos/krb5kdbc/kdc.conf中的max_life kadmin.local</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprinc -maxlife &quot;1 week&quot; feng@ILIVOO.COM</span><br><span class="line">modprinc -maxrenewlife &quot;1 week&quot; feng@ILIVOO.COM</span><br><span class="line">modprinc -maxlife &quot;1 week&quot; krbtgt/ILIVOO.COM@ILIVOO.COM</span><br><span class="line">modprinc -maxrenewlife &quot;1 week&quot; krbtgt/ILIVOO.COM@ILIVOO.COM</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>krbtgt表示服务端的tgt必须设置， 设置完成需要重新<code>kinit</code></p>
</li>
<li><p>kerberos 的票据的生命周期由lifetime和renewlifetime决定， 当生命周期超过lifetime则ticket就会过期，需要重新申请或者renew，如果重新申请非常容易理解， 直接重新申请就可以了。如果需要renew则首先要开启renew功能， 由上一个问题解决。通常情况下来说，renewlifetime会大于lifetime，如：lifetime=2d，renewlifetime=7d。而这两个时间由五个基本的时间决定：</p>
<ul>
<li><p>最基本由kerberos Server上的/var/kerberos/krb5kdbc/kdc.conf中的max_life 和 max_renewable_life决定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[realms]</span><br><span class="line"> ILIVOO.COM = &#123;</span><br><span class="line">  max_life = 2d</span><br><span class="line">  max_renewable_life = 7d</span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>内置principal krbtgt的maxmum ticket life 和 renew life,可在kadmin命令下执行getprinc命令查看</p>
</li>
<li><p>使用的principal的maximum tiket life 和 renew life，可在kadmin命令下用getprinc命令查看</p>
</li>
<li><p>再就是kerberos client上/etc/krb5.conf的ticket_lifetime 和 renew_lifetime</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[libdefaults]</span><br><span class="line">  ticket_lifetime = 2d</span><br><span class="line">  renew_lifetime = 7d</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>kinit 参数后面指定的时间, 如： <code>kinit -l 2d -r 7d my_principal</code></p>
</li>
</ul>
<p><strong>注意：</strong>上面五个生命周期依次往上逐渐取最小</p>
</li>
<li><p>kerberos spark集群连接hbase、kafka， 由于spark以及处理了kerberos认证问题，在spark的Driver启动的时候spark获取kerberos认证， 并将认证打包成代理Token存放在HDFS上， 当启动Executor的时候会带上这个Token用于Executor上的验证。当Token快要失效的时候Spark Driver会再次去刷新认证， 并讲认证信息告诉Executor，从而保证整个过程中长时间运行。</p>
<p><strong>注意：</strong>hbase的classpath是一个麻烦的事情， 因为通常情况下如果简单指定hbase-client会导致hbase 在Executor中没有认证的现象，所以必须讲hbase-server依赖带上。</p>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/04/mysql-procedure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/mysql-procedure/" itemprop="url">mysql 存储程序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T10:52:55+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,332
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="存储程序”"><a href="#存储程序”" class="headerlink" title="存储程序”"></a>存储程序”</h4><ul>
<li><p>MySQL允许通过触发器、存储过程、函数的形式来存储代码， 并且可以在定时任务中存放代码，这个定时任务也被成为”事件”。</p>
</li>
<li><p>一般来说，存储代码是一种很高的共享和复用代码的方法。</p>
</li>
<li><p>存储代码的优点：</p>
<p>a. 在服务器内部运行，离数据最近，另外在服务器上执行还可以节省带宽和网络延迟。</p>
<p>b. 代码重用。</p>
<p>c. 可以简化代码的维护和版本更新。 </p>
<p>d. 可以帮助提升安全，例如提供更细粒度的权限控制。如银行资金转移。</p>
<p>f. 服务器可以换成存储过程的执行计划。</p>
<p>g. 因为是在服务器端部署的，所以备份、维护都可以在服务器端完成。</p>
<p>h. 它可以在应用程序和数据库开发人员之间更好的分工。</p>
</li>
<li><p>存储代码的缺点：</p>
<p>a. MySQL本身没有提供好用的开发和调试工具。</p>
<p>b. 较之应用程序的代码，存储代码效率要稍微差些。 例如：函数有限，无法编写复杂字符串维护功能。</p>
<p>c. 存储代码可能会给应用程序代码的部署带来额外的复杂性。</p>
<p>d. 可能有安全隐患，最好加密。</p>
<p>e. 存储过程会给数据库服务器增加额外的压力，而数据库服务器的扩展性相比应用服务器要差很多。</p>
<p>f. MySQL不能控制存储过程的资源消耗，所以在存储过程中的一个小错误，可能直接把服务器拖死。</p>
<p>g. 调试MySQL的存储过程是一件很困难的事情。</p>
</li>
</ul>
<h4 id="存储过程和函数"><a href="#存储过程和函数" class="headerlink" title="存储过程和函数"></a>存储过程和函数</h4><ul>
<li>我们通常会希望程序越小、越简单越好。希望将更复杂的处理逻辑交给上层的应用实现，通常这样会使代码更易读、易维护，也会更灵活。这样做也会让你拥有更多的计算资源，潜在的还会让你拥有更多的缓存资源。 不过，对于某些操作，存储过程比其他的实现要快的多–特别是一个存储过程调用可以代替很多小查询的时候。如果查询很小，相比这个查询执行的成本，解析和网络开销就变得非常明显。</li>
<li>存储过程优点<ul>
<li>存储代码，节省很多网络开销，如循环insert</li>
<li>封装核心业务</li>
<li>存储过程可以回传值，并可以接受参数。</li>
</ul>
</li>
<li><p>存储过程缺点</p>
<ul>
<li><p>存储过程无法使用 SELECT 指令来运行，因为它是子程序，与查看表，数据表或用户定义函数不同。</p>
</li>
<li><p>存储过程，往往定制化于特定的数据库上，因为支持的编程语言不同。当切换到其他厂商的数据库系统时，需要重写原有的存储过程。</p>
</li>
<li><p>存储过程的调试比较麻烦， 并且出错后对系统影响较大</p>
</li>
<li><p>基于语句的复制通常情况下来说需要在复制库中执行</p>
<p>　</p>
</li>
</ul>
</li>
<li><p>存储过程与函数的区别</p>
<ul>
<li>本质上没区别，执行的本质都一样。 </li>
<li>函数只能返回一个变量的限制，而存储过程可以返回多个。　　 </li>
<li>函数是可以嵌入在sql中使用的,可以在select中调用，而存储过程要让sql的query 可以执行， 需要把 mysql_real_connect 的最后一个参数设置为CLIENT_MULTI_STATEMENTS。 </li>
<li>函数限制比较多，比如不能用临时表，只能用表变量．还有一些函数都不可用等等．而存储过程的限制相对就比较少。 </li>
<li>一般来说，存储过程实现的功能要复杂一点，而函数的实现的功能针对性比较强。存储过程，功能强大，可以执行包括修改表等一系列数据库操作；用户定义函数不能用于执行一组修改全局数据库状态的操作。 </li>
<li>对于存储过程来说可以返回参数，如记录集，而函数只能返回值或者表对象。函数只能返回一个变量；而存储过程可以返回多个。存储过程的参数可以有IN,OUT,INOUT三种类型，而函数只能有IN类，存储过程声明时不需要返回类型，而函数声明时需要描述返回类型，且函数体中必须包含一个有效的RETURN语句。</li>
<li>存储过程，可以使用非确定函数，不允许在用户定义函数主体中内置非确定函数。</li>
<li>存储过程一般是作为一个独立的部分来执行（ EXECUTE 语句执行），而函数可以作为查询语句的一个部分来调用（SELECT调用），由于函数可以返回一个表对象，因此它可以在查询语句中位于FROM关键字的后面。 SQL语句中不可用存储过程，而可以使用函数。 </li>
<li>当存储过程和函数被执行的时候，SQL Manager会到procedure cache中去取相应的查询语句，如果在procedure cache里没有相应的查询语句，SQL Manager就会对存储过程和函数进行编译。 Procedure cache中保存的是执行计划 (execution plan) ，当编译好之后就执行procedure cache中的execution plan，之后SQL SERVER会根据每个execution plan的实际情况来考虑是否要在cache中保存这个plan，评判的标准一个是这个execution plan可能被使用的频率；其次是生成这个plan的代价，也就是编译的耗时。保存在cache中的plan在下次执行时就不用再编译了。</li>
</ul>
</li>
</ul>
<h4 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h4><ul>
<li><p>触发器可以让你在执行INSERT、UPDATE或者DELETE的时候，执行一些特定的操作。可以在MySQL中指定是在SQL语句执行前触发还是在执行后触发。触发器本身没有返回值，不过它们可以读取或者改变触发SQL语句所影响的数据。所以，可以使用触发器实现一些强制限制，或者而某些业务逻辑，否则，就需要在应用程序中实现这些逻辑。</p>
</li>
<li><p>因为使用触发器可以减少客户端和服务器之间的通信，所以触发器可以简化应用逻辑，还可以提高性能。另外，还可以用于自动更新反范式化数据或者汇总表数据。</p>
</li>
<li><p>MySQL触发器实现非常简单，所以功能也有限。特别需要注意一下几点：</p>
<p>a. 对应每一个表的每一个事件，最多只能定义一个触发器(换句话说，不能在AFTER INSERT上定义两个触发器)</p>
<p>b. MySQL只支持”基于行的触发” – 也就是说，触发器始终是针对一条记录的，而不是针对整个SQL语句的。如果变更的数据集非常大的话，效率会很低。</p>
</li>
<li><p>触发器本身的限制：</p>
<p>a. 触发器可以掩盖服务器背后的工作。例如SQL影响的记录数翻一倍。</p>
<p>b. 触发器的问题很难排除</p>
<p>c. 触发器可能导致死锁或所等待。</p>
</li>
<li><p>在InnoDB表上的触发器是在同一个事务中完成的，所以它们执行的操作是原子的，原子操作和触发器操作会同时失败或者成功。不过，如果在InnoDB表上的触发器去检查数据的一致性，需要特别小心MVCC，稍不小心，可能会获得错误的结果。</p>
</li>
<li>可以使用触发器记录数据变更日志。</li>
</ul>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><ul>
<li>定时任务类似于Linux的定时任务，不过是完全在MySQL内部实现的。你可以创建事件，执行MySQL在某个时候执行一段SQL代码，或者每隔一段时间执行一段SQL代码。通常，我们会把复杂的SQL都封装到一个存储过程中，这样事件在执行的时候只需要做一个简单的CALL调用。</li>
<li>如果一个定时事件执行需要很长的时间，那么有可能会出现这样的情况，即前面一个事件还未执行完成，下一个时间点的事件又开始了。MySQL本身不会防止这种并发，所以需要用户在自己编写这种情况下防并发代码。你可以使用函数GET_LOCK()来确保当前总是有一个事件在被执行。</li>
<li>虽然事件的执行是和连接无关的，但是它仍然是线程级别的。MySQL中有一个事件调度线程，必须在MySQL配置文件中设置，或者使用下面的命令来设置。SET GLOBAL event_scheduler :=1</li>
<li>在存储过程中保留注释：/<em>! xxxxxxxxxxxxxxxxxxxx </em>/</li>
<li>MySQL在服务器端提供只读的、单向的游标，而且只能在存储过程或者更底层的客户端API中使用。因为MySQL游标中指向的对象都是存储在临时表中而不是实际查询到的数据，所以MySQL游标总是只读的。它可以逐行指向查询结果，然后让程序做进一步处理。</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/mysql-exist-in/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/mysql-exist-in/" itemprop="url">mysql exists与in的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T20:08:08+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,249
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h4><ul>
<li><p>exists对外表用loop逐条查询，每次查询都会查看exists的条件语句，当 exists里的条件语句能够返回记录行时(无论记录行是的多少，只要能返回)，条件就为真，返回当前loop到的这条记录，反之如果exists里的条 件语句不能返回记录行，则当前loop到的这条记录被丢弃，exists的条件就像一个bool条件，当能返回结果集则为true，不能返回结果集则为 false，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where exists (select 1);</span><br></pre></td></tr></table></figure>
<p>对user表的记录逐条取出，由于子条件中的select 1永远能返回记录行，那么user表的所有记录都将被加入结果集，所以与 select * from user;是一样的，又如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where exists (select * from user where userId = 0);</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ul>
<li><p>可以知道对user表进行loop时，检查条件语句(select * from user where userId = 0),由于userId永远不为0，所以条件语句永远返回空集，条件永远为false，那么user表的所有记录都将被丢弃</p>
</li>
<li><p>not exists与exists相反，也就是当exists条件有结果集返回时，loop到的记录将被丢弃，否则将loop到的记录加入结果集</p>
</li>
<li><p>总的来说，如果A表有n条记录，那么exists查询就是将这n条记录逐条取出，然后判断n遍exists条件 </p>
</li>
</ul>
</li>
</ul>
<h4 id="in"><a href="#in" class="headerlink" title="in"></a>in</h4><ul>
<li><p>in查询相当于多个or条件的叠加，这个比较好理解，比如下面的查询</p>
<p>select * from user where userId in (1, 2, 3);</p>
<p>等效于</p>
<p>select * from user where userId = 1 or userId = 2 or userId = 3;</p>
</li>
<li><p>not in与in相反，如下</p>
<p>select * from user where userId not in (1, 2, 3);</p>
<p>等效于</p>
<p>select * from user where userId != 1 and userId != 2 and userId != 3;</p>
</li>
<li><p>总的来说，in查询就是先将子查询条件的记录全都查出来，假设结果集为B，共有m条记录，然后在将子查询条件的结果集分解成m个，再进行m次查询</p>
</li>
</ul>
<ul>
<li><p>值得一提的是，in查询的子条件返回结果必须只有一个字段，例如</p>
<p>select * from user where userId in (select id from B);</p>
<p>而不能是</p>
<p>select * from user where userId in (select id, age from B);</p>
<p>而exists就没有这个限制</p>
</li>
</ul>
<h4 id="exists和in的性能"><a href="#exists和in的性能" class="headerlink" title="exists和in的性能"></a>exists和in的性能</h4><ul>
<li><p>考虑如下SQL语句</p>
<p>1: select <em> from A where exists (select </em> from B where B.id = A.id);</p>
<p>2: select * from A where A.id in (select id from B);</p>
<p>查询1.可以转化以下伪代码，便于理解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for ($i = 0; $i &lt; count(A); $i++) &#123;</span><br><span class="line">　　$a = get_record(A, $i); #从A表逐条获取记录</span><br><span class="line">　　if (B.id = $a[id]) #如果子条件成立</span><br><span class="line">　　　　$result[] = $a;</span><br><span class="line">&#125;</span><br><span class="line">return $result;</span><br></pre></td></tr></table></figure>
<p>大概就是这么个意思，其实可以看到,查询1主要是用到了B表的索引，A表如何对查询的效率影响应该不大</p>
<p>假设B表的所有id为1,2,3,查询2可以转换为</p>
<p>select * from A where A.id = 1 or A.id = 2 or A.id = 3;</p>
<p>这个好理解了，这里主要是用到了A的索引，B表如何对查询影响不大</p>
</li>
</ul>
<ul>
<li><p>再看not exists 和 not in</p>
<p>1: select <em> from A where not exists (select </em> from B where B.id = A.id);</p>
<p>2: select * from A where A.id not in (select id from B);</p>
<p>看查询1，还是和上面一样，用了B的索引, 而对于查询2，可以转化成如下语句</p>
<p>select * from A where A.id != 1 and A.id != 2 and A.id != 3;</p>
<p>可以知道not in是个范围查询，这种!=的范围查询无法使用任何索引,等于说A表的每条记录，都要在B表里遍历一次，查看B表里是否存在这条记录故not exists比not in效率高 </p>
</li>
<li><p>mysql中的in语句是把外表和内表作hash 连接，而exists语句是对外表作loop循环，每次loop循环再对内表进行查询。一直大家都认为exists比in语句的效率要高，这种说法其实是不准确的。这个是要区分环境的。</p>
</li>
</ul>
<ul>
<li><p>如果查询的两个表大小相当，那么用in和exists差别不大。 </p>
<p>如果两个表中一个较小，一个是大表，则子查询表大的用exists，子查询表小的用in： </p>
<p>例如：表A（小表），表B（大表）</p>
<p>1: select * from A where cc in (select cc from B) 效率低，用到了A表上cc列的索引；</p>
<p> select * from A where exists(select cc from B where cc=A.cc) 效率高，用到了B表上cc列的索引。 </p>
<p>相反的</p>
<p>2: select * from B where cc in (select cc from A) 效率高，用到了B表上cc列的索引；</p>
</li>
</ul>
<p>​    select * from B where exists(select cc from A where cc=B.cc) 效率低，用到了A表上cc列的索引。</p>
<h4 id="not-in-和not-exists"><a href="#not-in-和not-exists" class="headerlink" title="not in 和not exists"></a>not in 和not exists</h4><ul>
<li><p>如果查询语句使用了not in 那么内外表都进行全表扫描，没有用到索引；而not extsts 的子查询依然能用到表上的索引。所以无论那个表大，用not exists都比not in要快。 </p>
</li>
<li><p>in 与 =的区别 </p>
<p>select name from student where name in (‘zhang’,’wang’,’li’,’zhao’); </p>
<p>与 </p>
<p>select name from student where name=’zhang’ or name=’li’ or name=’wang’ or name=’zhao’ </p>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/mysql-select/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/mysql-select/" itemprop="url">mysql 查询顺序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T18:54:27+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,178
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="笛卡尔乘积"><a href="#笛卡尔乘积" class="headerlink" title="笛卡尔乘积"></a>笛卡尔乘积</h4><ul>
<li>使用join执行笛卡尔乘积， 并且使用on来对笛卡尔乘积之前进行过滤操作, 这也称作显示的连接操作</li>
<li>使用from连接多个表执行笛卡尔乘积， 并且使用where进行过滤， 但是由于先执行笛卡尔乘积再过滤， 所以有效率问题， 这也称作隐式的连接操作</li>
</ul>
<h4 id="定义变化的表"><a href="#定义变化的表" class="headerlink" title="定义变化的表"></a>定义变化的表</h4><ul>
<li>可以使用(select @rank := 0) as ranker 来定义一张只有一个字段@rank的表ranker， 并且@rank字段也会作为用户自定义字段而存在， 所以相当于对@rank进行初始化。</li>
</ul>
<h4 id="笛卡尔乘积给一个表添加一个字段，-并且该字段自增"><a href="#笛卡尔乘积给一个表添加一个字段，-并且该字段自增" class="headerlink" title="笛卡尔乘积给一个表添加一个字段， 并且该字段自增"></a>笛卡尔乘积给一个表添加一个字段， 并且该字段自增</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select p.id, p.name, @rank := @rank + 1 as rank from person as p join (select @rank := 0) as ranker;</span><br></pre></td></tr></table></figure>
<h4 id="查询步骤"><a href="#查询步骤" class="headerlink" title="查询步骤"></a>查询步骤</h4><ul>
<li><p>查询操作是关系数据库中使用最为频繁的操作，也是构成其他SQL语句（如DELETE、UPDATE）的基础。查询处理的顺序如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(7) SELECT (8) DISTINCT </span><br><span class="line">(1) FROM </span><br><span class="line">(3) JOIN </span><br><span class="line">(2) ON </span><br><span class="line">(4) WHERE </span><br><span class="line">(5) GROUP BY </span><br><span class="line">(6) HAVING </span><br><span class="line">(9) ORDER BY </span><br><span class="line">(10) LIMIT</span><br></pre></td></tr></table></figure>
<ul>
<li>1）FROM：对FROM子句中的所有的表一次左右执行笛卡儿积（Cartesian product），产生虚拟表VT1。 </li>
<li>2，3）JOIN和ON应该是一个整体作为一个连接操作： 如果存在ON就先对VT1和JOIN后面的表进行过滤， 并且执行连接操作,  如果还有JOIN和ON继续接着进行连接， 如果此时又出现表则表示FROM后还有表进行笛卡尔乘积， 定义所有的这一连串操作产生VT3mysql不支持全连接， 并且它的连接与外连接是等价的， 跨连接与内连接是等价的</li>
<li>4）WHERE：对虚拟表VT3应用WHERE过滤条件，只有符合的记录才被插入虚拟表VT4中。此时数据还没有分组，所以不能在where中出现对统计的过滤 where: &lt;，&lt;=，=，!=或者&lt;&gt;，&gt; ，&gt;=， like (% 通配任意字符, _通配一个字符),exist(判空), beteeen(在某范围内)，any/som(集合中任意元素), all(集合中所有的元素), in(在某集合内), not !  逻辑非, or ||  逻辑或, and &amp;&amp;  逻辑与</li>
<li>5）GROUP BY：根据GROUP BY子句中的列，对VT4中的记录进行分组操作，产生VT5。在GROUP BY阶段，数据库认为两个NULL值是相等的，因此会将NULL值分到同一个分组中。</li>
<li>6）CUBE|ROLLUP：对表VT5进行CUBE或ROLLUP操作，产生表VT6。 </li>
<li>7）HAVING：对虚拟表VT6应用HAVING过滤器，只有符合的记录才被插入虚拟表VT7中。count(expr) 会返回expr不为NULL的行数，count(1)、count(*)会返回包括NULL值在内的所有数量 </li>
<li>8）SELECT：执行SELECT操作，选择指定的列，插入到虚拟表VT8中。 </li>
<li>9）DISTINCT：去除重复数据，产生虚拟表VT9。 </li>
<li>10）ORDER BY：将虚拟表VT9中的记录按照进行排序操作，产生虚拟表VT10。如果不指定排序，数据并非总是按照主键顺序进行排序的。NULL被视为最小值 </li>
<li>11）LIMIT：取出指定行的记录，产生虚拟表VT11，并返回给查询用户。LIMIT n, m的效率是十分低的,一般可以通过在where条件中指定范围来优化 where id&gt; ? limit 10</li>
<li>12)  UNION [ALL] (联合两个查询的结果), INTERSECT(交集)， EXCEPT(差集)</li>
</ul>
</li>
<li><p>注意：</p>
<ul>
<li>从上面的执行流程可以看出， 上面有很多过滤操作， 如： on where having distinct limit, 而每一个过滤操作都依赖前面的执行结果， 所以我们在前面的结果中如果能够尽量过滤掉不需要的结果那么对于后面的结果操作会简单很多。</li>
<li>所有的这些地方使用表的地方都可以使用子查询来建立新表， 如果数据量比较大尽量不适用子查询， 使用连接来优化。</li>
<li>对于要查询的结果来说， 从上面可以看到， 到第八步才开始进行真正的投影的， 所以不用担心查询出来结果信息。</li>
<li>可以看到limit是在最后执行的， 所以如果前期查询出大量结果， 再进行limit n,m可能会造成性能问题， 因为在limit之前以及进行了投影动作， 也就是所有的结果都以及查询出来了，如果此时我们只需要使用索引先搜索出满足limit的结果的主键id， 再通过主键id去查询结果， 那么此时会优化速度， 因为完全不用先查询出结果， 只需要最终去拿结果就可了。</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my-icon.jpeg"
                alt="ilivoo" />
            
              <p class="site-author-name" itemprop="name">ilivoo</p>
              <p class="site-description motion-element" itemprop="description">我，在這裡，享受等你的時光。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ilivoo</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/lib/clipboard/clipboard.js"></script>
<script type="text/javascript" src="/js/src/custom.js"></script>

</body>
</html>
