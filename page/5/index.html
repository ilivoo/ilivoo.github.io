<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Ilivoo`s blog" type="application/atom+xml" />






<meta name="description" content="我，在這裡，享受等你的時光。">
<meta property="og:type" content="website">
<meta property="og:title" content="Ilivoo`s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Ilivoo`s blog">
<meta property="og:description" content="我，在這裡，享受等你的時光。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ilivoo`s blog">
<meta name="twitter:description" content="我，在這裡，享受等你的時光。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>Ilivoo`s blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ilivoo`s blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/live-photo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/live-photo/" itemprop="url">摄影</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:32:42+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/live/" itemprop="url" rel="index">
                    <span itemprop="name">live</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  594
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>摄影的三要素</p>
<ul>
<li><p>曝光： 光线通过光圈到照片中接受的多少。</p>
</li>
<li><p>审美： 照片通过各种元素给人的视觉不同的冲击力。</p>
</li>
<li><p>其它： 照片体现的各种主题、人文等等。</p>
</li>
</ul>
</li>
<li><p>曝光的三要素：</p>
<ul>
<li><p>光圈： 小孔成像中小孔的描述， 光圈也存在大小。</p>
</li>
<li><p>快门： 光线通过小孔传递到照片， 通过一个开关控制光圈打开的时间。</p>
</li>
<li><p>ISO：由于场景中光线的强度有限， 如果通过大光圈慢快门还是无法达到我们想要的效果，那么通常需要调大ISO， 从而使得照片增加曝光。ISO也叫感光度， 如果ISO增大那么照片的曝光也会增大， 但是同样带来了另外一个问题， 噪音也会变大，所以通常情况下光线良好的都是低ISO。</p>
</li>
</ul>
</li>
<li><p>景深的三要素：</p>
<p>景深定义：对于定焦物体后面的景色清晰程度， 也就是焦点后面物体多远的保持清晰</p>
<ul>
<li><p>光圈：通过小孔成像的原理我们知道， 小孔越大照片越模糊， 小孔越小照片越清晰， 所以通常情况下拍摄人物会选择大光圈， 而拍摄景色使用小光圈， 这样也会使得人物定焦后， 人物清晰而人物后面的景色比较朦胧， 而景色整个的都比较清晰。</p>
</li>
<li><p>焦距：当拍摄时的光圈大小不变，被摄体的位置也不改变时，使用的镜头焦距越短，景深就越大;镜头的焦距越长，景深就越小。也就是在光圈不变的条件下，使用广角镜头时，景深的清晰范围就要相对大一些，使用中、长焦距镜头时，景深的清晰范围就相对要小得多。</p>
</li>
<li><p>焦点与相机的距离：而当拍摄时的光圈大小不变，所使用的镜头焦距也不改变时，被摄体越远，画面中的前后清晰范围就越大；反之，被摄体越近，前后的清晰范围也就相对越小。这就提醒我们，在拍摄一些特定和近景的画面时，调焦应该特别仔细，稍有疏忽，使主体景物越出景深范围，整个画面就都虚了。</p>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/mysql-profile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/mysql-profile/" itemprop="url">mysql性能解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:00:05+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  495
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>profiling使用： 性能剖析一般分为两步， 测量任务所花费的时间， 然后对结果进行统计和排序。</p>
</li>
<li><p>New Relic, xhprof</p>
</li>
<li><p>可以通过设置long_query_time为0来捕获所有的查询</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log = on</span><br><span class="line">slow_query_log_file = /var/log/mysql/mysql-slow.log</span><br><span class="line">long_query_time = 0</span><br><span class="line">#set global slow_query_log=on;通常情况下，服务器可以通过随时打开来进行开启慢查询</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>pt-query-digest, mysqldumpslow等等来分析满查询</p>
</li>
<li><p>性能剖析步骤：</p>
<ol>
<li><p>使用慢查询， 直接开启慢查询或者使用pt-query-digest获取(show full processlist实现)或者直接使用tcpdump将网络包数据保存到磁盘， 然后使用pt-query-digest –type=tcpdump来进行解析并分析查询</p>
</li>
<li><p>使用pt-query-digest来分析慢查询日志， 并分析出结果</p>
</li>
<li><p>使用explain分析执行的语句</p>
</li>
<li><p>使用profiling来分析单条语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set profiling=1</span><br><span class="line">select * </span><br><span class="line">show profiles</span><br><span class="line">show profile for query n</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>通常使用show status、show processlist和show innodb status开销是非常低的</p>
</li>
<li><p>通过show profile for query n来获取到查询主要的耗时在哪个地方， 如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copying to temp table		0.090623</span><br><span class="line">Sorting result				0.011555</span><br><span class="line">Sending result				0.045931</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>可以看到此处最大的消耗是在临时表中， 所有此时我们考虑的是如何去掉临时表， 但经常可能会误导我们的是结果排序， 它占比非常低， 而我们如果简单通过查询语句很容易掉入到这个陷阱当中， 所以一般原则是”不建议优化排序缓冲区”。</p>
</li>
<li><p>show status通常是一个很有用的工具， 但是它不是一款剖析工具， show status大多都是一个计数器。</p>
</li>
<li><p>mysql在5.6.6中正是加入了performance_schema数据库（它的存储引擎也是performace_schema, 内存式数据引擎）， 用来记录系统中需要记录的性能相关的数据， 并且是默认开启的</p>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/mysql-partitions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/mysql-partitions/" itemprop="url">mysql自动分区</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T19:44:59+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  899
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>修改已经存在的表为其添加分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> </span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">to_days</span>(<span class="keyword">time</span>)) (</span><br><span class="line"><span class="keyword">PARTITION</span> p201811 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2018-12-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201812 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-01-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201901 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-02-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201902 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-03-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201903 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-04-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201904 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-05-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201905 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-06-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201906 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-07-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201907 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-08-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201908 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-09-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201909 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-10-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201910 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-11-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201911 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-12-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201912 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-01-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> pmax <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (MAXVALUE))</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>添加分区和差分分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> pmax;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> <span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (<span class="keyword">PARTITION</span> p202001 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-02-01'</span>)));</span><br></pre></td></tr></table></figure>
<p><strong>注意 :</strong> 由于分区表通常会带有一个最大的分区用来控制忘记添加分区， 所以我们添加分区的时候一定要知道最大分区中是否存在数据， 如果存在那么必须先修改最大分区， 所以通常情况下我们不会使用上面的语句进行添加分区， 而是使用Reorganize关键字， 并且Reorganize关键字不会导致数据丢失</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> reorganize <span class="keyword">partition</span> pmax <span class="keyword">into</span>(</span><br><span class="line"><span class="keyword">PARTITION</span> p202001 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-02-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p202002 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-03-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> pmax <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (MAXVALUE));</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改多个分区，在into关键字之前或之后都指定多个分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> reorganize <span class="keyword">partition</span> p201901, p201902 ... p201912 <span class="keyword">into</span>(<span class="keyword">Partition</span> p2019 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="keyword">to_days</span>(<span class="string">'2020-01-01'</span>)));</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>修改整个表的分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> reorganize <span class="keyword">partition</span> <span class="keyword">into</span>(</span><br><span class="line"><span class="keyword">Partition</span> p2019 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="keyword">to_days</span>(<span class="string">'2020-01-01'</span>))，</span><br><span class="line"><span class="keyword">Partition</span> p2020 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="keyword">to_days</span>(<span class="string">'2021-01-01'</span>))，</span><br><span class="line"><span class="keyword">Partition</span> pmax <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(MAXVALUE));</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>子分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders_range(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">customer_surname <span class="built_in">varchar</span>(<span class="number">30</span>),</span><br><span class="line">store_id <span class="built_in">int</span>,</span><br><span class="line">salesperson_id <span class="built_in">int</span>,</span><br><span class="line">order_Date <span class="built_in">date</span>,</span><br><span class="line">note <span class="built_in">varchar</span>(<span class="number">500</span>)</span><br><span class="line">) <span class="keyword">engine</span>=myisam  <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">range</span>(<span class="keyword">id</span>) </span><br><span class="line"><span class="keyword">subpartition</span> <span class="keyword">by</span> <span class="keyword">hash</span>(store_id) <span class="keyword">subpartitions</span> <span class="number">2</span>(</span><br><span class="line"><span class="keyword">partition</span> p0 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="number">5</span>),</span><br><span class="line"><span class="keyword">partition</span> p1 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="number">10</span>),</span><br><span class="line"><span class="keyword">partition</span> p3 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="number">15</span>));</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong>只允许对range和list类型的分区再进行分区，子分区的类型只允许是hash或key.</p>
<ol start="6">
<li>查看分区信息</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  partition_name part,  </span><br><span class="line">  partition_expression expr,  </span><br><span class="line">  partition_description <span class="keyword">descr</span>,  </span><br><span class="line">  table_rows,</span><br><span class="line">  data_length/<span class="number">1024</span>/<span class="number">1024</span></span><br><span class="line"><span class="keyword">from</span> information_schema.partitions  <span class="keyword">where</span> </span><br><span class="line">  table_schema = <span class="keyword">schema</span>()  </span><br><span class="line">  <span class="keyword">and</span> table_name=<span class="string">'device_model_report'</span>;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>创建分区存储过程</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> <span class="keyword">if</span> <span class="keyword">exists</span> p_time_range_partition_add;</span><br><span class="line">DELIMITER // </span><br><span class="line"><span class="keyword">CREATE</span> DEFINER=<span class="string">`root`</span>@<span class="string">`%`</span> <span class="keyword">PROCEDURE</span> <span class="string">`p_time_range_partition_add`</span>(<span class="keyword">IN</span> <span class="string">`sch_name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>),<span class="keyword">IN</span> <span class="string">`tab_name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>),<span class="keyword">IN</span> <span class="string">`patition_date`</span> <span class="built_in">date</span>)</span><br><span class="line">b_lable:<span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">declare</span> pmax_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="string">"pmax"</span>; <span class="comment">-- max patition name must be pmax</span></span><br><span class="line"><span class="keyword">declare</span> p_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="keyword">concat</span>(<span class="string">'p'</span>, <span class="keyword">date_format</span>(patition_date,<span class="string">'%Y%m'</span>));</span><br><span class="line"><span class="keyword">declare</span> p_time <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="keyword">concat</span>(<span class="keyword">date_format</span>(<span class="keyword">date_add</span>(patition_date,<span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">month</span>),<span class="string">'%Y-%m'</span>), <span class="string">'-01'</span>);</span><br><span class="line"><span class="keyword">declare</span> pmax_table_rows <span class="built_in">integer</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- check param</span></span><br><span class="line">if (<span class="keyword">SELECT</span> table_name <span class="keyword">FROM</span> information_schema.TABLES <span class="keyword">WHERE</span> table_schema = sch_name <span class="keyword">and</span> table_name = tab_name) <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span></span><br><span class="line">	leave b_lable;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test pmax</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	table_rows <span class="keyword">into</span> pmax_table_rows </span><br><span class="line"><span class="keyword">from</span> information_schema.partitions <span class="keyword">where</span> </span><br><span class="line">	table_schema = sch_name <span class="keyword">and</span> </span><br><span class="line">	table_name = tab_name <span class="keyword">and</span> </span><br><span class="line">	partition_name = pmax_name;</span><br><span class="line">if pmax_table_rows &gt; 0 then</span><br><span class="line">	leave b_lable; <span class="comment">-- need to manual alter</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test exist pname</span></span><br><span class="line">if (<span class="keyword">select</span> partition_name <span class="keyword">from</span> information_schema.partitions <span class="keyword">where</span> table_schema = sch_name <span class="keyword">and</span> table_name = tab_name <span class="keyword">and</span> partition_name = p_name) = p_name <span class="keyword">then</span></span><br><span class="line">	leave b_lable;	<span class="comment">-- has patition</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- add patition</span></span><br><span class="line"><span class="keyword">set</span> @p_ps=<span class="keyword">concat</span>(<span class="string">"ALTER TABLE "</span>, tab_name, <span class="string">" reorganize partition pmax into(PARTITION "</span>, p_name, <span class="string">" VALUES LESS THAN (to_days('"</span>, p_time, <span class="string">"')), PARTITION pmax VALUES LESS THAN (MAXVALUE));"</span>);</span><br><span class="line"><span class="keyword">prepare</span> stm <span class="keyword">from</span> @p_ps;</span><br><span class="line"><span class="keyword">execute</span> stm;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">//</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>设置事件</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置开启(数据库默认是关闭的，这个需要在my.cnf中设置下，否则数据库重启后会自动关闭)</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> event_scheduler = <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 查看任务调度启动状态</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">VARIABLES</span> <span class="keyword">like</span> <span class="string">'event_scheduler'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建任务调度</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">event</span> event_p_time_range_partition_add</span><br><span class="line"><span class="keyword">on</span> schedule every <span class="number">1</span> <span class="keyword">month</span> starts <span class="keyword">sysdate</span>()</span><br><span class="line"><span class="keyword">on</span> completion <span class="keyword">preserve</span></span><br><span class="line"><span class="keyword">enable</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">call</span> p_time_range_partition_add(<span class="string">'test'</span>, <span class="string">'device_model_report'</span>,<span class="keyword">date_add</span>(<span class="keyword">curdate</span>(),<span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">month</span>));</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/26/linux-terminal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/26/linux-terminal/" itemprop="url">终端使用技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-26T16:09:09+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  553
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="操作系统启动顺序"><a href="#操作系统启动顺序" class="headerlink" title="操作系统启动顺序"></a>操作系统启动顺序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">引导程序</span><br><span class="line">init进程(初始化操作系统 fork exec)</span><br><span class="line">login进程(用于校验用户信息, 并执行exec)</span><br><span class="line">bash进程(解释用户输入,并执行fork和exec)</span><br><span class="line">用户进程, 整个启动顺序</span><br></pre></td></tr></table></figure>
<h4 id="进程基本操作"><a href="#进程基本操作" class="headerlink" title="进程基本操作"></a>进程基本操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nohup 用来接管程序运行，不会挂起程序并接管控制台输出到文件中</span><br><span class="line">command &amp;   //将进程放在后台执行 </span><br><span class="line">ctrl-z      //暂停当前进程 并放入后台, 放入后台后可以直接使用bg转换成后台执行 </span><br><span class="line">jobs        //查看当前后台任务</span><br><span class="line">bg          //将任务转为后台执行 </span><br><span class="line">fg          //将任务调回前台 </span><br><span class="line">kill        //杀掉任</span><br></pre></td></tr></table></figure>
<h4 id="进程输入输出重定向"><a href="#进程输入输出重定向" class="headerlink" title="进程输入输出重定向"></a>进程输入输出重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">重定向（在终端下如果，没有指明标准输入、标准输出、标准错误， 那么默认都是屏幕）</span><br><span class="line">标准输入 0， 标准输出 1， 标准错误 2， &gt; 替换， &gt;&gt; 追加</span><br><span class="line">&lt; 		将标准输入更改为某个文件</span><br><span class="line">&gt; 		默认将标准输入重定向， 和 1&gt; 完全等价</span><br><span class="line">2&gt; 		将标准错误重定向</span><br><span class="line">&amp; 		表示获取到某种类型管道（如果没有数字表示获取所有管道）， 如 &amp;1表示获取到标准输出</span><br><span class="line">tee 	多重输出</span><br><span class="line">如：command &gt; log.out 2&gt;&amp;1 &lt; /dev/null &amp;， 将标准输出重定向到我文件（此时标准输出1就是文件log.out）,  把标准错误重定向到标准输出中(最终也是文件中), 标准输入使用 /dev/null 文件， 并后台启动</span><br></pre></td></tr></table></figure>
<h4 id="！使用技巧"><a href="#！使用技巧" class="headerlink" title="！使用技巧"></a>！使用技巧</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">!!  上一个命令， 在缺少sudo的时候是非常有用的， sudo !!</span><br><span class="line">!n  运行历史的第n条命令</span><br><span class="line">!-n 运行历史的倒数第n条命令</span><br><span class="line">!*  使用上一个命令的所有参数： touch hello world,  rm -rf !*  删除刚才创建的两个文件</span><br><span class="line">!^  使用上一个命令的地一个参数: touch hello world, rm -rf !^ 删除hello文件</span><br><span class="line">!$ 使用上一个命令的最后一个参数 :  touch hello world,  rm -rf !$ 删除world文件</span><br><span class="line">!:-  使用上一个命令的除了最后一个参数所有的参数，包括命令:  touch hello world</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/28/linux-ubuntu-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/28/linux-ubuntu-setup/" itemprop="url">linux安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-28T15:19:37+08:00">
                2017-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,556
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="基本安装"><a href="#基本安装" class="headerlink" title="基本安装"></a>基本安装</h4><ul>
<li>安装的时候一定要使用网络安装， 用iphone提供网络， 安装网卡驱动</li>
</ul>
<h4 id="显卡安装"><a href="#显卡安装" class="headerlink" title="显卡安装"></a>显卡安装</h4><ul>
<li><p>完全卸载nvida显卡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove --purge nvidia*</span><br></pre></td></tr></table></figure>
</li>
<li><p>禁止加载 <code>/etc/modprobe.d/blacklist-nouveau.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset=0</span><br></pre></td></tr></table></figure>
</li>
<li><p>官网选择合适的cuda版本，安装完成后会默认安装最适合的nvida显卡驱动</p>
<ul>
<li><p>查看 <code>/lib/modprobe.d/blacklist-nvidia.conf</code>是否存在，如果存在就注释其中的内容</p>
</li>
<li><p>重新编译启动文件 <code>sudo update-initramfs -u</code></p>
</li>
<li><p>添加驱动盘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">/sbin/modprobe nvidia</span><br><span class="line"></span><br><span class="line">if [ &quot;$?&quot; -eq 0 ]; then</span><br><span class="line">  # Count the number of NVIDIA controllers found.</span><br><span class="line">  NVDEVS=`lspci | grep -i NVIDIA`</span><br><span class="line">  N3D=`echo &quot;$NVDEVS&quot; | grep &quot;3D controller&quot; | wc -l`</span><br><span class="line">  NVGA=`echo &quot;$NVDEVS&quot; | grep &quot;VGA compatible controller&quot; | wc -l`</span><br><span class="line"></span><br><span class="line">  N=`expr $N3D + $NVGA - 1`</span><br><span class="line">  for i in `seq 0 $N`; do</span><br><span class="line">    mknod -m 666 /dev/nvidia$i c 195 $i</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  mknod -m 666 /dev/nvidiactl c 195 255</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">/sbin/modprobe nvidia-uvm</span><br><span class="line"></span><br><span class="line">if [ &quot;$?&quot; -eq 0 ]; then</span><br><span class="line">  # Find out the major device number used by the nvidia-uvm driver</span><br><span class="line">  D=`grep nvidia-uvm /proc/devices | awk &apos;&#123;print $1&#125;&apos;`</span><br><span class="line"></span><br><span class="line">  mknod -m 666 /dev/nvidia-uvm c $D 0</span><br><span class="line">else</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="安装fusuma控制触摸板"><a href="#安装fusuma控制触摸板" class="headerlink" title="安装fusuma控制触摸板"></a>安装fusuma控制触摸板</h4><ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a $USER input #需要管理员权限执行，配置开机启动也可以不用</span><br><span class="line">sudo apt-get install libinput-tools</span><br><span class="line">sudo apt-get install xdotool</span><br><span class="line">gem install fusuma #使用ruby安装</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#确保开启多点触控</span><br><span class="line">gsettings set org.gnome.desktop.peripherals.touchpad send-events enabled</span><br><span class="line">#创建配置文件</span><br><span class="line">mkdir -p ~/config/fusum &amp;&amp; touch ~/.config/fusuma/config.yml</span><br><span class="line">#vi ~/.config/fusuma/config.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">swipe:</span><br><span class="line">  3:</span><br><span class="line">    left:</span><br><span class="line">      command: &apos;xdotool key alt+Left&apos;</span><br><span class="line">    right:</span><br><span class="line">      command: &apos;xdotool key alt+Right&apos;</span><br><span class="line">    up:</span><br><span class="line">      command: &apos;xdotool key ctrl+t&apos;</span><br><span class="line">    down:</span><br><span class="line">      command: &apos;xdotool key ctrl+w&apos;</span><br><span class="line">  4:</span><br><span class="line">    left:</span><br><span class="line">      command: &apos;xdotool key super+Left&apos;</span><br><span class="line">    right:</span><br><span class="line">      command: &apos;xdotool key super+Right&apos;</span><br><span class="line">    up:</span><br><span class="line">      command: &apos;xdotool key super+a&apos;</span><br><span class="line">    down:</span><br><span class="line">      command: &apos;xdotool key super+s&apos;</span><br><span class="line">pinch:</span><br><span class="line">  in:</span><br><span class="line">    command: &apos;xdotool key ctrl+plus&apos;</span><br><span class="line">  out:</span><br><span class="line">    command: &apos;xdotool key ctrl+minus&apos;</span><br><span class="line"></span><br><span class="line">threshold:</span><br><span class="line">  swipe: 1</span><br><span class="line">  pinch: 1</span><br><span class="line"></span><br><span class="line">interval:</span><br><span class="line">  swipe: 1</span><br><span class="line">  pinch: 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置开机启动， 参考下面的shadowsocks配置</p>
</li>
</ul>
<h4 id="wifi驱动安装后无法启动"><a href="#wifi驱动安装后无法启动" class="headerlink" title="wifi驱动安装后无法启动"></a>wifi驱动安装后无法启动</h4><ul>
<li><p>方式一</p>
<ul>
<li><p>查看网络信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ rfkill list</span><br><span class="line">  0:ideapad_wlan: Wireless LAN</span><br><span class="line">  Soft blocked: no</span><br><span class="line">  Hard blocked:yes				表示硬件阻塞没有开启</span><br><span class="line">  1:ideapad_bluetooth: Bluetooth</span><br><span class="line">  Soft blocked: no</span><br><span class="line">  Hard blocked: yes</span><br><span class="line">  2:phy0: Wireless LAN</span><br><span class="line">  Soft blocked: no</span><br><span class="line">  Hard blocked:no</span><br><span class="line">  3:hci0: Bluetooth</span><br><span class="line">  Soft blocked: yes				表示软件阻塞没有安装驱动</span><br><span class="line">  Hard blocked: no</span><br></pre></td></tr></table></figure>
</li>
<li><p>移除ideapad模块， 后面的没有阻塞的模块可以启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe -r ideapad_laptop</span><br><span class="line">$ rfkill list</span><br><span class="line">  2:phy0: Wireless LAN</span><br><span class="line">  Soft blocked: no</span><br><span class="line">  Hard blocked:no</span><br><span class="line">  3:hci0: Bluetooth</span><br><span class="line">  Soft blocked: yes</span><br><span class="line">  Hard blocke</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置开机启动禁止ideapad模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">创建/etc/modprobe.d/my_blacklist.conf文件block掉ideapad模块，这样没有重启就不用手动block</span><br><span class="line">blacklist ideapad_laptop</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>方法二</p>
<ul>
<li><p>直接添加ideap_wlan的模块到内核当中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git dkms build-essential</span><br><span class="line">git clone https://github.com/jeremyb31/ideapad-laptop.git</span><br><span class="line">sudo dkms add ./ideapad-laptop</span><br><span class="line">sudo dkms install ideapad-laptop/1.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装iwlwifi驱动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install build-essential git</span><br><span class="line">git clone https://git.kernel.org/pub/scm/linux/kernel/git/iwlwifi/backport-iwlwifi.git</span><br><span class="line">cd backport-iwlwifi</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br><span class="line">sudo -i</span><br><span class="line">echo &quot;options iwlwifi disable_msix=1&quot;  &gt;&gt;  /etc/modprobe.d/iwlwifi.conf</span><br><span class="line">exit</span><br><span class="line">如果需要升级kernel需要重新安装</span><br><span class="line">cd backport-iwlwifi</span><br><span class="line">sudo make clean</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="开机自动启动"><a href="#开机自动启动" class="headerlink" title="开机自动启动"></a>开机自动启动</h4><ul>
<li><p>方式一</p>
<ul>
<li><p>以systemctl创建shadowsockets开机启动为例子</p>
</li>
<li><p>sudo vim /etc/systemd/system/shadowsocks.service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks Client Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line">ExecStart=/usr/bin/sslocal -c /home/xx/Software/ShadowsocksConfig/shadowsocks.json</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>把/home/xx/Software/ShadowsocksConfig/shadowsocks.json修改为你的shadowsocks.json路径，如：/etc/shadowsocks.json</p>
</li>
<li><p>生效配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable /etc/systemd/system/shadowsocks.service</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>方式二</p>
<ul>
<li>直接启动Startup Applications程序， 填写需要执行的命令和参数</li>
</ul>
</li>
</ul>
<h4 id="系统问题修复"><a href="#系统问题修复" class="headerlink" title="系统问题修复"></a>系统问题修复</h4><ol>
<li><p>查看dmesg日志， 并且google错误信息</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dmesg	查看系统日志</span><br></pre></td></tr></table></figure>
</li>
<li><p>系统卡死现象</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ctrl + Alt + F1 ~ F6    进入tty1 ~ tty6模式</span><br><span class="line">Ctrl + Alt + F7         恢复到桌面模式</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="快捷键冲突问题"><a href="#快捷键冲突问题" class="headerlink" title="快捷键冲突问题"></a>快捷键冲突问题</h4><ol>
<li><p>设置fcitx 网易云音乐</p>
</li>
<li><p>更改系统快捷键， 不常用的建议都去掉，保留下列即可</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Ctrl + Alt + t        打开终端</span><br><span class="line">Ctrl + Super + up     放大应用</span><br><span class="line">Ctrl + Super + down   缩小应用</span><br><span class="line">Super + d             关闭/显示桌面</span><br><span class="line">Super + l             锁住桌面</span><br><span class="line">Super + w             显示打开的应用</span><br><span class="line">Super                 显示左边栏并打开搜索</span><br><span class="line">Super + Tab           显示左边栏并上下切换打开应用</span><br><span class="line">Alt [+ SHift] +       [向前]向后切换应用</span><br><span class="line">Alt + F4              关闭应用</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装compizconfig-settings-manager继续修改快捷键(可选)</p>
</li>
<li><p>关闭关闭tty防止ctrl + alt + F1-12的影响</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># sudo vi /usr/share/X11/xorg.conf.d/50-novtswitch.conf</span><br><span class="line">Section &quot;ServerFlags&quot;</span><br><span class="line">  Option &quot;DontVTSwitch&quot; &quot;true&quot;</span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置idea <a href="http://yangbingdong.com/2017/note-of-learning-idea-under-ubuntu/" target="_blank" rel="noopener">博客</a></p>
</li>
<li><p>使用gsetting设置快捷键, 如更改全局快捷键 <code>ctrl alt s</code>键</p>
<ol>
<li><p>找到快捷键的使用key值 <code>gsettings list-recursively | grep -i \&gt;s\&#39;</code></p>
</li>
<li><p>设置key绑定的快捷键为空</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gsettings set org.gnome.shell.extensions.screenshot-window-sizer cycle-screenshot-sizes [&apos;&apos;]</span><br><span class="line">gsettings set org.gnome.shell.extensions.screenshot-window-sizer cycle-screenshot-sizes-backward [&apos;&apos;]</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="其它可选选项"><a href="#其它可选选项" class="headerlink" title="其它可选选项"></a>其它可选选项</h4><ol>
<li><p>安装限制程序</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt-get install ubuntu-restricted-extras ubuntu-restricted-addons</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>安装字体</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ttf-mscorefonts-installer</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.de.debian.org/debian/pool/contrib/m/msttcorefonts/ttf-mscorefonts-installer_3.7_all.deb -P ~/Downloads</span><br><span class="line">sudo gdebi ~/Downloads/ttf-mscorefonts-installer_3.7_all.deb</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/fangwentong/dotfiles/raw/master/ubuntu-gui/fonts/Monaco.ttf</span><br><span class="line">sudo mkdir -p /usr/share/fonts/custom</span><br><span class="line">sudo mv Monaco.ttf /usr/share/fonts/custom</span><br><span class="line">sudo chmod 744 /usr/share/fonts/custom/Monaco.ttf</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/share/fonts/WindowsFonts</span><br><span class="line">cp /Windowsdrive/Windows/Fonts/* /usr/share/fonts/WindowsFonts 复制windows中的字体</span><br><span class="line">chmod 755 /usr/share/fonts/WindowsFonts/*</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfontscale  #生成核心字体信息</span><br><span class="line">sudo mkfontdir</span><br><span class="line">sudo fc-cache -f -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>sudoer</code> 的环境变量 PATH， 在 <code>.bashrc</code> 中添加方法</p>
<ul>
<li><p>使用其它命令代替sudo命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psudo() &#123; sudo env PATH=&quot;$PATH&quot; &quot;$@&quot;; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>完全覆盖sudo命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo() &#123; command sudo env PATH=&quot;$PATH&quot; &quot;$@&quot;; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明： </strong> command 命令防止命令自身递归调用</p>
</li>
</ul>
</li>
<li><p>温度监控</p>
<ol>
<li>sudo apt-get install lm-sensors hddtemp</li>
<li>sudo sensors-detect</li>
<li>sensors（查看硬件实时温度）</li>
<li>sudo apt-get install psensor</li>
<li>安装成功后，打开psensor，在Sensor Preferences中选择需要的硬件勾选Display sensor in the label</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/26/hadoop-map-reduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/26/hadoop-map-reduce/" itemprop="url">MapReduce使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T14:42:39+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/MapReduce/" itemprop="url" rel="index">
                    <span itemprop="name">MapReduce</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,619
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><ol>
<li>MapReduce是一个简单的计算处理框架, 它能够在一个廉价的大型集群上以一种容错的方式并行的处理TB级的数据。</li>
<li><p>一个MapRecude任务通常讲输入数据集进行分块, 并且以完全并行的方式处理map任务, 框架对map任务输出进行。排序, 并作为reduce任务的输入, 通常任务的输入和输出都存储在文件系统, 框架负责处理协调、监控并重运行失败的任务。</p>
</li>
<li><p>通常情况下计算节点和存储节点都是在同一个HDFS(如果MapReduce以HDFS作为文件系统)的datenode中， 这种<br>配置允许框架能够有效的协调任务在已经存在数据的节点中运行，这通常在集群中对网络带宽非常友好。</p>
</li>
<li>MapReduce也可以通过yarn（分布式资源协调工具）来运行， 并且为每一个MapReduce任务创建一个MRAppMaster负责从yarn的ResourceManager申请协调资源和对MapReduce任务进行监控和管理。</li>
<li>最小的一个MapReduce任务由一个输入输出、实现特定接口的map和reduce方法、以及一个job配置， job客户端提交任务， ResouceManager对任务进行协调监控并提供诊断信息给客户端。</li>
<li>虽然Hadoop框架是使用java运行， 但是MapReduce应用却不要求一定使用java编写， 如Hadoop Streaming允许用户使用任何可执行的shell（能够在shell命令中执行） 创建并运行mapper或者reducer， Hadoop Pipes以一个SWIG兼容的C++ API来实现MapReduce任务（而不是基于JNI）</li>
</ol>
<h4 id="输入和输出"><a href="#输入和输出" class="headerlink" title="输入和输出"></a>输入和输出</h4><ol>
<li>MapReduce框架操作唯一的&lt;key, value&gt;对，框架输入&lt;key, value&gt;对， 并产生&lt;key, value&gt;对作为输出，key和value需要在框架中通过RPC或者文件的方式进行传输， 所以必须序列化， 框架提供Writable接口作为序列化的基础， 另外框架需要通过key来对&lt;key, value&gt;对进行排序， 所以必须实现WritableComparable接口， 虽然key没有要求必须实现hashcode方法， 但是map任务后的reduce任务通常需要对&lt;key, value&gt;行partition， 而通过hash来进行partition却是默认的方式。</li>
</ol>
<h4 id="简单的例子"><a href="#简单的例子" class="headerlink" title="简单的例子"></a>简单的例子</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenizerMapper</span></span></span><br><span class="line"><span class="class">       <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//创建单实例的对象， 减少对象的创建</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> IntWritable one = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> Text word = <span class="keyword">new</span> Text();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context</span></span></span><br><span class="line"><span class="function"><span class="params">                    )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">      <span class="comment">//输入的key其实是一个相对于文件的偏移量， value为每一行的数据</span></span><br><span class="line">      <span class="comment">//所以读取文件必须有一个格式， 并且讲文件split给每个map任务，这里由InputFormat提供</span></span><br><span class="line">      StringTokenizer itr = <span class="keyword">new</span> StringTokenizer(value.toString());</span><br><span class="line">      <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">        word.set(itr.nextToken());</span><br><span class="line">        context.write(word, one);<span class="comment">//将split的单词和数量输出&lt;workd, count&gt;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntSumReducer</span></span></span><br><span class="line"><span class="class">       <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IntWritable result = <span class="keyword">new</span> IntWritable();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                       Context context</span></span></span><br><span class="line"><span class="function"><span class="params">                       )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">        sum += val.get();</span><br><span class="line">      &#125;</span><br><span class="line">      result.set(sum);</span><br><span class="line">      context.write(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">    Job job = Job.getInstance(conf, <span class="string">"word count"</span>);</span><br><span class="line">    job.setJarByClass(WordCount.class);</span><br><span class="line">    job.setMapperClass(TokenizerMapper.class);</span><br><span class="line">    <span class="comment">//指定Combiner进行本地Reducer任务执行， 主要是这里的reducer任务具有操作无序性质， 所以</span></span><br><span class="line">    <span class="comment">//本地的reducer一般用来减小mapper到reducer的带宽， 对于速度上可能并不明显</span></span><br><span class="line">    job.setCombinerClass(IntSumReducer.class);</span><br><span class="line">    job.setReducerClass(IntSumReducer.class);</span><br><span class="line">    job.setOutputKeyClass(Text.class);</span><br><span class="line">    job.setOutputValueClass(IntWritable.class);</span><br><span class="line">    FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line">    <span class="comment">//等待任务完成， 返回job客户端， 也可以执行返回</span></span><br><span class="line">    System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行应用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/hadoop jar wc.jar WordCount /user/joe/wordcount/input /user/joe/wordcount/output</span><br></pre></td></tr></table></figure></p>
<p>为MapReduce任务提供ClassPath和work dir提供资源<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/hadoop jar hadoop-mapreduce-examples-&lt;ver&gt;.jar wordcount -files dir1/dict.txt#dict1,dir2/dict.txt#dict2 -archives mytar.tgz#tgzdir input output</span><br></pre></td></tr></table></figure></p>
<p><em>说明：</em> -files 提供文件到任务work dir中， 通过逗号分割， 使用#号取别名, -archives 提供文件并且解压缩到work dir， 通过都好分割， 使用#号取别名， 两者指定的文件可以在MapReduce任务中获取</p>
<h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><ol>
<li>Hadoop MapReduce通过InputFormat将输入的files进行split并创建一任意个InputSplit，并为每个InputSplit创建一个map任务用来执行这个InputSplit表示的逻辑文件， map任务通过RecordReader来读取InputSplit这个逻辑文件， 并生成map的输入对&lt;key1, value1&gt;, InputSplit和RecordReader都是由InputFormat创建。</li>
<li><p>Mapper类是执行map任务的核心， 它循环的执行RecordReader产生的&lt;key1, value1&gt;对， 并且在执行任何的&lt;key1, value1&gt;对之前可以对Mapper进行初始化操作，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mapper.setup(Context)</span><br><span class="line">Mapper.run(Context) # 用于提供map操作的模板方法， Mapper调用的方法</span><br><span class="line">Mapper.map(key, value, Context)</span><br><span class="line">Mapper.cleanup(Context)</span><br></pre></td></tr></table></figure>
</li>
<li><p>MapReduce 输出对不需要和输入对有任何的联系， 输入对可以map出零个或者多个输出对， 通过<code>context.write()</code>输出。</p>
</li>
<li>用户可以指定combiner对mapper产生的输出进行聚合， 这样可能会加快速度和减少网络带宽， 其实combiner就是一个reducer， 只是它单纯的对当前map任务的所有输出进行reduce任务操作， 操作完成之后再传给总的reduce来进行处理， 所以可以看到此处的reduce任务必须具有无序性， 其次reducer也可以接受并非只是mapper的中间结果&lt;key2, value2&gt;, 也可以接受&lt;key2, [value2, vlaue3…]&gt;</li>
<li>map任务的个数通常是通过输入文件的总大小，也就是总的输入文件的块， 正确的并发map任务通常每个节点10-100个， 通常对于轻量级cpu任务开启300个map任务， 因为一般情况下map需要从磁盘获取数据， 并进行简单操作， 所以通常都是io密集型而对cpu不敏感， map任务的创建需要时间， 所以最好map任务执行超过一分钟。</li>
</ol>
<h4 id="Partitioner"><a href="#Partitioner" class="headerlink" title="Partitioner"></a>Partitioner</h4><ol>
<li>Partitioner是用map产生的中间结果&lt;key1, value1&gt;的key空间来对每个map任务的的中间结果进行分区的， 通常情况下是通过hash来进行分区， 总的分区数量和reduce任务的分区数量是一样的。</li>
</ol>
<h4 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><p>Reducer 用来reduce Mapper任务产生的中间结果， 当Mapper产生结果后， 通过Partitioner将具体&lt;key2, value2&gt;或者是&lt;key2, [vlaue2, value3…]&gt;(经过combiner之后的结果)传输到具体的Reducer当中， 具体的某个Reducer收到所有Mapper需要传输到自己的&lt;key2, value2/[value2, value3…]&gt;之后， 对其进行shuffle、sort和最终的reduce</p>
<ol>
<li>Shuffle 讲所有从Mapper中获取的结果进行shuffle成&lt;value2, [value2, value3…]&gt;</li>
<li>Sort 对shuffle结果进行排序，shuffle和sort是同时进行的， 排序方式可以通过<code>Job.setSortComparatorClass(Class)</code>来提供， 此处是对key进行排序</li>
<li>Secondary Sort 如果需要对相同key的values进行排序可以指定<code>Job.setGroupingComparatorClass(Class)</code>来对value进行排序</li>
<li>Reduce 对当前Reducer收到并处理的&lt;key2, [value2, value3…]&gt;进行reduce操作， 用来产生&lt;key3, value3&gt;输出到文件系统中，reduce输出没有排序。reduce在操作之前和之后可以和map进行相同的初始化或者结束回调。</li>
<li>reduce的数量通常在[0.95~1.75] <em> <num of="" nodes=""> </num></em> <num of="" max="" container="" per="" node=""> 之间， 当maps任务执行完后， 指定倍数为0.95时所有的reducers可以立即启动并且执行传输map的输出， 当为1.75时最快的节点将会完成它们第一轮并且执行第二轮， 有助于负载均衡。 增加的reduces的数量虽然增加了负载， 但是增加了负载均衡的能力， 并且减小了失败造成的消耗。</num></li>
</ol>
<h4 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h4><p>Counter 是一个用来报告统计的基础设施， Mapper和Reducer实现可以使用Counter来报告统计信息。</p>
<h4 id="Job-Configuration"><a href="#Job-Configuration" class="headerlink" title="Job Configuration"></a>Job Configuration</h4><ol>
<li>Job代表一个MapReduce的任务配置， 通常用来配置InputFormat、Mapper、combiner（如果有）、Partitioner、Reducer、OutputFormat的实现</li>
<li><p>FileInputFormat和FileOutpuFormat配置输入和输出格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FileInputFormat.setInputPaths(Job, Path…) FileInputFormat.addInputPath(Job, Path)</span><br><span class="line">FileInputFormat.setInputPaths(Job, String…) FileInputFormat.addInputPaths(Job, String)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Job通常需要指定先进的参数， 如Comparator、文件put到DistributedCache、是否使用compressed、是否speculative执行以及map和reduce最大的attempts</p>
</li>
<li>当然Job还可以使用Configuration的get/set来获取和设置更多的参数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Configuration.set(String, String)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="任务执行和环境变量"><a href="#任务执行和环境变量" class="headerlink" title="任务执行和环境变量"></a>任务执行和环境变量</h4><ol>
<li>MRAppMaster使用隔离jvm的一个子进程去执行Mapper/Reducer任务， 子进程继承父进程的环境变量， 用户可以指定额外的子进程虚拟机启动参数，如下：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- @taskid@ 表示MapReduce任务id--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.java.opts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">  -Xmx512M -Djava.library.path=/home/mycompany/lib -verbose:gc -Xloggc:/tmp/@taskid@.gc</span><br><span class="line">  -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.reduce.java.opts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">  -Xmx1024M -Djava.library.path=/home/mycompany/lib -verbose:gc -Xloggc:/tmp/@taskid@.gc</span><br><span class="line">  -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="任务提交和监控"><a href="#任务提交和监控" class="headerlink" title="任务提交和监控"></a>任务提交和监控</h4><ol>
<li>Job是一个原始的接口， 用于用户job与ResourceManager交互， Job提供的基本功能是提交任务、跟踪任务进程、访问任务的报告和日志和获取MapRecude集群状态等信息， job提交任务涉及到下面几个方面：<ul>
<li>检查任务的输入输出</li>
<li>计算InputFormat的InputSplit</li>
<li>为任务分布式缓存设置必要的账号信息</li>
<li>复制任务jar和配置信息到MapReduce系统目录</li>
<li>提交任务到ResourceManager并选择是否监控它的状态</li>
</ul>
</li>
<li><p>任务历史日志记录在两个指定的目录当中， 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mapreduce.jobhistory.intermediate-done-dir</span><br><span class="line">mapreduce.jobhistory.done-dir</span><br></pre></td></tr></table></figure>
</li>
<li><p>用户可以查看任务运行历史日志总览</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mapred job -history [all] output.jhist</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Job-输入"><a href="#Job-输入" class="headerlink" title="Job 输入"></a>Job 输入</h4><ol>
<li>InputFormat 描述MapReduce任务的输入，主要功能如下：<ul>
<li>验证任务输入</li>
<li>split 所有的输入文件为逻辑的InputSplit实例， 每一个InputSplit相当于一个Mapper任务</li>
<li>提供RecordReader实现， 用于Mapper任务启动时从InputSplit中获取单个&lt;key1, value1&gt;记录</li>
</ul>
</li>
<li>默认基于文件的输入是FileInputFortmat， 它通过总文件大小来split出逻辑的InputSplit， 显然通过总大小来分割有时候是无效的， 因为RecordReader无法获取记录的边界</li>
</ol>
<h4 id="Job输出"><a href="#Job输出" class="headerlink" title="Job输出"></a>Job输出</h4><ol>
<li>OutputFormat 描述MapReduce任务的输出， 主要功能如下：<ul>
<li>验证任务输出， 如：检查输出文件是否存在</li>
<li>提供RecorderWriter实现， 用于写入任务输出， Output文件存储到文件系统</li>
</ul>
</li>
<li>OutputCommiter 描述MapReduce任务输出提交， OutputCommiter的主要功能如下：<ul>
<li>初始化设置， 如：为任务创建临时输出目录， 任务的初始化设置是在单独的任务中完成的， 初始化之前任务处在<code>PREP</code>状态， 初始化完成后处在<code>RUNNING</code>状态</li>
<li>任务完成后的清理动作， 如：删除零时输出目录， 任务的清理工作也是在单独的任务中， 清理工作完成后任务可能出现<code>SUCCEDED/FAILED/KILLED</code>状态</li>
<li>检查任务是否需要提交</li>
<li>一旦任务完成就提交任务的输出</li>
<li>如果任务失败， 任务输出将会被清理， 并且丢弃任务提交， 如果任务不能清理， 一个相同attempt-id的任务将会单独启动并执行清理动作</li>
</ul>
</li>
<li>RecordWriter 负责讲Reducer的输出&lt;key3, value3&gt;输出到文件系统， 并且负责讲job的outputs输出到文件系统</li>
</ol>
<h4 id="提交Job到队列"><a href="#提交Job到队列" class="headerlink" title="提交Job到队列"></a>提交Job到队列</h4><ol>
<li>用户提交任务到队列当中， 队列作为一个任务集合允许系统提供指定的功能， 如队列使用ACLs控制那个用户可以提交任务到队列， 在Hadoop中默认就是使用队列作为调度器来调度任务。</li>
<li>Hadoop中存在一个叫做default的队列用于用户默认的任务提交队列， 用户也可以通过<code>Configuration.set(MRJobConfig.QUEUE_NAME, String)</code>指定将任务提交到特定名字的队列当中， 并且Hadoop还提供了一个可插拔的<code>Capacity Scheduler</code>用来支持多租户， 提供资源的隔离， 所以它存在多个队列。</li>
</ol>
<h4 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h4><ol>
<li>Counters代表全局的计数器， 可以被MapReduce框架或者应用定义， 每一个Counter可以是一个Enum， 特定的Enum的Counter被集中到特定的Counters.Group当中， 应用可以定义任意的Enum并且<code>Counter.incrCounter(Enum, long)</code>或者<code>Counter.incrCounter(String, String, long)</code>到map或者reduce方法当中， 这些counters被框架自动聚合。</li>
</ol>
<h4 id="分布式缓存"><a href="#分布式缓存" class="headerlink" title="分布式缓存"></a>分布式缓存</h4><ol>
<li>分布式的缓存用于有效的存储特定应用大型只读的文件， 它是被MapReduce框架提供的基础设施用于缓存应用需要的文本、归档和jar文件等等</li>
<li>Job中的应用通过<code>hdfs://</code>指定被缓的文件， 分布式的缓存假设被指定<code>hdfs://</code>的文件已经存在于文件系统当中</li>
<li>框架将会在任何任务被执行之前，复制必须的文件到worker节点， 事实上它是相当有效的， 文件只会被复制一次， 并且un-archive到work节点</li>
<li>分布式的缓存跟踪缓存文件的修改时间戳， 显然分布式的缓存文件是不能被任何的修改</li>
<li>文件、归档、jar/native lib都可以被缓存， 可以通过property设置， 或者通过Job添加， 如：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Job.addCacheFile(URI) / Job.addCacheArchive(URI)</span><br><span class="line">Job.AddArchiveToClassPath(Path) / JOb.addFileToClassPath(Path)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>URI: hdfs://host:port/absolute-path#link-name</p>
<ol start="6">
<li>分布式的缓存文件可以是私有或公用， 这决定了它们是怎样被worker节点所共享的， 主要是通过分布式文件的用户和文件的可见性来决定</li>
</ol>
<p>####　Debugging</p>
<ol>
<li>MapReduce框架提供当任务失败时执行用户指定脚本的功能， 脚本可以访问任务的标准输出、标准错误、系统日志和任务配置， 脚本处理访问的信息并输出错误信息到控制台或者任务UI</li>
<li>Debugging脚本的使用步骤：<ul>
<li>提交脚本到分布式缓存中</li>
<li>提交脚本到map或者reduce当中， 使用property或者Configuration</li>
<li>脚本访问 $script $stdout $stderr $syslog $jobconf</li>
</ul>
</li>
</ol>
<h4 id="数据压缩"><a href="#数据压缩" class="headerlink" title="数据压缩"></a>数据压缩</h4><ol>
<li>MapReduce提供map和reduce应用输出压缩功能， 为了性能它使用本地实现</li>
</ol>
<h4 id="跳过错误的记录"><a href="#跳过错误的记录" class="headerlink" title="跳过错误的记录"></a>跳过错误的记录</h4><ol>
<li>Hadoop可以通过<code>ShipBadRecords</code>类来控制map输入的错误记录， 对于某些应用来说如果少量的错误记录是可以接受的那么可以开启此功能， 使用<code>SkipBadRecords.set[Mapper|Reducer]MaxSkipGroups(Configuration, long)</code>来设置最大的错误记录数量。</li>
</ol>
<h4 id="复杂的例子"><a href="#复杂的例子" class="headerlink" title="复杂的例子"></a>复杂的例子</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Counter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenizerMapper</span></span></span><br><span class="line"><span class="class">       <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 提供counter功能</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">enum</span> CountersEnum &#123; INPUT_WORDS &#125;</span><br><span class="line">    <span class="comment">// 减少对象的创建</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> IntWritable one = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> Text word = <span class="keyword">new</span> Text();</span><br><span class="line">    <span class="comment">// 提供单词大小写敏感和模式忽略功能</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> caseSensitive;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; patternsToSkip = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Configuration conf;</span><br><span class="line">    <span class="keyword">private</span> BufferedReader fis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在setup中处理Mapper的初始化动作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        InterruptedException </span>&#123;</span><br><span class="line">      <span class="comment">// 获取配置</span></span><br><span class="line">      conf = context.getConfiguration();</span><br><span class="line">      <span class="comment">// 获取Job中设置的环境变量</span></span><br><span class="line">      caseSensitive = conf.getBoolean(<span class="string">"wordcount.case.sensitive"</span>, <span class="keyword">true</span>);</span><br><span class="line">      <span class="comment">// 解析配置</span></span><br><span class="line">      <span class="keyword">if</span> (conf.getBoolean(<span class="string">"wordcount.skip.patterns"</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取并解析缓存</span></span><br><span class="line">        URI[] patternsURIs = Job.getInstance(conf).getCacheFiles();</span><br><span class="line">        <span class="keyword">for</span> (URI patternsURI : patternsURIs) &#123;</span><br><span class="line">          Path patternsPath = <span class="keyword">new</span> Path(patternsURI.getPath());</span><br><span class="line">          String patternsFileName = patternsPath.getName().toString();</span><br><span class="line">          parseSkipFile(patternsFileName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSkipFile</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(fileName));</span><br><span class="line">        String pattern = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((pattern = fis.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">          patternsToSkip.add(pattern);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        System.err.println(<span class="string">"Caught exception while parsing the cached file '"</span></span><br><span class="line">            + StringUtils.stringifyException(ioe));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context</span></span></span><br><span class="line"><span class="function"><span class="params">                    )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">      <span class="comment">// 处理单词大小写敏感和模式忽略功能</span></span><br><span class="line">      String line = (caseSensitive) ?</span><br><span class="line">          value.toString() : value.toString().toLowerCase();</span><br><span class="line">      <span class="keyword">for</span> (String pattern : patternsToSkip) &#123;</span><br><span class="line">        line = line.replaceAll(pattern, <span class="string">""</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      StringTokenizer itr = <span class="keyword">new</span> StringTokenizer(line);</span><br><span class="line">      <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">        word.set(itr.nextToken());</span><br><span class="line">        context.write(word, one);</span><br><span class="line">        <span class="comment">// counter计数， 会在日志中打印</span></span><br><span class="line">        Counter counter = context.getCounter(CountersEnum.class.getName(),</span><br><span class="line">            CountersEnum.INPUT_WORDS.toString());</span><br><span class="line">        counter.increment(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntSumReducer</span></span></span><br><span class="line"><span class="class">       <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IntWritable result = <span class="keyword">new</span> IntWritable();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                       Context context</span></span></span><br><span class="line"><span class="function"><span class="params">                       )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">        sum += val.get();</span><br><span class="line">      &#125;</span><br><span class="line">      result.set(sum);</span><br><span class="line">      context.write(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 配置解析</span></span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">    GenericOptionsParser optionParser = <span class="keyword">new</span> GenericOptionsParser(conf, args);</span><br><span class="line">    String[] remainingArgs = optionParser.getRemainingArgs();</span><br><span class="line">    <span class="keyword">if</span> ((remainingArgs.length != <span class="number">2</span>) &amp;&amp; (remainingArgs.length != <span class="number">4</span>)) &#123;</span><br><span class="line">      System.err.println(<span class="string">"Usage: wordcount &lt;in&gt; &lt;out&gt; [-skip skipPatternFile]"</span>);</span><br><span class="line">      System.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Job job = Job.getInstance(conf, <span class="string">"word count"</span>);</span><br><span class="line">    <span class="comment">// 基本设置</span></span><br><span class="line">    job.setJarByClass(WordCount2.class);</span><br><span class="line">    job.setMapperClass(TokenizerMapper.class);</span><br><span class="line">    job.setCombinerClass(IntSumReducer.class);</span><br><span class="line">    job.setReducerClass(IntSumReducer.class);</span><br><span class="line">    job.setOutputKeyClass(Text.class);</span><br><span class="line">    job.setOutputValueClass(IntWritable.class);</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; otherArgs = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; remainingArgs.length; ++i) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"-skip"</span>.equals(remainingArgs[i])) &#123;</span><br><span class="line">        <span class="comment">// 设置缓存</span></span><br><span class="line">        job.addCacheFile(<span class="keyword">new</span> Path(remainingArgs[++i]).toUri());</span><br><span class="line">        <span class="comment">// 设置环境变量</span></span><br><span class="line">        job.getConfiguration().setBoolean(<span class="string">"wordcount.skip.patterns"</span>, <span class="keyword">true</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        otherArgs.add(remainingArgs[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置输入与输出</span></span><br><span class="line">    FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs.get(<span class="number">0</span>)));</span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(otherArgs.get(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">    System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>命令行执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ bin/hadoop fs -ls /user/joe/wordcount/input/</span><br><span class="line">/user/joe/wordcount/input/file01</span><br><span class="line">/user/joe/wordcount/input/file02</span><br><span class="line"></span><br><span class="line">$ bin/hadoop fs -cat /user/joe/wordcount/input/file01</span><br><span class="line">Hello World, Bye World!</span><br><span class="line"></span><br><span class="line">$ bin/hadoop fs -cat /user/joe/wordcount/input/file02</span><br><span class="line">Hello Hadoop, Goodbye to hadoop.</span><br><span class="line"></span><br><span class="line">$ bin/hadoop fs -cat /user/joe/wordcount/patterns.txt</span><br><span class="line">\.</span><br><span class="line">\,</span><br><span class="line">\!</span><br><span class="line">to</span><br><span class="line"></span><br><span class="line">$ bin/hadoop jar wc.jar WordCount2 -Dwordcount.case.sensitive=false /user/joe/wordcount/input /user/joe/wordcount/output -skip /user/joe/wordcount/patterns.txt</span><br><span class="line"></span><br><span class="line">$ bin/hadoop fs -cat /user/joe/wordcount/output/part-r-00000</span><br><span class="line">bye 1</span><br><span class="line">goodbye 1</span><br><span class="line">hadoop 2</span><br><span class="line">hello 2</span><br><span class="line">horld 2</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/26/docker-dockerfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/26/docker-dockerfile/" itemprop="url">Dockerfile 详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T11:32:01+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,787
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><ol>
<li>docker 每一条命令都会创建一层， 并且会使用上一层的镜像运行一个docker容器， 再执行本层的命令，执行完成之后就提交停止容器， 并提交当前容器的修改为一个镜像</li>
<li>当容器开始构建的时候， 第一步会将指定的context目录下的所有的文件都传递给docker守护进程（除了.dockerignore文件标识的文件除外), 第二步启动FROM image指定的镜像的容器， 并执行下面一条命令，关闭当前容器并提交一层镜像， 以后各层都是如此，以上一层的镜像运行一个容器并执行命令后提交镜像<br>所以我们可以看到命令越多则层数越多， 建议尽量使用最少的层， 并且将相关的动作描述清晰使其容易维护</li>
</ol>
<p><em>注意</em> 妥善使用下面点： 基础镜像选择， 使用两种环境变量， 组合命令</p>
<h5 id="设置基础镜像"><a href="#设置基础镜像" class="headerlink" title="设置基础镜像"></a>设置基础镜像</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span><br></pre></td></tr></table></figure>
<h5 id="设置LABEL"><a href="#设置LABEL" class="headerlink" title="设置LABEL"></a>设置LABEL</h5><p>LABEL用来标示当前镜像， 作为一种元数据存在与镜像当中， 作为一种描述<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LABEL com.ilivoo.game=&quot;fengxiang&quot; \</span><br><span class="line">      version=&quot;1.0&quot; \</span><br><span class="line">      description=&quot;this is my first game!&quot;</span><br></pre></td></tr></table></figure></p>
<h5 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h5><p>设置docker容器运行时的环境变量， 并且可以在构建的过程中使用这些命令， 其实道理很简单， 以后的构建过程中都是使用上一个镜像层作为基础， 而运行的时候启动容器这个<br>环境变量就已经生成了， 所以后面的RUN 等命令当然也是可以获取到这个环境变量的， 所以脚本引用方式与正查的脚本完全一样, 可以看到巧妙的设计环境变量可以使得构建过程<br>非常灵活， 并且运行时容器也非常灵活<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV VERSION=1.0 \</span><br><span class="line">    DEBUG=on</span><br></pre></td></tr></table></figure></p>
<h5 id="设置ARG参数"><a href="#设置ARG参数" class="headerlink" title="设置ARG参数"></a>设置ARG参数</h5><p>ARG命令也是用来设置环境变量的， 但是ARG设置的环境变量不会保留到最终容器运行的层当中, 其实实现也非常简单当运行容器的时候设置环境变量， 并且在容器退出的时候就将环境变量删除就可以达到此目的了, 并且此参数可以通过–build-arg参数在构建的时候进行覆盖，这样就可以达到非常灵活的效果了虽然ARG环境变量不会保存到运行是环境变量， 但是也不能使用敏感数据， 因为使用history会查看到其值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARG REDIS_VERSION=3.2.10</span><br></pre></td></tr></table></figure></p>
<h5 id="环境变量与ARG参数结合使用"><a href="#环境变量与ARG参数结合使用" class="headerlink" title="环境变量与ARG参数结合使用"></a>环境变量与ARG参数结合使用</h5><ol>
<li><p>通过在构建的时候覆盖当前–build-arg NAME=FENGXIANG此时后面设置的环境变量FENG就变成了FENGXIANG, 可以看到虽然环境变量不能通过参数的形式进行改变但是这里确提供了灵活的方式<br>来达到环境变量的不同， 所以通过脚本来构建就可以达到非常灵活的效果， 所以在我们的代码当中需要进行灵活变化的变量应该使用环境变量来进行设置， 这样就可以达到任何<br>代码都不需要更改确有一个灵活的生产 测试 线上环境， 这个非常重要</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ARG NAME=XIANG</span><br><span class="line">ENV FENG=$&#123;NAME&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>建议将那些需要进行覆盖的ARG使用这种方式给出， 并且在使用的时候通过字符串获取的方式来获得， 此处标示如果COMPANY不存在那么默认值就是ilivoo<br>通过这种方式能够非常明显标示当前ARG用来进行占位的， 真正使用的时候可以进行指定， 并且最好是通过注释的方式标示可以指定的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ARG COMPANY</span><br><span class="line">ENV COMPANY $&#123;COMPANY:-ilivoo&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="指定工作目录"><a href="#指定工作目录" class="headerlink" title="指定工作目录"></a>指定工作目录</h5><p>指定docker构建的以后的各层当中都使用指定的这个目录作为工作目录， 也就是以后命令执行的当前目录都是这个目录，如：CMD [“./start.sh”], 这个命令默认就去查找这个目录下<br>对应的脚本， 如果不存在则报错， 并且每次设置都会更改以后的所有层， 可以覆盖。 所以建议再构建镜像的时候只有在最终执行命令的时候再去指定这个目录， 构建最终层镜像的<br>时候显示的指定每个工作的目录是一个非常不错的选择<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /app</span><br></pre></td></tr></table></figure></p>
<h5 id="指定执行用户"><a href="#指定执行用户" class="headerlink" title="指定执行用户"></a>指定执行用户</h5><p>USER和WORKDIR命令类似， 都是改变环境状态并影响以后的层， 而USER则是更改RUN CMD ENTRYPOINT这类动作命的身份， 用户必须事先建立好。<br>如果以root执行脚本， 在执行容器的时候希望使用特定的身份执行容器， 不建议使用sudo命令， 这样会非常麻烦，而且容易出错，建议使用gosu来控制， 借鉴redis的做法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USER root</span><br></pre></td></tr></table></figure></p>
<h5 id="ADD命令"><a href="#ADD命令" class="headerlink" title="ADD命令"></a>ADD命令</h5><p>当使用ADD添加本地文件时， 如果是单个文件才会进行解压缩(如果多个文件不会解压缩)如： ADD hello.tar.gz /app<br>如果原路径是一个URL那么docker会试图区下载这个文件， 下载后权限自动设置为600，并且不会解压文件，如果需要更改还需要添加<br>可以看到ADD命令其实限制非常多， 并且语义也并不明确， 如果需要从网络下载还不如使用RUN命令，再使用curl gzip chmod等一次更改当前修改， 这样只需要创建一层就可以完成了。<br>所以在项目中尽量不要使用这个命令来添加文件， 仅当需要解压时才使用， 如将所有的项目文件压缩为一个zip包， 再通过一条ADD命令将其添加到项目目录当中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ADD http://download.redis.io/releases/redis-$&#123;REDIS_VERSION&#125;.tar.gz /app</span><br><span class="line">ADD hello.tar.gz /app</span><br></pre></td></tr></table></figure></p>
<h5 id="COPY命令"><a href="#COPY命令" class="headerlink" title="COPY命令"></a>COPY命令</h5><p>注意docker构建的context， 也就是docker构建的上下文<br>再docker构建的过程中是没有当前目录的概念的，比如：不能指定../clear.sh， 因为docker引擎不知道这个目录是哪里，所以获取不到这个文件<br>当使用docker build进行构建的时候， 会设置Dockerfile和Context上下文对于的路径， 如果没有设置Dockerfile的位置， 那么默认会在context中查找Dockerfile, 如果没有那么构建失败<br>而当指定Context的时候，docker客户端会将context指定的目录下所有的文件都传送给docker引擎， docker引擎再根据dockerfile中指定的需要的文件从context中去查找， 如果找不到构建失败<br>由此可见Dockerfile中指定的原路径都是指定当前docker引擎的context路径<br>docker引擎每向下构建一层需要的依赖文件就从docker引擎的context路径传送到启动的docker容器当中， 再提交容器生成一层镜像<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY . /app</span><br></pre></td></tr></table></figure></p>
<h5 id="RUN命令"><a href="#RUN命令" class="headerlink" title="RUN命令"></a>RUN命令</h5><p>在构建的过程中运行当前命令， 存在两种形式shell格式和exec形式, shell格式就像直接运行shell命令一样执行  而exec格式则是只按照当前给出的命令和参数的形式进行执行<br>此处必须写成./start.sh， 而不能直接写成start.sh， 因为在shell下直接写成start.sh也是不能运行的<br>RUN ./start.sh<br>而此处exec格式，必须添加上执行的shell<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN [&quot;/bin/bash&quot;, &quot;start.sh&quot;]</span><br></pre></td></tr></table></figure></p>
<h5 id="CMD命令"><a href="#CMD命令" class="headerlink" title="CMD命令"></a>CMD命令</h5><p>指定容器启动的主进程启动命令， 也就是操作系统挂载文件系统之后启动的init进程， 而此处的主进程就是类似init进程, 当且仅当主进程推出那么此时容器内所有的进程都退出， 并且我们<br>知道主进程init是所有的进程的父进程，当产生僵尸进程的时候当父进程死后，而子进程没有死那么为了防止僵尸进程，此时就需要init进程来寄养子进程。这里完全和linux操作系统是一样的。<br>在使用shell格式的时候， 系统会默认为其添加sh -c的参数形式执行<br>容器在其启动的时候可以重新覆盖CMD命令，从而启动其他的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMD echo $HOME</span><br></pre></td></tr></table></figure></p>
<h5 id="ENTRYPOINT命令"><a href="#ENTRYPOINT命令" class="headerlink" title="ENTRYPOINT命令"></a>ENTRYPOINT命令</h5><p>ENTRYPOINT, 当使用了ENTRYPOINT之前的CMD和ENTRYPOINT就被覆盖， 而定义在ENTRYPOINT后面的CMD则作为ENTRYPOINT的参数, 而且在容器运行的时候还可以覆盖CMD参数， 这样就可以达到一种<br>默认命令， 并且可以更改参数的用途， 这样某些场景会非常有用， 比如redis的启动， ENTRYPOINT指定启动脚本， 并且在真正的主进程启动之间进行一些环境的修改， 如执行用户等等，并且<br>可以设置参数。 第二可以把容器当作命令来执行， 并且可以为其指定参数。<br>容器启动的时候也可以使用 –entrypoint 来覆盖这里的entrypoint命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;, &quot;start.sh&quot;]</span><br><span class="line">CMD [&quot;3&quot;]</span><br></pre></td></tr></table></figure></p>
<h5 id="存储卷"><a href="#存储卷" class="headerlink" title="存储卷"></a>存储卷</h5><p>VOLUME定义匿名卷， 容器运行时应该尽量（必须）保证容器存储层不发生写操作， 任何的数据要么保存到卷当中， 要么通过数据库服务保存在其它的地方<br>为了防止用户忘记运行时将需要使用的目录挂载为卷， 我们可以在Dockerfile中定义匿名的卷， 如果用户不挂载那么运行是容器自动挂载当前卷， 使用docker守护进程在本地创建一个目录作为<br>此匿名卷的挂载目录， 这样就可以保证容器的存储层不会被写入了. 所以任何时候我们都应该为一个需要写入数据的容器声明卷， 而在docker中， 最终这个卷被挂载到具体那个位置是未知的，<br>docker提供了一个灵活的处理方式， docker的卷可以使用任何第三方实现的插件， 将其保存在分布式文件系统或者云或者本地系统等等， 这样卷就可以作为一种资源来供容器使用了， 这也<br>swarm kubernetes等工具的实现方式。<br>运行时挂载 -v mydata:/data<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VOLUME /data</span><br><span class="line">VOLUME [&quot;/pass1&quot;, &quot;/pass2&quot;]</span><br></pre></td></tr></table></figure></p>
<h5 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h5><p>EXPOSE 声明运行时容器提供服务的端口， 仅仅只是一个声明而已， 运行是并不会因为这个声明就会开启这个端口的服务， 其实容器也是完全做不到这一点的， 主要有两个意图， 第一帮助镜像<br>使用者理解这个镜像的服务的守护端口， 方便配置映射， 另一个用户则是运行时使用随机端口映射， 也就是docker run -P时， 会自动随机映射EXPOSE的端口， 不管当前端口是否有服务在监听<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE 9092</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/12/docker-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/12/docker-network/" itemprop="url">docker 网络</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-12T21:38:23+08:00">
                2017-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  996
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="docker四种网络类型"><a href="#docker四种网络类型" class="headerlink" title="docker四种网络类型"></a>docker四种网络类型</h4><ul>
<li>host模式，容器将不会获得一个独立的Network Namespace，而是和宿主机共用一个Network Namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口，Docker Container可以和宿主机一样，使用宿主机的eth0，实现和外界的通信。换言之，Docker Container的IP地址即为宿主机eth0的IP地址， 不需要NET转换，使用–net =bridge指定。</li>
<li>bridge模式是Docker默认的网络设置，此模式会为每一个容器分配Network Namespace、设置IP等，并将一个主机上的Docker容器连接到一个虚拟网桥上。Brdige桥接模式为Docker Container创建独立的网络栈，保证容器内的进程组使用独立的网络环境，实现容器间、容器与宿主机之间的网络栈隔离。另外，Docker通过宿主机上的网桥(docker0)来连通容器内部的网络栈与宿主机的网络栈，实现容器与宿主机乃至外界的网络通信，使用–net =host指定。</li>
<li>在none模式下，Docker容器拥有自己的Network Namespace，但是，并不为Docker容器进行任何网络配置。也就是说，这个Docker容器没有网卡、IP、路由等信息。需要我们自己为Docker容器添加网卡、配置IP等，使用–net =none模式启动容器</li>
<li>这个模式指定新创建的容器和已经存在的一个容器共享一个Network Namespace，而不是和宿主机共享。新创建的容器不会创建自己的网卡，配置自己的IP，而是和一个指定的容器共享IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过lo网卡设备通信，使用–net =container模式启动容器：</li>
</ul>
<h4 id="更换默认网桥"><a href="#更换默认网桥" class="headerlink" title="更换默认网桥"></a>更换默认网桥</h4><ul>
<li><p>安装网桥管理工具</p>
<p><code>sudo apt install bridge-utils</code></p>
</li>
<li><p>添加网桥</p>
<p><code>sudo brctl addbr br0</code></p>
</li>
<li><p>修改网桥IP地址</p>
<p><code>sudo ifconfig br0 172.37.0.1 netmask 255.255.0.0</code></p>
</li>
<li><p>更改docker守护进程配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd --b dr0 -H unix://</span><br></pre></td></tr></table></figure>
</li>
<li><p>还可以直接更改<code>docker0</code>的<code>IP</code>地址， 如果没有文件直接创建</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"bip"</span>: <span class="string">"172.37.0.1/16"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以直接在docker运行的时候直接加上参数指定网络设备</p>
<p><code>docker run -itd --name test --network br0 --ip 172.37.0.2 centos:latest`</code>/bin/bash`</p>
</li>
</ul>
<h4 id="跨主机访问"><a href="#跨主机访问" class="headerlink" title="跨主机访问"></a>跨主机访问</h4><ul>
<li><p>环境，两台独立主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host1: 192.168.0.100 netmask 255.255.255.0</span><br><span class="line">host2: 192.168.0.101 netmask 255.255.255.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>网桥方式</p>
<ul>
<li><p>原理，将主机的物理网卡当做一个网桥工具（更像是一个路由器），对外暴露物理网卡分配IP地址，对内建立局域网络环境， 物理网卡通过NET进行网络转换， 这样也就达到了只有两台物理主机可以进行访问，那么整个网络就是连通的。但是存在一个缺陷， 那就是必须有效的控制网络中的IP地址段。</p>
</li>
<li><p>创建网桥</p>
<p><code>sudo brctl addbr br0</code></p>
</li>
<li><p>由于使用网桥管理工具添加网桥后，配置IP地址会在下次启动的时候自动失效， 所以我们需要将网络配置信息写入到文件当中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#vi /etc/network/interfaces</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static #也可以直接使用动态地址 </span><br><span class="line">address 192.168.0.100</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.0.1</span><br><span class="line">bridge_ports eth0 #将主机网卡绑定到网桥上面</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置docker启动参数, 限定docker网络可以分配的ip地址段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd --b dr0 --fixed-cidr 192.168.0.128/26  -H unix://</span><br></pre></td></tr></table></figure>
</li>
<li><p>两台机器使用相同配置， 但是控制不同的IP段</p>
</li>
</ul>
</li>
<li><p>weave方式</p>
<p>参考：极客学院课程</p>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my-icon.jpeg"
                alt="ilivoo" />
            
              <p class="site-author-name" itemprop="name">ilivoo</p>
              <p class="site-description motion-element" itemprop="description">我，在這裡，享受等你的時光。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ilivoo</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/lib/clipboard/clipboard.js"></script>
<script type="text/javascript" src="/js/src/custom.js"></script>

</body>
</html>
