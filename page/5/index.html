<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Ilivoo`s blog" type="application/atom+xml" />






<meta name="description" content="我，在這裡，享受等你的時光。">
<meta property="og:type" content="website">
<meta property="og:title" content="Ilivoo`s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Ilivoo`s blog">
<meta property="og:description" content="我，在這裡，享受等你的時光。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ilivoo`s blog">
<meta name="twitter:description" content="我，在這裡，享受等你的時光。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>Ilivoo`s blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ilivoo`s blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/linux-gopass/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/linux-gopass/" itemprop="url">gopass安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T14:50:00+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,094
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="gopass各组件说明"><a href="#gopass各组件说明" class="headerlink" title="gopass各组件说明"></a>gopass各组件说明</h4><ul>
<li>gopass 用于密码管理的工具， 是pass的go语言版本， 提供了多人的密码管理命令行接口</li>
<li>gnupg 用于真正的加密， gnupg用于生成非对称秘钥， 使用公钥进行机密， 私钥进行解密</li>
<li>git 用于将gopass需要管理的密码（被gnupg生产的公钥加密过的密码）上传到git中便于管理</li>
<li><a href="http://www.voidcn.com/article/p-gngvxvlm-nx.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-gngvxvlm-nx.html</a></li>
</ul>
<h4 id="安装gopass"><a href="#安装gopass" class="headerlink" title="安装gopass"></a>安装gopass</h4><ul>
<li><p>安装基本工具</p>
<p><code>apt-get install gnupg git rng-tools</code></p>
<p><strong>说明：</strong> </p>
<ul>
<li>gnupg通过非对称加密算法对密码进行加密</li>
<li>git用于将加密后的密码上传到git远程仓库中</li>
</ul>
</li>
<li><p>初始化GPG key pair</p>
<p><code>gpg --gen-key</code></p>
</li>
<li><p>安装gopass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O- https://api.bintray.com/orgs/gopasspw/keys/gpg/public.key | sudo apt-key add -</span><br><span class="line">echo "deb https://dl.bintray.com/gopasspw/gopass trusty main" | sudo tee /etc/apt/sources.list.d/gopass.list</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install gopass</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加自动完成脚本到.zshrc中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(gopass completion zsh | head -n -1 | tail -n +2)</span><br><span class="line">compdef _gopass gopass</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化gopass</p>
<p><code>gopass init</code></p>
</li>
</ul>
<h4 id="安装passmenu"><a href="#安装passmenu" class="headerlink" title="安装passmenu"></a>安装passmenu</h4><ul>
<li><p>安装dmemu</p>
<p><code>sudo apt install dmenu</code></p>
</li>
<li><p>安装passmenu脚本到path中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">shopt -s nullglob globstar</span><br><span class="line"></span><br><span class="line">typeit=0</span><br><span class="line">if [[ $1 == "--type" ]]; then</span><br><span class="line">	typeit=1</span><br><span class="line">	shift</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">prefix=$&#123;PASSWORD_STORE_DIR-~/.password-store&#125;</span><br><span class="line">password_files=( "$prefix"/**/*.gpg )</span><br><span class="line">password_files=( "$&#123;password_files[@]#"$prefix"/&#125;" )</span><br><span class="line">password_files=( "$&#123;password_files[@]%.gpg&#125;" )</span><br><span class="line"></span><br><span class="line">password=$(printf '%s\n' "$&#123;password_files[@]&#125;" | dmenu "$@")</span><br><span class="line"></span><br><span class="line">[[ -n $password ]] || exit</span><br><span class="line"></span><br><span class="line">if [[ $typeit -eq 0 ]]; then</span><br><span class="line">	pass show -c "$password" 2&gt;/dev/null</span><br><span class="line">else</span><br><span class="line">	pass show "$password" | &#123; IFS= read -r pass; printf %s "$pass"; &#125; |</span><br><span class="line">		xdotool type --clearmodifiers --file -</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面还存在另外一种实现方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Simply copy the selected password to the clipboard</span><br><span class="line">gopass ls --flat | dmenu | xargs --no-run-if-empty gopass show -c</span><br><span class="line"># First pipe the selected name to gopass, encrypt it and type the password with xdotool.</span><br><span class="line">gopass ls --flat | dmenu | xargs --no-run-if-empty gopass show -f | head -n 1 | xdotool type --clearmodifiers --file -</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加系统快捷键</p>
<p>路径： <code>System Settings --&gt; keyboard --&gt; Shortcuts --&gt; Custom Shortcuts</code></p>
<p>添加： 上面脚本的路径</p>
</li>
</ul>
<h4 id="配置git远程仓库"><a href="#配置git远程仓库" class="headerlink" title="配置git远程仓库"></a>配置git远程仓库</h4><ul>
<li><p>在github中创建个人私有仓库</p>
</li>
<li><p>讲gopass的git仓库添加到远程仓库当中</p>
<p><code>git remote add origin https://github.com/xxxx/gopass.git</code></p>
<p><code>gopass sync</code></p>
</li>
</ul>
<h4 id="配置gpg"><a href="#配置gpg" class="headerlink" title="配置gpg"></a>配置gpg</h4><ul>
<li><p>创建回收key， 用于在私钥发送泄露或者忘记私钥密码时回收公钥</p>
<p><code>gpg --armor --output revoke-key.txt --gen-revoke keyname</code></p>
</li>
<li><p>导出公钥和私钥</p>
<p><code>gpg --armor --output public-key.txt --export keyname</code></p>
<p><code>gpg --armor --output private-key.txt --export-secret-keys keyname</code></p>
</li>
<li><p>备份自己的gpg秘钥对到google云盘当中</p>
<p><strong>说明：</strong> gpg的秘钥和gopass保护的密码都以及保存起来了， 用于以后的密码找回</p>
</li>
</ul>
<h4 id="直接查看gopass中密码"><a href="#直接查看gopass中密码" class="headerlink" title="直接查看gopass中密码"></a>直接查看gopass中密码</h4><ul>
<li><p>由于gopass中的密码以及被上面生成的密钥对的公钥加密过， 所以只需要通过上面导出的私钥就可以解密出正真的密码明文</p>
<p><code>gpg -o hello.txt -d ~/.password-store/storm.gpg</code></p>
<p><strong>注意：</strong>此时需要输入我们生成密钥时候的密钥密码， 所以从这里可以看到即使别人拿到我们的密钥如果没有私钥密码那么他们照样是无法进行解密的</p>
</li>
</ul>
<h4 id="恢复gopass的环境"><a href="#恢复gopass的环境" class="headerlink" title="恢复gopass的环境"></a>恢复gopass的环境</h4><ul>
<li><p>git clone 密码库到本地</p>
<p><code>git clone https://github.com/xxxx/gopass.git ~/.password-store</code></p>
</li>
<li><p>gpg 导入公钥和私钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --import ~/public-key.txt </span><br><span class="line">gpg --allow-secret-key-import --import ~/private-key.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>gopass配置使用公钥用户进行加密</p>
<p><code>gopass init</code></p>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>从上面的说明可以看出github中的密码和google的密码也是非常重要的， 但是通常情况下绑定了手机可以直接找回， 所以不用担心， 直接使用gopass自动生成的密码即可</li>
<li>私钥是一定不能忘记的， 所以如果这三个密码如果没有全部丢失那么通常情况下自己的gopass密码管理就是没有问题的。</li>
<li>但是存在一个问题， 那就是机器丢失的问题</li>
</ul>
<h4 id="团队协作"><a href="#团队协作" class="headerlink" title="团队协作"></a>团队协作</h4><ul>
<li><p>创建gopass git仓库，使用github创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopass --yes setup --remote git@github.com:example/pass.git --alias example --create --name &quot;John Doe&quot; --email &quot;john.doe@example.com&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将团队其它成员的公钥导入到gopass仓库当中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#团队成员导出公钥</span><br><span class="line">gpg -a --export logan@mail.com &gt; logan.pub.asc</span><br><span class="line">#导入公钥到创建gopass仓库的gpg当中</span><br><span class="line">gpg --import &lt; logan.pub.asc</span><br><span class="line">#将用户添加到gopass仓库当中</span><br><span class="line">gopass recipients add logan@mail.me/name</span><br></pre></td></tr></table></figure>
</li>
<li><p>团队其它成员clone仓库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopass --yes setup --remote github.com/example/pass.git --alias example --name &quot;logan&quot; --email &quot;logan@mail.com &quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>手机端也可以使用pass工具</p>
</li>
</ul>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/linux-server-monitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/linux-server-monitor/" itemprop="url">linux 服务器监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T21:34:51+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  624
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p><code>top</code>         top -H -p</p>
</li>
<li><p><code>free</code>        free -m</p>
</li>
<li><p><code>vmstat</code>     vmstat 1 10</p>
</li>
<li><p><code>pmstat</code>     pmstat -P -ALL 2 3</p>
</li>
<li><p><code>pidstat</code>    pidstat -p pid 1 5 -l/d/r/w/t</p>
</li>
<li><p><code>iostat</code>    iostat -x 1 3</p>
</li>
<li><p><code>ifstat</code>   </p>
</li>
<li><p><code>dstat</code></p>
</li>
<li><p><code>crontab</code>    定时任务， 注意： 添加PATH，或者直接执行source /etc/profile， 添加文件权限，写定时任务时输出错误日志，脚本中所有的命令和文件必须在path中找到，不然就需要全路径，如果有问题查看日志/var/log/cron</p>
</li>
<li><p><code>netstat</code> 显示服务器监听状态， 和正在被其它机器连接以及连接到其它的机器的连接</p>
<p>-a -t -u： 表示查看正在被其他机器连接或者连接到其它机器， -t tcp, -u udp, -a tcp/udp</p>
<p>-l: 表示服务器监听状态</p>
<p>-n 拒绝显示别名，能显示数字的全部转化成数字。</p>
<p>-p 显示建立相关链接的程序名和端口号</p>
<p>-e 显示扩展信息</p>
<p>常用案例：</p>
<ol>
<li><p>查看某个端口的连接数：</p>
<p><code>netstat -an | grep 9991 | wc -l</code> </p>
</li>
<li><p>查看某个程序监听的端口</p>
<p><code>netstat -lp | grep mysql</code></p>
</li>
<li><p>查看某个程序对外连接数在ip上的分布：</p>
<p><code>netstat -an | grep &quot;192.168.1.15:22&quot; |awk &#39;{print $5}&#39;|awk -F: &#39;{print $1}&#39;|sort|uniq -c|sort -nr|head -20</code></p>
<p>192.168.1.15:22 服务端监听的程序</p>
</li>
<li><p>netstat -c实时监控连接的建立</p>
<p><code>ps -ef | grep name</code> 可以先通过netstat查看到程序进程id， 再通过ps来查看相关信息</p>
</li>
</ol>
</li>
<li><p><code>lsof</code> 列出打开的文件(list open file), 这是个非常重要的命令， 非常方便我们查看文件相关，我们知道在linux当中所有的硬件设备都是以文件的形式存在， 所以我们可以通过查看文件的信息查看我们的硬件信息， 如： 网络设备， 磁盘等等</p>
<p>常用参数：</p>
<p>lsof -p pid： 列出指定进程号所打开的文件</p>
<p>​    <code>lsof -p 2</code>     列出程序打开的文件</p>
<p>lsof -i 条件： 列出符合条件的进程。 （4， 6， 协议， :端口， @ip）</p>
<p>​    <code>sudo lsof -i 4</code>        列出ipv4的进行</p>
<p>​    <code>sudo lsof -i 6:2181</code>    列出ipv4并且端口为2181的进程</p>
<p>lsof +d/D 目录： 列出目录下被打开的文件/递归</p>
<p>​    <code>lsof -d .</code>     当前目录</p>
<p>​    <code>lsof -D .</code>    递归显示</p>
<p>​    可以指定多个条件，但默认是OR关系的，如果需要AND关系，必须传入-a参数，比如查看22端口并且使用Ipv6连接的进程：</p>
<p>​    <code>sudo lsof -c sshd -i 6 -a -i :22</code></p>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/hadoop-spark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/hadoop-spark/" itemprop="url">spark注意点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T21:26:35+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,147
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>spark transform 和 action 动作中的闭包序列化，由于在闭包中，spark只是负责把闭包进行序列化成对象，也就是说从Driver到Executor中，spark拿到的都是一个个序列化对象，并通过rdd的组合对这些序列化对象进行调用，那么对于闭包来说，spark没有任何的特例，它就是完全使用scala语言闭包的语义，也就是说在创建闭包的时候，对于闭包的可见性对象， 它会将其打包成类的属性， 并对闭包进行序列化，那么通常来说它仅仅只是会打包闭包可见性并且需要的对象，对于闭包中的可见性对象如果它的方法依赖与另外一个对象（并且这个对象，不是这个可见对象的属性，那么spark是不会序列化这个对象的，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//业务调用</span><br><span class="line">import CacheHelper.cache</span><br><span class="line">dataset.filter&#123;log =&gt;  cache(log .....)&#125;</span><br><span class="line">// rdd闭包中使用这个单例中的方法， </span><br><span class="line">object CacheHelper&#123;</span><br><span class="line">cache(log ....) &#123;</span><br><span class="line">Sington.name</span><br><span class="line">&#125;&#125;</span><br><span class="line">// 程序启动的时候， 初始化这个单例对象name=&quot;init name&quot;</span><br><span class="line">class Sington(name: String)</span><br><span class="line">object Sington &#123;</span><br><span class="line">private var instance = new Sington(&quot;default name&quot;)</span><br><span class="line">val getInstance = instance</span><br><span class="line">def init(name: String) instance.name = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>注意： 从上面的分析可以看到， 闭包中的调用的方法依赖一个Sington的全局对象, 对于普通的本地运行master = local[n]此时的Sington的name为”init name”, 对于集群中运行的时候master = yarn此时Sington的那么为”default name”</p>
</li>
<li><p>分析： 现在通过上面的规则可以非常明显的看出此时Executor中的Sington对象没有被序列化， 为默认值， 所以对于spark而言要非常注意这种序列化问题， 其实规则非常简单， 但是通常会由于对象图谱而造成混乱， 所以通常必须要非常清晰的全局对象。</p>
</li>
<li><p>处理： 更改这个错误也非常简单， 只需要在dataset.filter中直接传入这个Sington对象， 或者只传入它需要的参数就可以， 也就是说将这个单例对象暴露到闭包的可见范围之内， 这样闭包就会被序列化。</p>
</li>
<li><p>缺点： 当然这里非常明显的代码结构发生了变化， 但这也是无赖之举， 也就是说我们一定要缩小闭包的可见范围。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import CacheHelper.cache</span><br><span class="line">dataset.filter&#123;log =&gt;  cache(log ...., Singtong.getInstance.name)&#125;</span><br><span class="line">//将这个Sington暴露到闭包可见范围之内， rdd闭包中使用这个单例中的方法， </span><br><span class="line">object CacheHelper&#123;</span><br><span class="line">cache(log ...., name) &#123;</span><br><span class="line">Sington.name</span><br><span class="line">&#125;&#125;</span><br><span class="line">// 程序启动的时候， 初始化这个单例对象name=&quot;init name&quot;</span><br><span class="line">class Sington(name: String)</span><br><span class="line">object Sington &#123;</span><br><span class="line">private var instance = new Sington(&quot;default name&quot;)</span><br><span class="line">val getInstance = instance</span><br><span class="line">def init(name: String) instance.name = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>pyspark的原理</p>
<ul>
<li><p>使用pyspark启动时，首先会进入python</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PYTHONSTARTUP=&quot;$&#123;SPARK_HOME&#125;/python/pyspark/shell.py&quot;</span><br><span class="line">exec &quot;$&#123;SPARK_HOME&#125;&quot;/bin/spark-submit pyspark-shell-main --name &quot;PySparkShell&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<p><em>说明：</em> <code>PYTHONSTARTUP</code> 是 python 的一个环境变量，当启动python时候，如果这个环境变量存在，那么python启动的时候会调用这个python脚本。而这里的 <code>shell.py</code> 中再次调用 <code>spark-submit</code> 进行启动spark的 <code>PythonGatewayServer</code> ，这样python使用py4j就可以和这个和spark的jvm进行通讯了。接着 <code>shell.py</code> 中创建SparkSession等对象。</p>
</li>
<li><p>pyspark启动后，通常会使用SparkSession对象创建RDD，并最终对RDD进行转换和操作，那么对于RDD的各种python代码的操作是如何进行转换到spark当中的呢？</p>
<ul>
<li>首先对于pyspark中创建的对象与jvm中的对象是一一对应的</li>
<li>其次当使用python闭包时候，python会使用pickle对闭包进行序列化，再当做参数传递给spark</li>
<li>spark在Executor中运行RDD中的compute方法时候，当然是不能运行python代码的，而是在Executor启动一个python虚拟机将RDD的数据传到python虚拟机中，再将结果传回到spark中，spark再将最终计算的结果驱动python虚拟机当中</li>
</ul>
</li>
</ul>
</li>
<li><p>spark 日志查看</p>
<ul>
<li><p>程序还在运行的时候，到想要查看容器对应的服务器中，运行下面命令查看日志存放的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep spark.yarn.app.container.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>程序已经停止运行，此时日志已经被yarn进行聚合到HDFS当中，通常已经压缩，所以一般无法直接查看，只能借助 <code>yarn longs</code> 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn logs -applicationId application_1585056926959_0002 -containerId container_e14_1585056926959_0002_01_000006 -log_files stdout -size -102400 &gt; hello.log</span><br></pre></td></tr></table></figure>
<p><em>说明：</em> size后面使用负数表示查看最后的102400个字节</p>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/hadoop-hortonwork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/hadoop-hortonwork/" itemprop="url">hortonwork的使用以及常见问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T21:18:21+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/hortonwork/" itemprop="url" rel="index">
                    <span itemprop="name">hortonwork</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,050
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>配置本地源出错时</p>
<ol>
<li>方法一：需要选择Use RedHat Satellite/Spacewalk， 并且配置源的名字，注意修改每一个repo的name字段</li>
<li>方法二：如果实在不行就直接在管理员中(version)，配置本地源即可</li>
</ol>
</li>
<li><p>Hostname 必须不能配置出错，<code>hostname</code> 和 <code>hostname -f</code> 必须有相同的输出，<code>/etc/hosts</code> 配置ip必须相同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.19.36.14    iot0.dhls.com   iot0</span><br><span class="line">172.19.36.11    iot1.dhls.com   iot1</span><br><span class="line">172.19.36.18    iot2.dhls.com   iot2</span><br></pre></td></tr></table></figure>
<p>注意：完整域名必须在前面</p>
</li>
<li><p>浏览器配置kerberos访问</p>
<ul>
<li><p>firefox中输入 <code>about:config</code>，搜索并设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network.negotiate-auth.trusted-uris = .domain.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>chrome 直接添加命令行参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">google-chrome --auth-server-whitelist=&quot;*.domain.com&quot; --auth-negotiate-delegate-whitelist=&quot;*.domain.com&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>yarn 队列有自己的提交权限策略， 需要配置才能提交任务</p>
<p><code>yarn.scheduler.capacity.root.acl_administer_queue=yarn,spark,hive,admin,zeppelin</code></p>
</li>
<li><p>spark的历史日志查看也需要进行权限设置， 通常关闭</p>
<p><code>spark.history.ui.acls.enable</code></p>
<p>因为日志通常记录在hdfs中， 所以还必须拥有hdfs的文件访问权限</p>
</li>
<li><p>ranger 页面无法登录， 如果显示无法访问DB这是因为使用Mysql的时候必须明确指定是否使用SSL， 所以必须在配置连接的时候使用<code>jdbc:mysql://hdp1.ilivoo.com:3306?useSSL=false</code>， 其它的组建都可以加上，包括ambari</p>
<p>注意： 任何的报错都应该去查看日志才能精确定位错误，不用假想和凭经验断定。</p>
</li>
<li><p>ambari-server 开启security，删除或添加服务的时候需要</p>
<ul>
<li><p>更改<a href="mailto:admin/admin@TEPIA.COM" target="_blank" rel="noopener">admin/admin@TEPIA.COM</a>的密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local</span><br><span class="line">change_password admin/admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启ambari-server的security</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ambari-server setup-security</span><br><span class="line">选择[2] Encrypt passwords stored in ambari.properties file.</span><br><span class="line">选择[Y]</span><br><span class="line">keytool -list -keystore /var/lib/ambari-server/keys/credentials.jceks -storetype JCEKS</span><br><span class="line">ambari-server restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加credential</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">添加</span><br><span class="line">curl -H &quot;X-Requested-By:ambari&quot; -u admin:ambari_passwd -X  POST -d &apos;&#123; &quot;Credential&quot; : &#123; &quot;principal&quot; : &quot;admin/admin@TEPIA.COM&quot;, &quot;key&quot; : &quot;admin_princ_passwd&quot;, &quot;type&quot; : &quot;persisted&quot; &#125; &#125;&apos; http://hdp1:8080/api/v1/clusters/tepia/credentials/kdc.admin.credential</span><br><span class="line">查看</span><br><span class="line">curl -H &quot;X-Requested-By:ambari&quot; -u admin:ambari_passwd -X GET http://hdp1:8080/api/v1/clusters/tepia/credentials/kdc.admin.credential</span><br><span class="line">删除</span><br><span class="line">curl -H &quot;X-Requested-By:ambari&quot; -u admin:ambari_passwd -X DELETE http://hdp1:8080/api/v1/clusters/tepia/credentials/kdc.admin.credential</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>ambari 可以运行在非root用户下， 通常来说这样会更安全些，但是需要一些配置，<a href="https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.4/securing-credentials/content/secure_credentials_management_overview.html" target="_blank" rel="noopener">参考</a>，但是建议还是运行在root用户下，这样更加简单，所有的安全问题也可以参考上面。</p>
<ul>
<li>更改权限 <code>chown -R ambari /var/run/ambari-server</code></li>
</ul>
</li>
<li><p>NameNode UI不能访问, 这是因为服务器存在多个网卡,  默认NameNode默认只是绑定到集群指定的网卡, 并没有绑定到所有的网卡, 所以如果使用了openvpn后, 实际上50070并没有绑定到openvpn指定的网卡, 所以就会导致无法openvpn的网卡无法访问了, 通过指定 <code>hdfs-site.xml</code> 绑定所有网卡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dfs.namenode.http-bind-host=0.0.0.0</span><br><span class="line">dfs.namenode.https-bind-host=0.0.0.0</span><br><span class="line">dfs.namenode.rpc-bind-host=0.0.0.0</span><br><span class="line">dfs.namenode.servicerpc-bind-host=0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka日志目录必须为空, 对于单独挂载的目录来说通常下来存在 <code>lost+found</code> , 所以必须再加一层目录. </p>
<p>kafka的 <code>zookeeper.connect</code>  应该添加根目录, 这样更加便于管理, 如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connect=cmsw2.tepia.com:2181,cmsw1.tepia.com:2181/kafka</span><br></pre></td></tr></table></figure>
<p>kafka多网卡绑定, 如果仅仅只是绑定某个ip而没有绑定openvpn网卡, 那么同样无法访问, 所以需要配置为 <code>listeners=PLAINTEXT://:6667</code></p>
<p>kerberos kafka需要更改配置为 <code>listeners = SASL_PLAINTEXT://:6667</code></p>
</li>
<li><p>hbase 双网卡绑定问题, 在hbase-site.xml中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hbase.master.ipc.address 0.0.0.0</span><br><span class="line">hbase.regionserver.ipc.address 0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改hadoop运行用户, 通常情况下线上用户和线下用户不是同一个用户,如果 线下调试线上spark程序,需要指定本地为线上用户, 则通过指定环境变量来指定运行用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_USER_NAME=tepia</span><br></pre></td></tr></table></figure>
</li>
<li><p>yarn timeline 两种配置后端存储模式，第一种嵌入式的hbase运行，第二种集群的hbase（推荐），配置如下</p>
<ul>
<li><p>配置并重启yarn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use_external_hbase = true</span><br><span class="line">  hbase.zookeeper.quorum = hdp1.tepia.com,hdp2.tepia.com,hdp3.tepia.com</span><br><span class="line">  hbase.zookeeper.property.clientPort = 2181</span><br><span class="line">  zookeeper.znode.parent = /hbase-secure</span><br><span class="line">  yarn.timeline-service.hbase.configuration.file=</span><br><span class="line">  file:///etc/hbase/conf/hbase-site.xml</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong>最后的一个配置 <code>yarn.timeline-service.hbase.configuration.file</code> ，hdp的官网并没有说明，如果没有指定配置hbase配置文件，TimelineReader无法连接到hbase。但是yarn官网有提及，从这里也充分的可以感觉到很多答案还得到项目的官网中寻求答案。</p>
</li>
<li><p>使用hbase用户创建yarn需要的schema</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_CLASSPATH_PREFIX=/usr/hdp/3.1.0.0-78/hadoop-yarn/timelineservice/*</span><br><span class="line">/usr/hdp/3.1.0.0-78/hbase/bin/hbase org.apache.hadoop.yarn.server.timelineservice.storage.TimelineSchemaCreator -Dhbase.client.retries.number=35 -create -s</span><br></pre></td></tr></table></figure>
</li>
<li><p>为新添加的表(prod.*)增加权限, 使用基本方式或者ranger </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grant &apos;yarn&apos;, &apos;RWXCA&apos;</span><br><span class="line">grant &apos;yarn-ats&apos;, &apos;RWXCA&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭yarn-ats本身开启的hbase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su - yarn-ats</span><br><span class="line">jps</span><br><span class="line">kill master regionserver</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>尝试使用 yarn 的service服务，可以参考 ats-hbase 这个服务。</p>
</li>
<li><p>ams collector 后端写入模式，如果改为分布式的，只是将hbase的存储放到hdfs当中，而本地还是开启了hbase应用。<a href="https://docs.cloudera.com/HDPDocuments/Ambari-2.7.4.0/using-ambari-core-services/content/amb_customize_the_ams_collector_mode.html" target="_blank" rel="noopener">参考</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://docs.cloudera.com/HDPDocuments/Ambari-2.7.4.0/using-ambari-core-services/content/amb_customize_the_ams_collector_mode.html</span><br><span class="line">timeline.metrics.service.operation.mode = distributed</span><br><span class="line">hbase.rootdir = /apps/ams/metrics</span><br><span class="line">hdfs dfs -mkdir -p /apps/ams/metrics</span><br><span class="line">hdfs dfs -chown -R ams:hadoop /apps/ams/metrics</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：设置为distributed，默认会有很多配置发送变化</p>
</li>
<li><p>ams 开启hbase tables metrics 收集</p>
<ul>
<li><p>进入目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd var/lib/ambari-server/resources/stacks/HDP/#version/services/HBASE/package/templates</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑下列文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop-metrics2-hbase.properties-GANGLIA-MASTER.j2</span><br><span class="line">hadoop-metrics2-hbase.properties-GANGLIA-RS.j2</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除或注释下列类容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*.source.filter.class=org.apache.hadoop.metrics2.filter.RegexFilter</span><br><span class="line">hbase.*.source.filter.exclude=.*(Regions|Users|Tables).*</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 amber-server，再重启hbase</p>
</li>
</ul>
</li>
<li><p>设置grafana https 连接，<a href="https://docs.cloudera.com/HDPDocuments/Ambari-2.7.4.0/using-ambari-core-services/content/amb_set_up_https_for_grafana.html" target="_blank" rel="noopener">参考</a></p>
</li>
<li><p>phoenix 包冲突问题， 由于项目中现在基本上使用logback，但是phoenix中使用log4j并且使用slf4j进行进行桥接，所以解决phoenix包冲突前先应该去掉slf4j和log4j，再更具具体情形进行对比。</p>
</li>
<li><p><code>hdp3.1</code> 中 <code>spark stream</code>  内存占用太高bug修复，通常情况下修复spark bug需要非常仔细。 </p>
<ol>
<li>找准spark 对应的源代码（通过maven源代码）</li>
<li>找准scala版本（查看spark中的pom文件获取）</li>
<li>创建项目拷贝对应源代码， 修改源代码。</li>
<li>获取spark集群中的jar包， 并且备份jar包</li>
<li><p>解压jar包（jar -xf ），并拷贝编译的新的class文件，并重新打包(jar cvfM)</p>
</li>
<li><p>上传新的jar包， 并重启history server</p>
</li>
</ol>
</li>
<li><p>yarn 本地缓存导致jar包冲突</p>
<ol>
<li>查看yarn本地缓存位置 <code>yarn.nodemanager.local-dirs</code></li>
<li><p>删除 <code>rm -rf filecache/ usercache/</code></p>
</li>
<li><p>重启yarn</p>
</li>
</ol>
</li>
<li><p>更改spark history日志自动删除，在 <code>Custom spark-defaults</code> 中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spark.history.fs.cleaner.enabled=true</span><br><span class="line">spark.history.fs.cleaner.interval=1d</span><br><span class="line">spark.history.fs.cleaner.maxAge=7d</span><br></pre></td></tr></table></figure>
<p>手动最近30天的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span> delete 30 day's before spark history logs </span><br><span class="line"><span class="meta">#</span>#######################start ########################</span><br><span class="line">days=30</span><br><span class="line">day_01=`date -d "-$&#123;days&#125; day" +%Y-%m-%d`</span><br><span class="line">echo $day_01</span><br><span class="line"><span class="meta">#</span>running_array=(`yarn application -list | grep application_1 | awk '&#123;print  $1&#125;' &gt; running.log `)</span><br><span class="line"><span class="meta">#</span>running_array=(`more running.log`)</span><br><span class="line">running_array=(`yarn application -list | grep application_1 | awk '&#123;print  $1&#125;' `)</span><br><span class="line">len=$&#123;#running_array[*]&#125;</span><br><span class="line">len=$(($len-1))</span><br><span class="line"></span><br><span class="line">running_string=""</span><br><span class="line">for ((i=0; i&lt; $&#123;#running_array[*]&#125;; i++))</span><br><span class="line">do</span><br><span class="line">if [ $i -lt $len ];then</span><br><span class="line">        running_string+=$&#123;running_array[$i]&#125;"\|"</span><br><span class="line">else</span><br><span class="line">        running_string+=$&#123;running_array[$i]&#125;</span><br><span class="line">fi</span><br><span class="line">done</span><br><span class="line">echo $running_string </span><br><span class="line"><span class="meta">#</span>history_logs_to_delete=(`hdfs dfs -ls /spark2-history/ | grep application_ | grep -v $running_string | awk '&#123;if( $6 &lt; $day_01) print $8&#125;'`)</span><br><span class="line">history_logs_to_delete=(`hdfs dfs -ls /spark2-history/ | grep application_ | grep -v $running_string | awk '&#123;if( $6 lt $day_01) print $8 &#125; ' `)</span><br><span class="line">for ((j=0; j&lt; $&#123;#history_logs_to_delete[*]&#125;; j++))</span><br><span class="line">do</span><br><span class="line">history_logs_str=$&#123;history_logs_to_delete[$j]&#125;</span><br><span class="line">echo "`date +%F\ %T` to delete $j ==$history_logs_str"</span><br><span class="line"><span class="meta">#</span>hdfs dfs -rm -r -f -skipTrash $history_logs_str</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>小集群配置hdfs客户端，防止写入报错，在 <code>hdfs-site</code> 中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dfs.client.block.write.replace-datanode-on-failure.enable=true</span><br><span class="line">dfs.client.block.write.replace-datanode-on-failure.policy=NEVER</span><br></pre></td></tr></table></figure>
</li>
<li><p>yarn 配置shuffle service， 在 <code>yarn-site</code> 和 <code>spark2-defaults</code> 中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark.shuffle.service.port=7337</span><br></pre></td></tr></table></figure>
</li>
<li><p>spark持久化表，写入到spark的catalog当中，由于spark中snappy版本不对导致冲突，可以在启动程序的使用自定义的snappy jar包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-shell --jars snappy-java-1.1.4.jar --conf spark.driver.extraClassPath=snappy-java-1.1.4.jar --conf spark.executor.extraClassPath=snappy-java-1.1.4.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>后续的配置， HDFS、YARN高可用、开启ambari-server的keystore，这样在开启kerberos的时候可以选择记住key，检查hadoop native lib <code>hadoop checknative</code></p>
<ol>
<li><p>错误 <code>Loading ISA-L failed: Failed to load libisal.so.2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc make autoconf automake libtool yasm git</span><br><span class="line">git clone https://github.com/01org/isa-l/</span><br><span class="line">cd isa-l/</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr --libdir=/usr/lib64</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>错误 <code>zstd: false ?</code></p>
</li>
</ol>
</li>
<li><p>在配置ambari的时候， 如果使用ambari用户作为ambari的服务启动者， 那么在使用ambari配置的过程中可能经常会出现ambari用户权限不足的情况，所以可能需要如下操作，可以参考hdp官网：</p>
<ol>
<li><p>更改权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R ambari /var/run/ambari-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加sudo操作权限，使用 <code>visudo</code> 添加一行，建议使用完成之后收回权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari  ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>phoenix jar包冲突是一个比较棘手的问题， 使用spark的时候不能直接拷贝phoenix jar包到spark的jars目录中， 而是通过指定 <code>-jars</code>  参数来解决， hive的connector是同样的道理。</p>
</li>
<li><p>kerberos在登录的时候可以直接指定 <code>krb5.conf</code> 文件的位置</p>
<ol>
<li><p>kerberos 命令行调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env KRB5_TRACE=/dev/stdout</span><br></pre></td></tr></table></figure>
</li>
<li><p>java 程序直接指定环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.security.krb5.conf=/etc/krb5.conf.prod</span><br></pre></td></tr></table></figure>
</li>
<li><p>linux 下 kinit直接添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env KRB5_CONFIG=/etc/krb5.conf.prod kinit -kt /etc/security/keytabs/feng.admin.keytab feng@TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 <code>UserGroupInformation.getCurrentUser</code> 的时候，首先在<code>core-site.xml</code> 中查找是否开启kerberos，如果开启默认情况下会去查找系统是否已经kerberos登录， 主要是通过 krb5.conf 中配置文件的credentials存放位置并进行判断，如： <code>/tmp/krb5cc_1000</code></p>
</li>
<li><p>hadoop可以使用 <code>UserGroupInformation</code> 实现代理机制，真正的用户进行kerberos登录，而代理用户进行真是的操作，如oozie进行提交任务，但是使用普通用户进行HDFS等各种权限，通过设置代理用户<code>HADOOP_PROXY_USER</code></p>
</li>
</ol>
</li>
<li><p>MapReduce在访问kerberos HDFS和HBASE的时候，需要从NameNode和Hbase集群中获分别取代理的Token，并将其写入到Credentials当中，当MapReduce访问这两个组件的时候，就会带着这两个认证信息，从而达到访问的目的，参见 <code>TableMapReduceUtil.initCredentials</code> 方法。</p>
</li>
<li><p>修改 <code>core-site.xml</code> 设置 <code>hadoop.proxyuser.yarn.hosts=*</code> 保证kerberos集群中，spark长时间运行的应用。</p>
</li>
<li><p>hdp重新安装</p>
<ul>
<li><p>使用ambari移除每一个应用</p>
</li>
<li><p>运行脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">hostDomain=tepia.com</span><br><span class="line">master=hdp1.tepia.com</span><br><span class="line">hostList=$(cat /etc/hosts| grep $hostDomain| awk -F' ' '&#123;print $2&#125;')</span><br><span class="line">services="pgsql postgres HDP ambari hadoop hdfs yarn mapred zookeeper tez hive hcatalog webhcat atlas druid zeppelin smartsense storm hbase phoenix spark kafka sqoop oozie infra solr accumulo flume hst knox livy pig ranger activity_analyzer infra-solr yarn-ats logsearch ambari-qa kms"</span><br><span class="line"></span><br><span class="line">for host in $hostList</span><br><span class="line">do</span><br><span class="line">    #检测主机的连通性</span><br><span class="line">    ping -W 1 -c 1 $host|grep "1 received" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -ne 0   ];then</span><br><span class="line">        echo -e "$======&gt;$host is Unreachable,please check '/etc/hosts' file"</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    #停止agent</span><br><span class="line">    ssh $host "ambari-agent stop"</span><br><span class="line">    ssh $host "ambari-agent reset"</span><br><span class="line">    if [ $host = $master ]; then</span><br><span class="line">        ssh $host "ambari-server stop"</span><br><span class="line">        ssh $host "ambari-server reset"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo "$host start deleting... \n"</span><br><span class="line">    #repo</span><br><span class="line">    #ssh $host "rm -rf /etc/yum.repos.d/hdp.repo"</span><br><span class="line">    #ssh $host "rm -rf /etc/yum.repos.d/HDP*"</span><br><span class="line">    #ssh $host "rm -rf /etc/yum.repos.d/ambari.repo"</span><br><span class="line">    </span><br><span class="line">    # 删除相关用户</span><br><span class="line">    ssh $host "python /usr/lib/ambari-agent/lib/ambari_agent/HostCleanup.py --silent"</span><br><span class="line">    #postgres mysql admin</span><br><span class="line"></span><br><span class="line">    # 删除服务相关信息</span><br><span class="line">    for ser in $services</span><br><span class="line">    do</span><br><span class="line">        #删除安装软件</span><br><span class="line">        packageList=$(ssh $host "yum list installed | grep $ser | cut -d ' ' -f 1")</span><br><span class="line">        for package in $packageList</span><br><span class="line">        do</span><br><span class="line">            echo "uninstalling $package"</span><br><span class="line">            ssh $host "yum remove -y $package"</span><br><span class="line">        done</span><br><span class="line">        #删除文件</span><br><span class="line">        ssh $host "rm -rf /etc/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /etc/alternatives/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /usr/bin/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /usr/sbin/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/log/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/run/$&#123;ser&#125;*"</span><br><span class="line">        ssh $host "rm -rf /var/lib/$&#123;ser&#125;*"</span><br><span class="line">        #删除用户</span><br><span class="line">        ssh $host "userdel -r $&#123;ser&#125;"</span><br><span class="line">        ssh $host "groupdel $&#123;ser&#125;"</span><br><span class="line">        #根据需要删除的文件, 加上查找的目录，通常已经不用。也可以使用locate命令更快(先安装mlocate,再更新locate数据库updatedb)</span><br><span class="line">        #ssh $host "find / -name $&#123;ser&#125; &gt;&gt; /root/del_files.log"</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    # 删除hadoop文件夹，包括HDFS数据</span><br><span class="line">    #ssh $host "rm -rf /hadoop"</span><br><span class="line">    ssh $host "rm -rf /home/data" </span><br><span class="line">    ssh $host "rm -rf /usr/hdp"</span><br><span class="line"></span><br><span class="line">    # 删除kerberos</span><br><span class="line">    ssh $host "rm -rf /etc/security/keytabs/*"</span><br><span class="line">    </span><br><span class="line">    # 删除临时文件</span><br><span class="line">    ssh $host "rm -rf /tmp/*"</span><br><span class="line"></span><br><span class="line">    ssh $host "yum clean all"</span><br><span class="line"></span><br><span class="line">    echo "$host delete is done! \n"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除mysql中的数据库，并重新创建。注意其中有些用户是需要设置为特定主机的。</p>
</li>
<li><p>kerberos的数据库也要删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kdb5_util destroy TEPIA.COM</span><br><span class="line">kdb5_util create -s -r TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>nifi 开启SSL，nifi 自带 NiFi Certificate Authority 授权程序，不推荐使用，直接选择独立安装即可</p>
<ul>
<li><p>首先按照正常方式添加nifi服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nifi.allow.explicit.keytab = false</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入ranger plugin页面关闭nifi，并重启nifi（先关闭ranger认证，后期按需添加）</p>
</li>
<li><p>进入nifi-toolkit中，生成nifi认证文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/tls-toolkit.sh standalone -n &quot;hdp1.tepia.com,hdp2.tepia.com,hdp3.tepia.com&quot; --nifiDnPrefix &quot;CN=&quot; --nifiDnSuffix &quot;, OU=TEPIA.COM&quot; -d 10950 -C &quot;CN=feng, OU=TEPIA.COM&quot; -f ../nifi/conf/nifi.properties -o nifi -K admin123 -P admin123 -S admin123 -B admin123</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制生成的 <code>keystore.jks</code> 和 <code>truststore.jks</code> 到nifi中的conf目录中</p>
</li>
<li><p>修改nifi配置文件 <code>nifi-ambari-ssl-config</code> 中如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Initial Admin Identity = feng@TEPIA.COM</span><br><span class="line">Enable SSL? = true</span><br><span class="line">Key password = pass</span><br><span class="line">Keystore password = pass</span><br><span class="line">Truststore password = pass</span><br><span class="line">Keystore type = jks</span><br><span class="line">Truststore type = jks</span><br><span class="line">NiFi CA DN suffix = , OU=TEPIA.COM</span><br><span class="line">Node Identities = </span><br><span class="line">	&lt;property name=&quot;Node Identity 1&quot;&gt;CN=hdp1.tepia.com, OU=TEPIA.COM&lt;/property&gt;</span><br><span class="line">	&lt;property name=&quot;Node Identity 2&quot;&gt;CN=hdp2.tepia.com, OU=TEPIA.COM&lt;/property&gt;</span><br><span class="line">	&lt;property name=&quot;Node Identity 3&quot;&gt;CN=hdp3.tepia.com, OU=TEPIA.COM&lt;/property&gt; </span><br><span class="line">nifi.security.identity.mapping.pattern.dn = ^CN=(.*?), OU=(.*?)$</span><br><span class="line">nifi.security.identity.mapping.pattern.kerb = ^(.*?)@(.*?)$</span><br><span class="line">nifi.security.identity.mapping.value.dn = $1@$2</span><br><span class="line">nifi.security.identity.mapping.value.kerb = $1@$2</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>配置 Node Identities 时候，注意 <code>, OU</code> 中间的空格</p>
</li>
<li><p>重启nifi，注意authorizations.xml必须没有策略，可以直接删掉 <code>/var/lib/nifi/conf</code> 下的authorizations.xml和users.xml文件。</p>
</li>
<li><p>将p12证书导入到浏览器当中，此时就可以进入nifi中，如果此时报如下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot replicate request to Node hdp2.tepia.com:9090 because the node is not connected</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>这不是认证的错误，而是集群从不安全切换到安全集群的时候，集群状态的文件，此时需要删除 <code>/var/lib/nifi/conf</code> 下的authorizations.xml和users.xml文件，并重新启动nifi，如果实在不行就直接删除 <code>/var/lib/nifi/*</code> 再次重启，每次重启必须保证 <code>/var/lib/nifi/conf</code> 下没有authorizations.xml和users.xml 这两个文件</p>
</li>
</ul>
</li>
<li><p>nifi开启SSL并使用ranger进行权限管理</p>
<ul>
<li><p>首先说明，如果在配置更改的过程中出现无法启动或无法访问等问题，可以直接删除nifi相关文件，不影响配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/nifi/* /var/log/nifi/*</span><br></pre></td></tr></table></figure>
</li>
<li><p>首先按照正常方式添加nifi服务，不需要添加NiFi Certificate Authority 授权程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nifi.allow.explicit.keytab = false</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入nifi-toolkit中，生成nifi认证文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/tls-toolkit.sh standalone -n &quot;hdp1.tepia.com,hdp2.tepia.com,hdp3.tepia.com&quot; --nifiDnPrefix &quot;CN=&quot; --nifiDnSuffix &quot;, OU=TEPIA.COM&quot; -d 10950 -C &quot;CN=feng, OU=TEPIA.COM&quot; -f ../nifi/conf/nifi.properties -o nifi -K admin123 -P admin123 -S admin123 -B admin123</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制生成的 <code>keystore.jks</code> 和 <code>truststore.jks</code> 到nifi中的conf目录中</p>
</li>
<li><p>修改nifi配置文件 <code>nifi-ambari-ssl-config</code> 中如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Enable SSL? = true</span><br><span class="line">Key password = pass</span><br><span class="line">Keystore password = pass</span><br><span class="line">Truststore password = pass</span><br><span class="line">Keystore type = jks</span><br><span class="line">Truststore type = jks</span><br><span class="line">NiFi CA DN suffix = , OU=TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>Advanced nifi-authorizers-env</code> 中如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;Ranger Admin Identity&quot;&gt;CN=feng, OU=TEPIA.COM&lt;/property&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>Advanced nifi-properties</code> 中的配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nifi.remote.input.socket.port = 1026</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>Advanced ranger-nifi-plugin-properties</code> 中的配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Authentication = SSL</span><br><span class="line">Keystore for Ranger Service Accessing NiFi = /usr/hdf/current/nifi-toolkit/nifi/keystore.jks</span><br><span class="line">Keystore Type = jks</span><br><span class="line">Truststore for Ranger Service Accessing NiFi = /usr/hdf/current/nifi-toolkit/nifi/truststore.jks</span><br><span class="line">Truststore Type = jks</span><br><span class="line">Owner for Certificate = CN=feng, OU=TEPIA.COM</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改mapping信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nifi.security.identity.mapping.pattern.dn=^CN=(.*?), OU=(.*?), O=(.*?), L=(.*?), ST=(.*?), C=(.*?)$</span><br><span class="line">nifi.security.identity.mapping.value.dn=$1@$2</span><br><span class="line">nifi.security.identity.mapping.transform.dn=NONE</span><br><span class="line">nifi.security.identity.mapping.pattern.kerb=^(.*?)/(.*?)@(.*?)$</span><br><span class="line">nifi.security.identity.mapping.value.kerb=$1@$2</span><br><span class="line">nifi.security.identity.mapping.transform.kerb=NONE</span><br><span class="line">nifi.security.group.mapping.pattern.anygroup=^(.*)$</span><br><span class="line">nifi.security.group.mapping.value.anygroup=$1</span><br><span class="line">nifi.security.group.mapping.transform.anygroup=LOWER</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<pre><code>- 修改ranger web配置页面中的 `tepia_nifi` ，让其能够连接到nifi中，并对nifi进行权限控制，配置如下

  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NiFi URL = https://hdp2.tepia.com:9091/nifi-api/resources</span><br><span class="line">Authentication Type = SSL</span><br><span class="line">Keystore = /home/ranger/keystore.jks</span><br><span class="line">Keystore Type = jks</span><br><span class="line">Keystore Password = keypass</span><br><span class="line">Truststore = /home/ranger/truststore.jks</span><br><span class="line">Truststore Password = trustpass</span><br><span class="line">commonNameForCertificate = CN=feng, OU=TEPIA.COM</span><br><span class="line">tag.download.auth.users = nifi</span><br><span class="line">policy.download.auth.users = nifi</span><br><span class="line">ambari.service.check.user = nifi</span><br></pre></td></tr></table></figure>

  **说明：**

  - 需要测试直至连接成功，连接的过程中可能需要先添加权限，并且此时可以看ranger的access访问

  - 此处的keystore 和 truststore是通过 `tls-toolkit.sh` 生成的客户端秘钥和证书，但生成的是 `CN=feng_OU=TEPIA.COM.p12` 文件，需要转换成jks文件，并加入服务端证书到客户端truststore中。

    - 转换p12证书为jks的keystone

      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -srckeystore CN\=feng_OU\=TEPIA.COM.p12 -srcstoretype pkcs12 -destkeystore keystore.jks -deststoretype jks</span><br></pre></td></tr></table></figure>

    - 导出 `hdp1.tepia.com, hdp2.tepia.com, hdp3.tepia.com` 的证书

      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keytool -export -alias  nifi-key -keystore hdp1.tepia.com/keystore.jks -rfc -file hdp1.cer</span><br><span class="line">keytool -export -alias  nifi-key -keystore hdp2.tepia.com/keystore.jks -rfc -file hdp2.cer</span><br><span class="line">keytool -export -alias  nifi-key -keystore hdp3.tepia.com/keystore.jks -rfc -file hdp3.cer</span><br></pre></td></tr></table></figure>

    - 将三个证书导入到truststore中

      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -alias hdp1  -file hdp1.cer  -keystore truststore.jks</span><br><span class="line">keytool -import -alias hdp2  -file hdp2.cer  -keystore truststore.jks</span><br><span class="line">keytool -import -alias hdp3  -file hdp3.cer  -keystore truststore.jks</span><br></pre></td></tr></table></figure>

    - 注意我们这里ranger连接nifi直接使用了，自动生产的客户端的证书，所以我们并不需要将客户端证书导入到nifi中，这是因为 `tls-toolkit.sh` 已经自动导入过了，所以如果我们需要使用不同的用户名，需要自行证书导入即可。

- 修改ranger web配置页面，添加权限，不存在的用户需要在ranger中添加用户

  - 添加all权限到 `CN=feng, OU=TEPIA.COM` 账号

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flow /system /controller /counters /provenance /policies /tenants /proxy /resources /site-to-site /restricted-components / /*</span><br></pre></td></tr></table></figure>

  - 添加proxy权限到 `hdp1.tepia.com,hep2.tepia.com,hdp3.tepia.com` 当中

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy /data/* /*</span><br></pre></td></tr></table></figure>
</code></pre><ol start="34">
<li><p>Knox 安装配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">开启Knox SSO单点登录</span><br><span class="line">https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.5/configuring-knox-sso/content/sso_set_up_knox_sso.html</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">配置相关属性</span><br><span class="line">knoxsso.token.ttl</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ranger 插件连接knox</span><br><span class="line">echo | openssl s_client -connect cmsw1.tepia.com:8443 2&gt;&amp;1 | sed --quiet &apos;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&apos; &gt; knox.crt</span><br><span class="line">keytool -import -file knox.crt -keystore &lt;ranger config property ranger.truststore.file&gt; -alias knox</span><br><span class="line">ranger.truststore.password = trustsotre password</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">knox存在默认密码，knox配置页面可以查看</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置knox proxy，即</span><br></pre></td></tr></table></figure>
</li>
<li><p>ranger插件配置，ranger插件配置是需要连接到对应的服务当中，这样在ranger配置权限的时候就有提示功能，如果没有在ranger页面配置连接到对应的服务，不影响ranger授权，只是页面没有提示功能而已。常见的配置错误如下：</p>
<ul>
<li>hbase、hive需要配置rangerlookup用户访问对应的表或者服务的权限（现在对于权限中配置，再配置连接）</li>
<li>hbase需要配置Kerberos，并配置master的principal，如：<a href="mailto:`hbase/cmsw2.tepia.com@TEPIA.COM" target="_blank" rel="noopener">`hbase/cmsw2.tepia.com@TEPIA.COM</a>`</li>
<li>Knox需要配置admin用户的用户名和密码</li>
</ul>
</li>
<li><p>安装opentsdb</p>
<ol>
<li><p>开启lzo压缩，<a href="https://docs.cloudera.com/HDPDocuments/Ambari-2.7.3.0/administering-ambari/content/amb_enable_lzo_compression.html" target="_blank" rel="noopener">教程</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install hadooplzo* -y</span><br><span class="line">io.compression.codecs = com.hadoop.compression.lzo.LzoCodec</span><br><span class="line">io.compression.codec.lzo.class = com.hadoop.compression.lzo.LzoCodec</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装opentsdb，直接从 github 上下载 OpenTSDB 的 release 版本的 RPM 包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall opentsdb-2.4.0.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>说明：如果需要更改opentsdb执行用户，可以更改为hbase，需要修改如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chown -R hbase:hbase /tmp/opentsdb/</span><br><span class="line">chown -R hbase:hbase /var/cache/opentsdb/</span><br><span class="line">chown -R hbase:hbase /var/log/opentsdb/</span><br><span class="line">ln -s /usr/share/opentsdb/bin/tsdb /usr/bin/tsdb</span><br></pre></td></tr></table></figure>
<p>可以通过命令查看有哪些opentsdb文件，<code>rpm -ql opentsdb</code>  和 <code>find / -name *opentsdb*</code></p>
</li>
<li><p>创建opentsdb需要的表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_HOME=/usr/hdp/3.0.1.0-187/hbase</span><br><span class="line">tools/create_table.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>logback.xml</code>的两个日志的绝对地址，如果通过systemctl启动 <code>opentsdb@.service</code> ，那么可以不用更改</p>
</li>
<li><p>配置<code>opentsdb.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tsd.storage.hbase.zk_basedir = /hbase-secure</span><br><span class="line">tsd.storage.hbase.zk_quorum = cmsw1.tepia.com,cmsw2.tepia.com,cmsw3.tepia.com</span><br><span class="line">hbase.security.auth.enable=true</span><br><span class="line">hbase.security.authentication=kerberos</span><br><span class="line">hbase.kerberos.regionserver.principal=hbase/_HOST@TEPIA.COM</span><br><span class="line">hbase.sasl.clientconfig=Hbase</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 <code>/etc/opentsdb/opentsdb-jass.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Hbase &#123;</span><br><span class="line">  com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">  useKeyTab=true</span><br><span class="line">  keyTab=&quot;/etc/security/keytabs/hbase.headless.keytab&quot;</span><br><span class="line">  storeKey=true</span><br><span class="line">  useTicketCache=false</span><br><span class="line">  serviceName=&quot;opentsdb&quot;</span><br><span class="line">  principal=&quot;hbase-cmsw@TEPIA.COM&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Zookeeper &#123;</span><br><span class="line">  com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">  useKeyTab=true</span><br><span class="line">  keyTab=&quot;/etc/security/keytabs/hbase.headless.keytab&quot;</span><br><span class="line">  storeKey=true</span><br><span class="line">  useTicketCache=false</span><br><span class="line">  serviceName=&quot;zookeeper&quot;</span><br><span class="line">  principal=&quot;hbase-cmsw@TEPIA.COM&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>tsdb</code>启动文件，添加jvm启动参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JVMARGS=&quot;$JVMARGS -Djava.security.krb5.conf=/etc/krb5.conf -Dhbase.security.authentication=kerberos -Dhbase.kerberos.regionserver.principal=hbase/_HOST@TEPIA.COM -Dhbase.rpc.protection=authentication -Dhbase.sasl.clientconfig=Hbase -Dzookeeper.sasl.clientconfig=Zookeeper -Djava.security.auth.login.config=/etc/opentsdb/opentsdb-jaas.conf&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改自动启动脚本，不建议使用这种方式启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=hbase</span><br><span class="line">Group=hbase</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">Environment=JAVA_HOME=/usr/java/jdk1.8.0_261-amd64</span><br><span class="line">Environment=&apos;JVMARGS=-Xmx6000m -DLOG_FILE=/var/log/opentsdb/%p_%i.log -DQUERY_LOG=/var/log/opentsdb/%p_%i_queries.log -XX:+ExitOnOutOfMemoryError -enableassertions -enablesystemassertions&apos;</span><br><span class="line">ExecStart=/usr/bin/tsdb tsd --config /etc/opentsdb/opentsdb.conf --port %i</span><br><span class="line">Restart=always</span><br><span class="line">StandardOutput=journal</span><br></pre></td></tr></table></figure>
<p>直接启动方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nothup bin/tsdb tsd --config /etc/opentsdb/opentsdb.conf &amp;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>安装freeipa</p>
<ul>
<li><p>服务端安装（freeipa服务端不能作为amber agent）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-utils bind bind-dyndb-ldap ipa-server ipa-server-dns</span><br><span class="line">ipa-server-install --setup-dns --allow-zone-overlap</span><br></pre></td></tr></table></figure>
<p>注意：所有的选择yes，注意配置forward dns</p>
<p>配置DNS，<code>/etc/resolv.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">search dhls.com</span><br><span class="line">nameserver 127.0.0.1</span><br><span class="line">nameserver 100.100.2.136</span><br><span class="line">nameserver 100.100.2.138</span><br></pre></td></tr></table></figure>
<p>添加每一台客户端的DNS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kadmin admin</span><br><span class="line">ipa dnsrecord-add dhls.com iot0 --a-rec 172.19.36.14</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipa-client</span><br><span class="line">ipa-client-install</span><br></pre></td></tr></table></figure>
<p>配置DNS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 172.19.36.14 #ipa 服务端地址</span><br><span class="line">nameserver 100.100.2.136</span><br><span class="line">nameserver 100.100.2.138</span><br></pre></td></tr></table></figure>
</li>
<li><p>ambari 安装 kerberos 之前</p>
<p>配置 <code>/etc/krb5.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_ccache_name = FILE:/tmp/krb5cc_%&#123;uid&#125;</span><br></pre></td></tr></table></figure>
<p>设置ipa密码不过期</p>
<p>设置java jce</p>
</li>
<li><p>安装的过程中，不要使用ambari 管理 <code>krb5.conf</code> 文件</p>
</li>
</ul>
</li>
<li><p>Amber 配置 ldap</p>
<ul>
<li><p>使用<code>ambari-server setup-ldap</code> 启动配置，ldap是内外直接使用389端口，不需要使用ssl，外网需要使用636（需要设置证书），bind的用户可以指定具有查看ldap权限的用户即可，如果没有创建直接使用admin用户，可以查看用户信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kinit admin</span><br><span class="line">ipa user-show admin --raw --all</span><br><span class="line">ipa group-show admins --raw --all</span><br></pre></td></tr></table></figure>
</li>
<li><p>导入指定groups的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari-server sync-ldap --groups=ambari.txt</span><br></pre></td></tr></table></figure>
<p><code>ambari.txt</code> 内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写脚本自动导入<code>/etc/ambari-server/script/ambari_sync_ldap.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/expect</span><br><span class="line">spawn /usr/sbin/ambari-server sync-ldap --groups=/etc/ambari-server/script/ambari.txt</span><br><span class="line">expect &quot;Enter Ambari Admin login:&quot;</span><br><span class="line">send &quot;admin\r&quot;</span><br><span class="line">expect &quot;Enter Ambari Admin password:&quot;</span><br><span class="line">send &quot;password\r&quot;</span><br><span class="line">expect eo</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加cron</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/5 * * * * /etc/ambari-server/script/ambari_sync_ldap.sh &gt; /var/log/ambari-server/ambari_sync_ldap.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Knox 配置 ldap</p>
<ul>
<li><p>修改 admin、knox、advanced topology</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;param&gt;</span><br><span class="line">	&lt;name&gt;main.ldapRealm.userDnTemplate&lt;/name&gt;</span><br><span class="line">	&lt;value&gt;uid=&#123;0&#125;,cn=users,cn=accounts,dc=dhls,dc=com&lt;/value&gt;</span><br><span class="line">&lt;/param&gt;</span><br><span class="line">&lt;param&gt;</span><br><span class="line">	&lt;name&gt;main.ldapRealm.contextFactory.url&lt;/name&gt;</span><br><span class="line">	&lt;value&gt;ldap://iot0.dhls.com:389&lt;/value&gt;</span><br><span class="line">&lt;/param&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置knox proxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;service&gt;</span><br><span class="line">	&lt;role&gt;SPARKHISTORYUI&lt;/role&gt;</span><br><span class="line">	&lt;url&gt;http://bd0.dhls.com:18081&lt;/url&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置knox单点登录</p>
<p><code>https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.5/configuring-knox-sso/content/sso_set_up_knox_sso.html</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari-server setup-sso</span><br></pre></td></tr></table></figure>
<p>注意：由于ambari的admin账户无法通过ldap导入进来，所以如果ambari也使用knox单点登录的话，admin账户是无法登录的，所以最好提前建立一个ambari账户，使其有admin管理功能。也可以使用命令关闭knox单点登录。</p>
</li>
</ul>
</li>
<li><p>Ranger 配置ldap</p>
<ul>
<li><p>common configs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LDAP/AD URL = ldap://iot0.dhls.com:389</span><br><span class="line">Bind User = uid=admin,cn=users,cn=accounts,dc=dhls,dc=com</span><br><span class="line">Incremental Sync = true （先不开启，后面再开启）</span><br></pre></td></tr></table></figure>
</li>
<li><p>user configs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Username Attribute = uid</span><br><span class="line">User Object Class = posixaccount</span><br><span class="line">User Search Base = cn=accounts,dc=dhls,dc=com</span><br><span class="line">User Search Scope = sub</span><br><span class="line">User Group Name Attribute = memberof</span><br><span class="line">Group User Map Sync = true</span><br></pre></td></tr></table></figure>
</li>
<li><p>group configs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Group Member Attribute = member</span><br><span class="line">Group Name Attribute = cn</span><br><span class="line">Group Object Class = posixGroup</span><br><span class="line">Group Search Base = cn=groups,cn=accounts,dc=dhls,dc=com</span><br><span class="line">Group Search Filter = (cn=dev)</span><br><span class="line">Enable Group Search First = true</span><br></pre></td></tr></table></figure>
</li>
<li><p>advance config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ldap Base DN = dc=dhls,dc=com</span><br><span class="line">Ldap User DN Pattern = uid=&#123;0&#125;,cn=users,cn=accounts,dc=dhls,dc=com</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/linux-centos-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/linux-centos-install/" itemprop="url">centos7 安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:53:11+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  899
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>journalctl 启动过程中遇到任何问题都可通过这里解决</strong></p>
<ol>
<li><p>安装完成后配置网卡自动启动</p>
<ul>
<li>修改配置文件</li>
</ul>
<p><code>vi /etc/sysconfig/network-scripts/ifcfg-ent33</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ONBOOT=YES</span><br></pre></td></tr></table></figure>
<ul>
<li>重启网卡</li>
</ul>
<p><code>service network restart</code></p>
<ul>
<li>安装网络工具</li>
</ul>
<p><code>yum install net-tools</code></p>
</li>
<li><p>更换阿里云的源</p>
<ul>
<li><p>安装<code>wget</code></p>
<p><code>yum install wget</code></p>
</li>
<li><p>获取阿里云的源</p>
<p><code>wget http://mirrors.aliyun.com/repo/Centos-7.repo</code><br><code>mv CentOS-Base.repo CentOS-Base.repo.bak</code><br><code>mv CentOS-7.repo CentOS-Base.repo</code></p>
</li>
<li><p>更新缓存存并更新</p>
<p><code>yum clean all</code><br><code>yum makecache</code><br><code>yum -y update</code></p>
</li>
</ul>
</li>
</ol>
<ol start="3">
<li><p>设置ssh， <strong>参考ssh使用教程</strong></p>
</li>
<li><p>设置固定ip</p>
<ul>
<li><p>编辑配置文件，添加或修改如下类容</p>
<p><code>vim /etc/sysconfig/network-scripts/ifcfg-eth0</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOTPROTO=&quot;static&quot; #dhcp改为static </span><br><span class="line">ONBOOT=&quot;yes&quot; #开机启用本配置</span><br><span class="line">IPADDR=192.168.7.106 #静态IP</span><br><span class="line">GATEWAY=192.168.7.2 #默认网关</span><br><span class="line">NETMASK=255.255.255.0 #子网掩码</span><br><span class="line">DNS1=192.168.7.2 #DNS 配置</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启网络</p>
<p><code>service network restart</code></p>
<p><strong>注意：</strong> 通常情况下，安装虚拟机后使用NAT网络， 那么主机的地址为192.168.7.1, 虚拟机网关地址 192.168.7.2, 剩下的地址才是虚拟机地址</p>
</li>
<li><p>注意, 不同的网络模式上面的配置方式不是一样的, 上面是NAT模式, 如果是桥接模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOTPROTO=&quot;static&quot;</span><br><span class="line">ONBOOT=&quot;yes&quot;</span><br><span class="line">IPADDR=192.168.0.137</span><br><span class="line">GATEWAY=192.168.0.1</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">DNS1=8.8.8.8</span><br><span class="line">DNS2=114.114.114.114</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>永久更改host name，会反映到 <code>/etc/hostname</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname Linuxidc</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭防火墙</p>
<p><code>systemctl stop firewalld.service</code></p>
<p><code>systemctl disable firewalld.service</code></p>
<p>开放端口</p>
<p><code>firewall-cmd --zone=public --add-port=80/tcp --permanent</code></p>
<p>重新加载防火墙</p>
<p><code>firewall-cmd --reload</code></p>
</li>
<li><p>关闭<code>SELINUX</code></p>
<p><code></code>vim /etc/selinux/config` </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装本地源</p>
<ul>
<li><p>挂载U盘</p>
<p><code>mount -t vfat /dev/sdc4 /mnt/Centos7</code></p>
</li>
<li><p>步骤参考 </p>
</li>
</ul>
<p>  [u盘挂载]: <a href="https://blog.csdn.net/leshami/article/details/78133716" target="_blank" rel="noopener">https://blog.csdn.net/leshami/article/details/78133716</a></p>
</li>
<li><p>安装无线网卡参考</p>
</li>
</ol>
<ol start="9">
<li><p>设置开机启动 <code>/etc/init.d/</code>中添加可执行脚本, 开头可以参考这个目录下其它的脚本, 如： 添加 <code>sslocal</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line"># sshd          Start up the OpenSSH server daemon</span><br><span class="line">#</span><br><span class="line"># chkconfig: 2345 55 25</span><br><span class="line"># description: sslcal shadowsocks</span><br><span class="line">/usr/bin/sslocal -c /etc/shadowsocks.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加到启动服务当中 </p>
<p><code>chkconfig sslocal on</code></p>
</li>
<li><p>添加交换分区</p>
<ol>
<li>添加swap分区<br><code>dd if=/dev/zero of=/var/swapfile bs=1024 count=4096k</code></li>
<li>执行完毕，对交换文件格式化并转换为swap分区：<br><code>mkswap /var/swapfile</code></li>
<li>挂载并激活分区：<br><code>swapon /var/swapfile</code></li>
<li>赋权限<br><code>chmod -R 0600 /var/swapfile</code></li>
<li>设置开机自动挂载该分区：<br>在文件<code>/etc/fstab</code>文件末尾追加如下内容后<br><code>/var/swapfile swap swap defaults 0 0</code></li>
</ol>
</li>
<li><p>安装vmware</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update</span><br><span class="line">sudo yum upgrade</span><br><span class="line">sudo yum install &quot;kernel-devel-uname-r == $(uname -r)&quot; gcc</span><br><span class="line">sudo sh ./VMware-Workstation-Full-14.1.1-7528167.x86_64.bundle</span><br></pre></td></tr></table></figure>
<p><strong>注意: </strong> 如何kernel headers 或者 kernel devel 找不到, 通常情况下是因为kernel的版本与 headers或者devel不同, 所以需要将版本安装成统一的.</p>
</li>
<li><p>挂载ntfs磁盘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install ntfs-3g fuse</span><br><span class="line">yum -y install ntfsprogs</span><br></pre></td></tr></table></figure>
</li>
<li><p>防止敏感信息泄漏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /dev/null .bash_history</span><br><span class="line">ln -s /dev/null .mysql_history</span><br></pre></td></tr></table></figure>
</li>
<li><p>时间同步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 安装ntp</span><br><span class="line">yum install ntp -y &amp;&amp; \</span><br><span class="line">systemctl enable ntpd.service &amp;&amp; \</span><br><span class="line">systemctl start ntpd.service</span><br><span class="line"></span><br><span class="line">#设置时区</span><br><span class="line">timedatectl set-timezone Asia/Shanghai &amp;&amp; \</span><br><span class="line">timedatectl set-ntp yes &amp;&amp; \</span><br></pre></td></tr></table></figure>
</li>
<li><p>yum自动更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum -y update  # 首先更新一次</span><br><span class="line">yum -y install yum-cron</span><br><span class="line"># /etc/cron.daily/0yum-daily.cron   </span><br><span class="line"># anacron 每天执行0yum-daily.cron一次</span><br><span class="line"># 它根据 /etc/yum/yum-cron.conf 来更新软件</span><br><span class="line">vim /etc/yum/yum-cron.conf</span><br><span class="line">update_messages = yes,</span><br><span class="line">download_updates = yes,</span><br><span class="line">apply_updates = yes  # 自动安装</span><br><span class="line"></span><br><span class="line"># 最后重启  crond   yum-cron</span><br><span class="line">systemctl start crond</span><br><span class="line">systemctl start yum-cron</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/linux-wifi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/linux-wifi/" itemprop="url">linux wifi配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:44:10+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  192
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>首先下载iw工具。</p>
<p>yum -y install iw</p>
</li>
<li><p>获取无线网卡的名称</p>
<p>执行iw dev，假设获得名称为 wlp3s0（示例）</p>
</li>
<li><p>激活无线网络接口</p>
<p>执行ip link set wlp3s0 up</p>
</li>
<li><p>扫描当前环境中的无线网络</p>
<p>执行iw wlp3s0 scan|grep SSID，假设你能够连接的网络名称是TP-LINK-1（示例）</p>
</li>
<li><p>登录指定网络</p>
<p>执行wpa_supplicant -B -i wlp3s0 -c &lt;(wpa_passphrase “TP-LINK-1” “此网络的密码”)</p>
</li>
<li><p>主动请求动态地址</p>
<p>dhclient wlp3s0</p>
</li>
<li><p>查看获取的网络地址</p>
<p>执行ip addr show wlp3s0</p>
</li>
<li><p>设置自动启动</p>
<ul>
<li><p>设置NetworkManager自动启动</p>
<p>chkconfig NetworkManager on</p>
</li>
<li><p>安装NetworkManager-wifi</p>
<p>yum -y install NetworkManager-wifi </p>
</li>
<li><p>开启WiFi </p>
<p>nmcli r wifi on</p>
</li>
<li><p>测试（扫描信号）</p>
<p>nmcli dev wifi</p>
</li>
<li><p>连接 </p>
<p>nmcli dev wifi connect wifi_name password wifi_password</p>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/live-photo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/live-photo/" itemprop="url">摄影</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:32:42+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/live/" itemprop="url" rel="index">
                    <span itemprop="name">live</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  594
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>摄影的三要素</p>
<ul>
<li><p>曝光： 光线通过光圈到照片中接受的多少。</p>
</li>
<li><p>审美： 照片通过各种元素给人的视觉不同的冲击力。</p>
</li>
<li><p>其它： 照片体现的各种主题、人文等等。</p>
</li>
</ul>
</li>
<li><p>曝光的三要素：</p>
<ul>
<li><p>光圈： 小孔成像中小孔的描述， 光圈也存在大小。</p>
</li>
<li><p>快门： 光线通过小孔传递到照片， 通过一个开关控制光圈打开的时间。</p>
</li>
<li><p>ISO：由于场景中光线的强度有限， 如果通过大光圈慢快门还是无法达到我们想要的效果，那么通常需要调大ISO， 从而使得照片增加曝光。ISO也叫感光度， 如果ISO增大那么照片的曝光也会增大， 但是同样带来了另外一个问题， 噪音也会变大，所以通常情况下光线良好的都是低ISO。</p>
</li>
</ul>
</li>
<li><p>景深的三要素：</p>
<p>景深定义：对于定焦物体后面的景色清晰程度， 也就是焦点后面物体多远的保持清晰</p>
<ul>
<li><p>光圈：通过小孔成像的原理我们知道， 小孔越大照片越模糊， 小孔越小照片越清晰， 所以通常情况下拍摄人物会选择大光圈， 而拍摄景色使用小光圈， 这样也会使得人物定焦后， 人物清晰而人物后面的景色比较朦胧， 而景色整个的都比较清晰。</p>
</li>
<li><p>焦距：当拍摄时的光圈大小不变，被摄体的位置也不改变时，使用的镜头焦距越短，景深就越大;镜头的焦距越长，景深就越小。也就是在光圈不变的条件下，使用广角镜头时，景深的清晰范围就要相对大一些，使用中、长焦距镜头时，景深的清晰范围就相对要小得多。</p>
</li>
<li><p>焦点与相机的距离：而当拍摄时的光圈大小不变，所使用的镜头焦距也不改变时，被摄体越远，画面中的前后清晰范围就越大；反之，被摄体越近，前后的清晰范围也就相对越小。这就提醒我们，在拍摄一些特定和近景的画面时，调焦应该特别仔细，稍有疏忽，使主体景物越出景深范围，整个画面就都虚了。</p>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/mysql-profile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/mysql-profile/" itemprop="url">mysql性能解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:00:05+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  495
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>profiling使用： 性能剖析一般分为两步， 测量任务所花费的时间， 然后对结果进行统计和排序。</p>
</li>
<li><p>New Relic, xhprof</p>
</li>
<li><p>可以通过设置long_query_time为0来捕获所有的查询</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log = on</span><br><span class="line">slow_query_log_file = /var/log/mysql/mysql-slow.log</span><br><span class="line">long_query_time = 0</span><br><span class="line">#set global slow_query_log=on;通常情况下，服务器可以通过随时打开来进行开启慢查询</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>pt-query-digest, mysqldumpslow等等来分析满查询</p>
</li>
<li><p>性能剖析步骤：</p>
<ol>
<li><p>使用慢查询， 直接开启慢查询或者使用pt-query-digest获取(show full processlist实现)或者直接使用tcpdump将网络包数据保存到磁盘， 然后使用pt-query-digest –type=tcpdump来进行解析并分析查询</p>
</li>
<li><p>使用pt-query-digest来分析慢查询日志， 并分析出结果</p>
</li>
<li><p>使用explain分析执行的语句</p>
</li>
<li><p>使用profiling来分析单条语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set profiling=1</span><br><span class="line">select * </span><br><span class="line">show profiles</span><br><span class="line">show profile for query n</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>通常使用show status、show processlist和show innodb status开销是非常低的</p>
</li>
<li><p>通过show profile for query n来获取到查询主要的耗时在哪个地方， 如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copying to temp table		0.090623</span><br><span class="line">Sorting result				0.011555</span><br><span class="line">Sending result				0.045931</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>可以看到此处最大的消耗是在临时表中， 所有此时我们考虑的是如何去掉临时表， 但经常可能会误导我们的是结果排序， 它占比非常低， 而我们如果简单通过查询语句很容易掉入到这个陷阱当中， 所以一般原则是”不建议优化排序缓冲区”。</p>
</li>
<li><p>show status通常是一个很有用的工具， 但是它不是一款剖析工具， show status大多都是一个计数器。</p>
</li>
<li><p>mysql在5.6.6中正是加入了performance_schema数据库（它的存储引擎也是performace_schema, 内存式数据引擎）， 用来记录系统中需要记录的性能相关的数据， 并且是默认开启的</p>
</li>
</ol>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/mysql-partitions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/mysql-partitions/" itemprop="url">mysql自动分区</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T19:44:59+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  899
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>修改已经存在的表为其添加分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> </span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">to_days</span>(<span class="keyword">time</span>)) (</span><br><span class="line"><span class="keyword">PARTITION</span> p201811 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2018-12-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201812 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-01-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201901 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-02-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201902 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-03-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201903 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-04-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201904 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-05-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201905 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-06-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201906 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-07-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201907 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-08-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201908 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-09-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201909 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-10-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201910 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-11-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201911 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2019-12-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p201912 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-01-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> pmax <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (MAXVALUE))</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>添加分区和差分分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> pmax;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> <span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (<span class="keyword">PARTITION</span> p202001 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-02-01'</span>)));</span><br></pre></td></tr></table></figure>
<p><strong>注意 :</strong> 由于分区表通常会带有一个最大的分区用来控制忘记添加分区， 所以我们添加分区的时候一定要知道最大分区中是否存在数据， 如果存在那么必须先修改最大分区， 所以通常情况下我们不会使用上面的语句进行添加分区， 而是使用Reorganize关键字， 并且Reorganize关键字不会导致数据丢失</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> reorganize <span class="keyword">partition</span> pmax <span class="keyword">into</span>(</span><br><span class="line"><span class="keyword">PARTITION</span> p202001 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-02-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> p202002 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="keyword">to_days</span>(<span class="string">'2020-03-01'</span>)), </span><br><span class="line"><span class="keyword">PARTITION</span> pmax <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (MAXVALUE));</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改多个分区，在into关键字之前或之后都指定多个分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> reorganize <span class="keyword">partition</span> p201901, p201902 ... p201912 <span class="keyword">into</span>(<span class="keyword">Partition</span> p2019 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="keyword">to_days</span>(<span class="string">'2020-01-01'</span>)));</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>修改整个表的分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`device_model_report_copy1`</span> reorganize <span class="keyword">partition</span> <span class="keyword">into</span>(</span><br><span class="line"><span class="keyword">Partition</span> p2019 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="keyword">to_days</span>(<span class="string">'2020-01-01'</span>))，</span><br><span class="line"><span class="keyword">Partition</span> p2020 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="keyword">to_days</span>(<span class="string">'2021-01-01'</span>))，</span><br><span class="line"><span class="keyword">Partition</span> pmax <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(MAXVALUE));</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>子分区</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders_range(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">customer_surname <span class="built_in">varchar</span>(<span class="number">30</span>),</span><br><span class="line">store_id <span class="built_in">int</span>,</span><br><span class="line">salesperson_id <span class="built_in">int</span>,</span><br><span class="line">order_Date <span class="built_in">date</span>,</span><br><span class="line">note <span class="built_in">varchar</span>(<span class="number">500</span>)</span><br><span class="line">) <span class="keyword">engine</span>=myisam  <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">range</span>(<span class="keyword">id</span>) </span><br><span class="line"><span class="keyword">subpartition</span> <span class="keyword">by</span> <span class="keyword">hash</span>(store_id) <span class="keyword">subpartitions</span> <span class="number">2</span>(</span><br><span class="line"><span class="keyword">partition</span> p0 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="number">5</span>),</span><br><span class="line"><span class="keyword">partition</span> p1 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="number">10</span>),</span><br><span class="line"><span class="keyword">partition</span> p3 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span>(<span class="number">15</span>));</span><br></pre></td></tr></table></figure>
<p><strong>注意 : </strong>只允许对range和list类型的分区再进行分区，子分区的类型只允许是hash或key.</p>
<ol start="6">
<li>查看分区信息</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  partition_name part,  </span><br><span class="line">  partition_expression expr,  </span><br><span class="line">  partition_description <span class="keyword">descr</span>,  </span><br><span class="line">  table_rows,</span><br><span class="line">  data_length/<span class="number">1024</span>/<span class="number">1024</span></span><br><span class="line"><span class="keyword">from</span> information_schema.partitions  <span class="keyword">where</span> </span><br><span class="line">  table_schema = <span class="keyword">schema</span>()  </span><br><span class="line">  <span class="keyword">and</span> table_name=<span class="string">'device_model_report'</span>;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>创建分区存储过程</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> <span class="keyword">if</span> <span class="keyword">exists</span> p_time_range_partition_add;</span><br><span class="line">DELIMITER // </span><br><span class="line"><span class="keyword">CREATE</span> DEFINER=<span class="string">`root`</span>@<span class="string">`%`</span> <span class="keyword">PROCEDURE</span> <span class="string">`p_time_range_partition_add`</span>(<span class="keyword">IN</span> <span class="string">`sch_name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>),<span class="keyword">IN</span> <span class="string">`tab_name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>),<span class="keyword">IN</span> <span class="string">`patition_date`</span> <span class="built_in">date</span>)</span><br><span class="line">b_lable:<span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">declare</span> pmax_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="string">"pmax"</span>; <span class="comment">-- max patition name must be pmax</span></span><br><span class="line"><span class="keyword">declare</span> p_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="keyword">concat</span>(<span class="string">'p'</span>, <span class="keyword">date_format</span>(patition_date,<span class="string">'%Y%m'</span>));</span><br><span class="line"><span class="keyword">declare</span> p_time <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="keyword">concat</span>(<span class="keyword">date_format</span>(<span class="keyword">date_add</span>(patition_date,<span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">month</span>),<span class="string">'%Y-%m'</span>), <span class="string">'-01'</span>);</span><br><span class="line"><span class="keyword">declare</span> pmax_table_rows <span class="built_in">integer</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- check param</span></span><br><span class="line">if (<span class="keyword">SELECT</span> table_name <span class="keyword">FROM</span> information_schema.TABLES <span class="keyword">WHERE</span> table_schema = sch_name <span class="keyword">and</span> table_name = tab_name) <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span></span><br><span class="line">	leave b_lable;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test pmax</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	table_rows <span class="keyword">into</span> pmax_table_rows </span><br><span class="line"><span class="keyword">from</span> information_schema.partitions <span class="keyword">where</span> </span><br><span class="line">	table_schema = sch_name <span class="keyword">and</span> </span><br><span class="line">	table_name = tab_name <span class="keyword">and</span> </span><br><span class="line">	partition_name = pmax_name;</span><br><span class="line">if pmax_table_rows &gt; 0 then</span><br><span class="line">	leave b_lable; <span class="comment">-- need to manual alter</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test exist pname</span></span><br><span class="line">if (<span class="keyword">select</span> partition_name <span class="keyword">from</span> information_schema.partitions <span class="keyword">where</span> table_schema = sch_name <span class="keyword">and</span> table_name = tab_name <span class="keyword">and</span> partition_name = p_name) = p_name <span class="keyword">then</span></span><br><span class="line">	leave b_lable;	<span class="comment">-- has patition</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- add patition</span></span><br><span class="line"><span class="keyword">set</span> @p_ps=<span class="keyword">concat</span>(<span class="string">"ALTER TABLE "</span>, tab_name, <span class="string">" reorganize partition pmax into(PARTITION "</span>, p_name, <span class="string">" VALUES LESS THAN (to_days('"</span>, p_time, <span class="string">"')), PARTITION pmax VALUES LESS THAN (MAXVALUE));"</span>);</span><br><span class="line"><span class="keyword">prepare</span> stm <span class="keyword">from</span> @p_ps;</span><br><span class="line"><span class="keyword">execute</span> stm;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">//</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>设置事件</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置开启(数据库默认是关闭的，这个需要在my.cnf中设置下，否则数据库重启后会自动关闭)</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> event_scheduler = <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 查看任务调度启动状态</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">VARIABLES</span> <span class="keyword">like</span> <span class="string">'event_scheduler'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建任务调度</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">event</span> event_p_time_range_partition_add</span><br><span class="line"><span class="keyword">on</span> schedule every <span class="number">1</span> <span class="keyword">month</span> starts <span class="keyword">sysdate</span>()</span><br><span class="line"><span class="keyword">on</span> completion <span class="keyword">preserve</span></span><br><span class="line"><span class="keyword">enable</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">call</span> p_time_range_partition_add(<span class="string">'test'</span>, <span class="string">'device_model_report'</span>,<span class="keyword">date_add</span>(<span class="keyword">curdate</span>(),<span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">month</span>));</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/26/linux-terminal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ilivoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my-icon.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ilivoo`s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/26/linux-terminal/" itemprop="url">终端使用技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-26T16:09:09+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  553
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="操作系统启动顺序"><a href="#操作系统启动顺序" class="headerlink" title="操作系统启动顺序"></a>操作系统启动顺序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">引导程序</span><br><span class="line">init进程(初始化操作系统 fork exec)</span><br><span class="line">login进程(用于校验用户信息, 并执行exec)</span><br><span class="line">bash进程(解释用户输入,并执行fork和exec)</span><br><span class="line">用户进程, 整个启动顺序</span><br></pre></td></tr></table></figure>
<h4 id="进程基本操作"><a href="#进程基本操作" class="headerlink" title="进程基本操作"></a>进程基本操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nohup 用来接管程序运行，不会挂起程序并接管控制台输出到文件中</span><br><span class="line">command &amp;   //将进程放在后台执行 </span><br><span class="line">ctrl-z      //暂停当前进程 并放入后台, 放入后台后可以直接使用bg转换成后台执行 </span><br><span class="line">jobs        //查看当前后台任务</span><br><span class="line">bg          //将任务转为后台执行 </span><br><span class="line">fg          //将任务调回前台 </span><br><span class="line">kill        //杀掉任</span><br></pre></td></tr></table></figure>
<h4 id="进程输入输出重定向"><a href="#进程输入输出重定向" class="headerlink" title="进程输入输出重定向"></a>进程输入输出重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">重定向（在终端下如果，没有指明标准输入、标准输出、标准错误， 那么默认都是屏幕）</span><br><span class="line">标准输入 0， 标准输出 1， 标准错误 2， &gt; 替换， &gt;&gt; 追加</span><br><span class="line">&lt; 		将标准输入更改为某个文件</span><br><span class="line">&gt; 		默认将标准输入重定向， 和 1&gt; 完全等价</span><br><span class="line">2&gt; 		将标准错误重定向</span><br><span class="line">&amp; 		表示获取到某种类型管道（如果没有数字表示获取所有管道）， 如 &amp;1表示获取到标准输出</span><br><span class="line">tee 	多重输出</span><br><span class="line">如：command &gt; log.out 2&gt;&amp;1 &lt; /dev/null &amp;， 将标准输出重定向到我文件（此时标准输出1就是文件log.out）,  把标准错误重定向到标准输出中(最终也是文件中), 标准输入使用 /dev/null 文件， 并后台启动</span><br></pre></td></tr></table></figure>
<h4 id="！使用技巧"><a href="#！使用技巧" class="headerlink" title="！使用技巧"></a>！使用技巧</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">!!  上一个命令， 在缺少sudo的时候是非常有用的， sudo !!</span><br><span class="line">!n  运行历史的第n条命令</span><br><span class="line">!-n 运行历史的倒数第n条命令</span><br><span class="line">!*  使用上一个命令的所有参数： touch hello world,  rm -rf !*  删除刚才创建的两个文件</span><br><span class="line">!^  使用上一个命令的地一个参数: touch hello world, rm -rf !^ 删除hello文件</span><br><span class="line">!$ 使用上一个命令的最后一个参数 :  touch hello world,  rm -rf !$ 删除world文件</span><br><span class="line">!:-  使用上一个命令的除了最后一个参数所有的参数，包括命令:  touch hello world</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    <div>
        
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my-icon.jpeg"
                alt="ilivoo" />
            
              <p class="site-author-name" itemprop="name">ilivoo</p>
              <p class="site-description motion-element" itemprop="description">我，在這裡，享受等你的時光。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ilivoo</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/lib/clipboard/clipboard.js"></script>
<script type="text/javascript" src="/js/src/custom.js"></script>

</body>
</html>
